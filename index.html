<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <title>Konfigurator krzeseÅ‚ - Fajne KrzesÅ‚a</title>
  <link rel="icon" href="icons/favicon.png" type="image/jpeg" />
  <meta http-equiv="cache-control" content="no-cache" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script>
    // ğŸ“± GLOBALNE DETEKCJA URZÄ„DZENIA (bez przekierowania)
    (function() {
      window.isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      window.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      window.isAndroid = /Android/i.test(navigator.userAgent);
      window.screenWidth = window.screen.width;
      window.isSmallScreen = window.screenWidth <= 768;
      
      console.log('ğŸ” Device detection:', {
        userAgent: navigator.userAgent,
        isMobile: window.isMobile,
        isIOS: window.isIOS,
        isAndroid: window.isAndroid,
        screenWidth: window.screenWidth,
        isSmallScreen: window.isSmallScreen
      });
      
      // Dodaj klasy CSS do body
      if (window.isMobile) document.body.classList.add('mobile-device');
      if (window.isIOS) document.body.classList.add('ios-device');
      if (window.isAndroid) document.body.classList.add('android-device');
      if (window.isSmallScreen) document.body.classList.add('small-screen');
      
      console.log('ï¿½ Uruchamiam index.html dla wszystkich urzÄ…dzeÅ„');
    })();
  </script>

  <script type="importmap">
{
  "imports": {
    "threepipe": "https://unpkg.com/threepipe@latest/dist/index.mjs",
    "@threepipe/webgi-plugins": "https://unpkg.com/@threepipe/webgi-plugins@latest/dist/index.mjs",
    "three": "https://unpkg.com/three@0.157.0/build/three.module.js"
    

    
  }
}
</script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
    }

    #app {
      display: flex;
      flex-direction: row; /* ğŸ”§ Wracamy do normalnego flex */
      height: 100vh;
      width: 100vw;
      position: relative;
      visibility: hidden;
    }

    #app.visible {
  visibility: visible;
  opacity: 1;
}

    #canvas {
      flex: 1 1 0;
      width: calc(100vw - 460px); /* ğŸ”§ UwzglÄ™dnij szerokoÅ›Ä‡ sidebara na desktop */
      height: 100%;
      display: none; /* ğŸš« Ukryj 3D na start */
      background: #ededed15;
      outline: none;
      cursor: grab;
      margin-right: 460px; /* ğŸ”§ Zostaw miejsce na sidebar */
    }
    
    #canvas:active {
      cursor: grabbing;
    }
    
    #canvas.visible {
      display: block; /* âœ… PokaÅ¼ po wyborze krzesÅ‚a */
    }
    
    /* ğŸ¯ EKRAN STARTOWY - WYBIERZ KRZESÅO */
    #welcome-screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 460px; /* ğŸ”§ PrzywrÃ³cone na desktop */
      height: 100%;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 50; /* ğŸ”§ NiÅ¼szy z-index niÅ¼ loader, ale wyÅ¼szy niÅ¼ canvas */
      transition: opacity 0.5s ease;
    }
    
    #welcome-screen.hidden {
      opacity: 0;
      pointer-events: none;
      display: none;
    }
    
    #welcome-screen h1 {
      font-size: 2em; /* ğŸ”§ Zmniejszony z 2.5em - porÃ³wnywalny do logo */
      color: #333;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 300;
    }
    
    #welcome-screen p {
      font-size: 1.2em;
      color: #666;
      text-align: center;
      margin-bottom: 40px;
      max-width: 400px;
      line-height: 1.6;
    }
    
      #welcome-logo {
        width: 200px; /* ğŸ”§ WiÄ™ksze logo - z 150px na 200px */
        height: auto;
        margin-bottom: 30px;
        opacity: 0.9;
      }
      
      /* ğŸ“± RESPONSIVE WELCOME SCREEN */
      @media (max-width: 768px) {
        #welcome-screen {
          right: 140px !important; /* ğŸ”§ Dopasuj do jeszcze mniejszego sidebar */
          z-index: 60 !important; /* ğŸ”§ WyÅ¼szy z-index niÅ¼ sidebar na mobile */
        }
        
        #welcome-screen h1 {
          font-size: 1.4em; /* ğŸ”§ Mniejszy tytuÅ‚ na mobile */
          margin-bottom: 8px;
        }
        
        #welcome-screen p {
          font-size: 0.8em;
          margin-bottom: 15px;
          padding: 0 8px;
        }
        
        #welcome-logo {
          width: 100px; /* ğŸ”§ WiÄ™ksze logo na mobile - z 60px na 100px */
          margin-bottom: 15px;
        }
        
        /* ğŸŒ™ Dark mode logo na mobile */
        body.dark-mode #welcome-logo {
          padding: 3px;
        }
        
        #theme-toggle {
          position: fixed;
          bottom: 15px;
          left: 15px;
          width: 40px;
          height: 40px;
          font-size: 14px;
          z-index: 9999 !important; /* ğŸ”§ NajwyÅ¼szy z-index */
        }
      }    body {
      background: #ededed80;
      /* przezroczyste tÅ‚o, lepszy blur */
    }
    
    /* ğŸŒ™ DARK MODE / LIGHT MODE */
    body.dark-mode {
      background: #1a1a1a;
      color: #e0e0e0; /* ğŸ”§ JaÅ›niejsza czcionka */
    }
    
    body.dark-mode #sidebar {
      background: #2d2d2d !important;
      color: #e0e0e0; /* ğŸ”§ JaÅ›niejsza czcionka */
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.5);
    }
    
    body.dark-mode #sidebar h3 {
      color: #ffffff; /* ğŸ”§ BiaÅ‚e nagÅ‚Ã³wki */
    }
    
    body.dark-mode #config-overview {
      background: #2d2d2d;
      color: #e0e0e0; /* ğŸ”§ JaÅ›niejsza czcionka */
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.5);
    }
    
    body.dark-mode #welcome-screen {
      background: #1a1a1a;
      color: #ffffff;
    }
    
    /* ğŸ”§ LOGO DARK MODE - dodaj ciemne tÅ‚o */
    body.dark-mode #welcome-logo {
      background: #2d2d2d;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    body.dark-mode #bottom-toolbar {
      background: #2d2d2d;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }
    
    body.dark-mode .thumbnail {
      background: #3d3d3d;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    body.dark-mode .thumbnail:hover {
      background: #4d4d4d;
    }
    
    body.dark-mode .thumbnail-caption {
      color: #e0e0e0; /* ğŸ”§ JaÅ›niejsze napisy pod obrazkami */
    }
    
    /* ğŸ”„ TOGGLE BUTTON - ZAWSZE W DOLNYM ROGU */
    #theme-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #ddd;
      cursor: pointer;
      z-index: 9999; /* ğŸ”§ NajwyÅ¼szy z-index */
      z-index: 1002; /* ğŸ”§ WyÅ¼szy z-index niÅ¼ sidebar */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      color: #333; /* ğŸ”§ Czarna ikona w light mode */
    }
    
    #theme-toggle:hover {
      transform: scale(1.1);
    }
    
    body.dark-mode #theme-toggle {
      background: #2d2d2d;
      border-color: #555;
      color: #fff; /* ğŸ”§ BiaÅ‚a ikona w dark mode */
    }

    /* Panele UI: identyczna przezroczystoÅ›Ä‡ i blur obu paneli */
    #sidebar {
      background: #fff !important;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.10);
      border: 1px solid rgba(0, 0, 0, 0.08);
      width: 460px; /* ğŸ”§ PrzywrÃ³cone na desktop */
      min-width: 460px;
      max-width: 460px;
      padding: 32px 24px 24px 24px; /* ğŸ”§ PrzywrÃ³cony padding na desktop */
      z-index: 40; /* ğŸ”§ NiÅ¼szy z-index niÅ¼ welcome screen (50) */
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow-y: auto;
      position: fixed; /* ğŸ”§ Fixed position */
      right: 0; /* ğŸ”§ Zawsze po prawej stronie */
      top: 0; /* ğŸ”§ Od gÃ³ry */
      /* Sidebar zawsze widoczny - Å¼eby moÅ¼na byÅ‚o wybieraÄ‡ krzesÅ‚a */
    }
    
    #config-overview {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.10);
      border: 1px solid rgba(0, 0, 0, 0.08);
      display: none; /* ğŸš« Ukryj tylko panel podsumowania na start */
    }
    
    #config-overview.visible {
      display: block; /* âœ… PokaÅ¼ po wyborze krzesÅ‚a */
    }

    #sidebar-content {
      flex-grow: 1;
      overflow-y: auto;
    }



    #config-overview {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 300px;
      padding: 12px 16px;
      /* Zmniejszone padding */
      z-index: 20;
      font-size: 15px;
      max-height: 1000px;
      opacity: 1;
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      overflow: hidden;
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.10);
      border-radius: 16px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: #fff;
      box-sizing: border-box;
    }

    #config-overview.collapsed {
      max-height: 40px;
      /* Zmniejszone z 60px */
      opacity: 0.8;
      padding: 8px 16px;
      /* Zmniejszone padding w stanie zwiniÄ™tym */
    }



    #config-overview:hover {
      opacity: 1;
    }

    .overview-content {
      max-height: 1000px;
      opacity: 1;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }

    #config-overview.collapsed .overview-content {
      max-height: 0;
      opacity: 0;
    }





    hr {
      border: none;
      border-top: 1px solid #eee;
      margin: 16px 0 12px;
    }

    .selection-section h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #555;
    }

    .options-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px; /* ğŸ”§ PrzywrÃ³cone na desktop */
      justify-content: flex-start; /* ğŸ”§ WyrÃ³wnaj do lewej */
    }

    .thumbnail-wrapper {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      /* ğŸ”§ Bez szerokoÅ›ci na desktop - naturalny flex wrap */
    }

    .thumbnail {
      width: 80px; /* ğŸ”§ PrzywrÃ³cone na desktop */
      height: 80px;
      object-fit: contain;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: all 0.2s;
      background-color: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px;
      box-sizing: border-box;
      opacity: 1;
    }

    .thumbnail:hover {
      transform: scale(1.05);
      border-color: #444;
    }

    .thumbnail.selected {
      outline: 2px solid #050505;
      border: 2px solid transparent;
      outline-offset: -2px;
      box-shadow: 0 0 8px rgba(49, 49, 49, 0.5);
    }

    .thumbnail img {
      max-width: 90%;
      max-height: 90%;
      opacity: 1;
    }

    .thumbnail-caption {
      font-size: 15px; /* ğŸ”§ PrzywrÃ³cone na desktop */
      color: #555;
      margin-top: 6px; /* ğŸ”§ PrzywrÃ³cone na desktop */
      font-weight: 500;
      opacity: 1;
      line-height: 1.2; /* ğŸ”§ ÅšciÅ›lejsze linie */
    }

    #overview-icons img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      border: 1px solid #ddd;
      object-fit: contain;
      opacity: 1;
    }

    #config-overview h4 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 18px;
    }

    #overview-details .detail-item {
      font-size: 16px;
      margin: 8px 0;
    }

    #overview-total-price {
      font-size: 22px;
    }

    #overview-icons {
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 20px;
    }

    #summary {
      margin-top: auto;
      padding-top: 15px;
      border-top: 1px solid #ffffff;
    }

    #back-to-models-container {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
      justify-content: flex-start;
    }

    .back-to-model-btn {
      position: relative;
      width: 80px;
      height: 80px;
      border: 1.5px solid #bbb;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-right: 10px;
      transition: box-shadow 0.2s;
    }

    .back-to-model-btn:hover {
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
    }

    .back-to-model-btn img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      display: block;
    }

    .back-to-model-btn .close-x {
      position: absolute;
      top: 4px;
      right: 6px;
      background: #fff;
      border: none;
      font-size: 20px;
      color: #333;
      cursor: pointer;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      line-height: 20px;
      padding: 0;
      box-shadow: 0 1px 4px #0001;
      transition: background 0.2s;
    }

    .back-to-model-btn .close-x:hover {
      background: #eee;
    }

    #camera-debug-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: #fff;
      border: 1px solid #ccc;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0002;
    }

    #camera-debug-panel label {
      display: block;
      margin: 8px 0 4px;
      font-size: 14px;
    }

    #camera-debug-panel input {
      width: 100%;
      margin-bottom: 8px;
    }

    #camera-debug-panel button {
      width: 100%;
      padding: 8px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #camera-debug-panel button:hover {
      background: #0056b3;
    }

    body {
      background: #ededed;
      /* lub TwÃ³j kolor tÅ‚a */
    }

    #buy-button {
      width: 100%;
      padding: 14px 0;
      background: #111;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      margin-top: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #buy-button:hover {
      background: #333;
    }

    #buy-button .cart-icon {
      width: 22px;
      height: 22px;
      display: inline-block;
    }

    #sidebar .model-image {
      width: 100%;
      max-width: 100%;
      height: 110px;
      object-fit: contain;
      display: block;
      margin: 0 auto 10px auto;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #eee;
    }

    #model-image-container img {
      width: 100%;
      max-width: 100%;
      height: 220px; /* ğŸ”§ PrzywrÃ³cone na desktop */
      object-fit: contain;
      display: block;
      margin: 0 auto 18px auto; /* ğŸ”§ PrzywrÃ³cone marginesy */
      background: #fff;
      border-radius: 16px; /* ğŸ”§ PrzywrÃ³cone zaokrÄ…glenie */
      border: 1.5px solid #ddd;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); /* ğŸ”§ PrzywrÃ³cony cieÅ„ */
      padding: 12px 0; /* ğŸ”§ PrzywrÃ³cony padding */
      transition: box-shadow 0.2s;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      background: #fff;
      padding: 24px 28px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #222;
    }


    .close-button {
      position: absolute;
      top: 12px;
      right: 16px;
      cursor: pointer;
      font-size: 26px;
      font-weight: 700;
      color: #888;
      transition: color 0.2s ease;
    }

    .close-button:hover {
      color: #444;
    }

    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 16px;
      font-weight: 700;
      font-size: 20px;
      text-align: center;
    }

    .modal-content label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 14px;
    }

    .modal-content input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 18px;
      border: 1.5px solid #ddd;
      border-radius: 12px;
      font-size: 15px;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    .modal-content input:focus {
      border-color: #888;
      outline: none;
    }

    .modal-content button[type="submit"] {
      width: 100%;
      background: #000;
      color: #fff;
      font-weight: 700;
      font-size: 16px;
      padding: 12px 0;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .modal-content button[type="submit"]:hover {
      background: #333;
    }

    /* Komunikat sukcesu */
    #success-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-100%, -50%);

      background: #ffffff;
      /* jasne zielone tÅ‚o */
      border: 1.5px solid #1f1f1f;
      /* zielona ramka, spÃ³jna z tÅ‚em */
      color: #000000;
      /* ciemnozielony tekst */

      font-weight: 700;
      font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;

      padding: 20px 28px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(3, 3, 3, 0.15);

      max-width: 320px;
      width: 90%;
      text-align: center;
      z-index: 9999;
    }


    /* Ukrywanie i pokazywanie */
    .hidden {
      display: none;
    }

    .visible {
      display: block;
    }


    #bottom-toolbar {
      display: none !important; /* ğŸš« CAÅKOWICIE USUNIÄ˜TY */
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }


    #bottom-toolbar button {
      background: #f0f0f0;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    #bottom-toolbar.visible {
      display: flex; /* âœ… PokaÅ¼ toolbar po wyborze krzesÅ‚a */
      opacity: 1;
    }

    #bottom-toolbar button:hover {
      background: #e0e0e0;
    }

    #dimension-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    .dimension-line {
      position: absolute;
      background-color: #000;
      height: 2px;
    }

    .axis-line {
      position: absolute;
      height: 2px;
      background-color: #222;
      opacity: 0.6;
    }

    .axis-line.x {
      top: 50%;
      left: 0;
      width: 100%;
      transform: translateY(-50%);
    }

    .axis-line.y {
      left: 50%;
      top: 0;
      width: 2px;
      height: 100%;
      transform: translateX(-50%);
    }

    .axis-line.z {
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 2px dashed #888;
      box-sizing: border-box;
      border-radius: 10px;
    }

    .dimension-label {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 5px;
      border-radius: 3px;
      font-size: 14px;
      font-weight: bold;
    }

    .dimension-label:nth-child(4) {
      top: 20px;
    }

    .dimension-label:nth-child(5) {
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .dimension-label:nth-child(6) {
      bottom: 20px;
    }


    #qr-close-btn {
      background-color: #000;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    #qr-close-btn:hover {
      background-color: #333;
    }

    #qr-popup {
      right: auto !important;
      left: 20px !important;
      transform: translate(175%, 0%) !important;
      width: 320px;
      background: #fff;
      border: 2px solid rgb(0, 0, 0);
      /* Å‚atwiej zobaczyÄ‡ granice */
      z-index: 999;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      text-align: center;
      box-sizing: border-box;
    }

    #qr-popup p {
      font-size: 16px;
      margin-bottom: 12px;
      color: #000;
    }

    #qrcode {
      margin: 0 auto 16px auto;
      display: flex;
      justify-content: center;
    }

    #collapse-btn {
      font-size: 18px;
      /* Zmniejszona z 22px */
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      color: #111;
      margin-right: 8px;
      padding: 0;
      width: 24px;
      /* Zmniejszona z 30px */
      height: 24px;
      /* Zmniejszona z 30px */
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      /* Dodane dla lepszego wycentrowania */
    }

    .overview-header h6 {
      font-size: 18;
      /* Dodane, aby zmniejszyÄ‡ rozmiar nagÅ‚Ã³wka */
      margin: 0;
      /* UsuniÄ™cie domyÅ›lnych marginesÃ³w */
    }

    .overview-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      /* Zmniejszone z 12px */
    }

    #config-overview.hidden {
      display: none;
    }

    .overview-title {
      font-size: 16px;
      /* lub inna preferowana wielkoÅ›Ä‡ */
      font-weight: bold;
      margin: 0;
    }

   /* ğŸ“± Tryb PIONOWY â€” ukryj aplikacjÄ™, pokaÅ¼ komunikat */
@media (max-width: 820px) and (orientation: portrait) {
  body {
    background: #000 !important;
    overflow: hidden !important;
  }

  #app,
  #bottom-toolbar,
  #sidebar,
  .dimension-panel,
  .dimension-label,
  #qr-button,
  #export-panel,
  #custom-loader {
    all: unset;
    display: none !important;
    visibility: hidden !important;
  }

  html, body {
  margin: 0 !important;
  padding: 0 !important;
  height: 100% !important;
  background: #000 !important;
  overflow: hidden !important;
}

#rotate-message {
  position: fixed !important;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  height: 100vh;
  width: 100vw;
  z-index: 999999 !important;
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  flex-direction: column !important;
  gap: 30px !important;
  background: #666;
  color: white;
  font-family: 'Arial', 'Helvetica', sans-serif;
  padding: 0 !important;
  text-align: center !important;
}

.rotate-icon {
  font-size: 120px !important;
  line-height: 1 !important;
  margin: 0 !important;
  padding: 0 !important;
  display: block !important;
  text-align: center !important;
  width: 100% !important;
  color: white !important;
}

#rotate-message p {
  margin: 0 auto !important;
  text-align: center !important;
  max-width: 90vw;
  font-size: 22px !important;
  line-height: 1.3 !important;
  font-weight: 600 !important;
  letter-spacing: 0.5px !important;
  color: white !important;
}


  #export-config,
  #qr-button,
  #qr-popup,
  .export-trigger,
  .toolbar-btn[data-action="export"] {
    display: none !important;
  }
}

/* ğŸ¤– Tryb POZIOMY â€” pokaÅ¼ UI, ukryj komunikat - SKOPIOWANE Z DESKTOP */
@media (max-width: 820px) and (orientation: landscape) {
  body {
    background: #fff !important;
    overflow: auto !important;
  }

  #rotate-message {
    display: none !important;
  }

  #app,
  #custom-loader {
    display: flex !important;
  }

  /* ğŸ“± MOBILE LAYOUT - 60% canvas + 40% sidebar jak desktop */
  #app {
    height: 100vh;
    padding: 0;
    display: flex !important;
    flex-direction: row !important; /* ğŸ”§ Poziomy ukÅ‚ad jak desktop */
  }

  /* ğŸ“± CANVAS 3D - 60% szerokoÅ›ci (kopiowane z desktop) */
  #viewer {
    width: 60vw !important; /* ğŸ”§ 60% dla 3D canvas */
    height: 100vh !important;
    position: relative;
  }

  canvas {
    width: 60vw !important; /* ğŸ”§ 60% szerokoÅ›ci dla 3D */
    height: 100vh !important;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    display: block;
  }

  /* ğŸ“± SIDEBAR - 40% szerokoÅ›ci (kopiowane z desktop, zmniejszone) */
  #sidebar {
    position: fixed !important;
    right: 0 !important;
    top: 0 !important;
    width: 40vw !important; /* ğŸ”§ 40% szerokoÅ›ci dla UI */
    min-width: 40vw !important;
    max-width: 40vw !important;
    height: 100vh !important;
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    border-left: 1px solid #ddd !important;
    border-radius: 8px 0 0 8px !important;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1) !important;
    z-index: 100 !important;
    padding: 16px 12px !important; /* ğŸ”§ Mniejszy padding niÅ¼ desktop */
    box-sizing: border-box !important;
    overflow-y: auto !important;
    display: block !important;
    visibility: visible !important;
  }

  /* ğŸ“± WELCOME SCREEN - w obszarze canvas (kopiowane z desktop) */
  #welcome-screen {
    position: fixed !important;
    top: 50% !important;
    left: 30% !important; /* ğŸ”§ W Å›rodku canvas (60% / 2 = 30%) */
    right: auto !important;
    transform: translate(-50%, -50%) !important;
    width: 280px !important; /* ğŸ”§ Mniejsze niÅ¼ desktop */
    height: auto !important;
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(15px) !important;
    padding: 24px 16px !important; /* ğŸ”§ Mniejszy padding */
    border-radius: 12px !important;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1) !important;
    text-align: center !important;
    z-index: 1000 !important;
  }

  /* ğŸ“± THUMBNAILS - Å›rednie rozmiary (miÄ™dzy mobile a desktop) */
  .thumbnail,
  #overview-icons img,
  .back-to-model-btn {
    width: 60px !important; /* ğŸ”§ Åšrednie miÄ™dzy mobile (48px) a desktop (80px) */
    height: 60px !important;
  }

  .model-image {
    width: 60px !important;
    height: 60px !important;
  }

  .thumbnail-caption {
    font-size: 11px !important; /* ğŸ”§ Åšredni font */
    margin-top: 3px !important;
    text-align: center;
    line-height: 1.2 !important;
  }

  /* ğŸ“± CONTROL SECTIONS - skopiowane z desktop */
  .control-section {
    padding: 8px !important; /* ğŸ”§ Mniejszy niÅ¼ desktop */
    margin: 8px 0 !important;
  }

  .control-section h3 {
    font-size: 13px !important; /* ğŸ”§ Mniejszy niÅ¼ desktop (16px) */
    margin: 8px 0 6px 0 !important;
    text-align: center;
    font-weight: 600;
  }

  /* ğŸ“± GRID LAYOUTS - responsive dla mobile */
  #chairs-grid,
  #legs-grid {
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important; /* ğŸ”§ 4 kolumny jak desktop */
    gap: 6px !important; /* ğŸ”§ Mniejszy gap niÅ¼ desktop */
    justify-items: center;
    padding: 4px !important;
  }

  /* ğŸ“± THUMBNAIL WRAPPERS */
  .thumbnail-wrapper {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    margin-bottom: 6px !important;
    box-sizing: border-box !important;
    width: 100% !important;
  }

  /* ï¿½ BOTTOM TOOLBAR - skopiowane z desktop, dostosowane */
  #bottom-toolbar {
    display: none !important; /* ï¿½ CAÅKOWICIE USUNIÄ˜TY */
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    padding: 8px 12px !important; /* ğŸ”§ Mniejszy padding */
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15) !important;
    border: 1px solid #e0e0e0 !important;
    gap: 6px !important;
    z-index: 1001 !important;
  }

  /* ğŸ“± BOTTOM TOOLBAR VISIBLE STATE */
  #bottom-toolbar.visible {
    display: flex !important;
    opacity: 1 !important;
  }

  /* ğŸ“± TOOLBAR BUTTONS - mniejsze niÅ¼ desktop */
  #bottom-toolbar button {
    width: 36px !important; /* ğŸ”§ Mniejsze niÅ¼ desktop (48px) */
    height: 36px !important;
    font-size: 11px !important;
    padding: 6px !important;
    border-radius: 8px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  #bottom-toolbar button img {
    width: 18px !important; /* ğŸ”§ Mniejsze ikony */
    height: 18px !important;
  }

  /* ğŸ“± PART TABS - skopiowane z desktop */
  #part-tabs {
    display: flex !important;
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    gap: 6px !important;
    padding: 6px !important;
    justify-content: flex-start !important;
  }

  #part-tabs button,
  #part-tabs .part-btn {
    width: 44px !important; /* ğŸ”§ MiÄ™dzy mobile a desktop */
    height: 44px !important;
    font-size: 10px !important;
    padding: 6px !important;
    flex: 0 0 auto !important;
    border-radius: 8px !important;
    box-sizing: border-box !important;
  }

  #part-tabs img {
    width: 24px !important; /* ğŸ”§ Åšrednie rozmiary */
    height: 24px !important;
  }

  /* ğŸ“± MODEL IMAGE CONTAINER */
  #model-image-container {
    display: flex !important;
    flex-wrap: wrap !important;
    justify-content: flex-start !important;
    gap: 6px !important;
  }

  #model-image-container .model-image {
    width: calc(50% - 6px) !important;
    max-width: 70px !important;
    margin-bottom: 6px !important;
  }

  /* ğŸ“± BUY BUTTON */
  #buy-button {
    font-size: 13px !important;
    padding: 12px !important;
    width: 100% !important;
    margin-top: 12px !important;
    border-radius: 8px !important;
  }

  /* ğŸ“± CONFIG OVERVIEW - skopiowane z desktop */
  #config-overview {
    display: block !important; /* ğŸ”§ PokaÅ¼ jak na desktop */
  }

  #config-overview h2 {
    font-size: 14px !important; /* ğŸ”§ Mniejszy niÅ¼ desktop */
    line-height: 1.3 !important;
    margin: 8px 0 !important;
    padding: 8px !important;
    text-align: center !important;
  }

  /* ğŸ“± DIMENSION PANEL */
  .dimension-panel {
    position: fixed !important;
    bottom: 80px !important; /* ğŸ”§ Nad toolbar */
    left: 30% !important; /* ğŸ”§ W obszarze canvas */
    transform: translateX(-50%) !important;
    font-size: 11px !important;
    padding: 6px 8px !important;
    max-width: 50vw !important; /* ğŸ”§ Dopasowane do canvas */
    z-index: 2000 !important;
    background: white !important;
    border: 1px solid #ccc !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
    border-radius: 6px !important;
  }
  }

  /* ğŸŒ™ DARK MODE - skopiowane z desktop */
  body.dark-mode #sidebar {
    background: rgba(45, 45, 45, 0.95) !important;
    color: #e0e0e0 !important;
    border-left: 1px solid #444 !important;
  }

  body.dark-mode .control-section h3 {
    color: #e0e0e0 !important;
  }

  body.dark-mode .thumbnail-caption {
    color: #b0b0b0 !important;
  }
  
  body.dark-mode .thumbnail {
    background: #3a3a3a !important;
    border-color: #555 !important;
  }

  body.dark-mode #bottom-toolbar {
    display: none !important; /* ğŸš« CAÅKOWICIE USUNIÄ˜TY */
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }

  body.dark-mode #welcome-screen {
    background: rgba(45, 45, 45, 0.95) !important;
    color: #e0e0e0 !important;
  }

  body.dark-mode .dimension-panel {
    background: #3a3a3a !important;
    color: #e0e0e0 !important;
    border-color: #555 !important;
  }

  /* ğŸ“± RESPONSIVE ADJUSTMENTS dla rÃ³Å¼nych szerokoÅ›ci mobile */
  
  /* iPhone SE/5s (320px) */
  @media (max-width: 350px) and (orientation: landscape) {
    #sidebar {
      width: 45vw !important; /* ğŸ”§ WiÄ™cej UI na maÅ‚ych ekranach */
    }
    
    #viewer, canvas {
      width: 55vw !important; /* ğŸ”§ Mniej 3D */
    }
    
    #welcome-screen {
      left: 27.5% !important; /* ğŸ”§ Dostosuj do nowych proporcji */
    }
    
    #bottom-toolbar {
      left: 27.5% !important;
    }
    
    .dimension-panel {
      left: 27.5% !important;
    }
    
    #chairs-grid,
    #legs-grid {
      grid-template-columns: repeat(3, 1fr) !important; /* ğŸ”§ 3 kolumny dla maÅ‚ych */
    }
  }

  /* iPhone 6/7/8 (375px) */
  @media (min-width: 351px) and (max-width: 400px) and (orientation: landscape) {
    #sidebar {
      width: 42vw !important;
    }
    
    #viewer, canvas {
      width: 58vw !important;
    }
    
    #welcome-screen {
      left: 29% !important;
    }
    
    #bottom-toolbar {
      left: 29% !important;
    }
    
    .dimension-panel {
      left: 29% !important;
    }
  }

  /* iPhone Plus/Max (414px+) */
  @media (min-width: 401px) and (orientation: landscape) {
    #sidebar {
      width: 38vw !important; /* ğŸ”§ Mniej UI na wiÄ™kszych */
    }
    
    #viewer, canvas {
      width: 62vw !important; /* ğŸ”§ WiÄ™cej 3D */
    }
    
    #welcome-screen {
      left: 31% !important;
    }
    
    #bottom-toolbar {
      left: 31% !important;
    }
    
    .dimension-panel {
      left: 31% !important;
    }
    
    #chairs-grid,
    #legs-grid {
      grid-template-columns: repeat(5, 1fr) !important; /* ğŸ”§ 5 kolumn dla wiÄ™kszych */
    }
  }

  /* ğŸ“± UKRYJ NIEPOTRZEBNE ELEMENTY MOBILE */
  #mobile-top-ui,
  #mobile-chair-panel,
  #mobile-sidebar,
  #mobile-chairs-section,
  #mobile-legs-section,
  #toolbar-toggle,
  #floating-toggle {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }

  /* Ukryj loading screen na mobile */
  #custom-loader {
    display: none !important;
  }
}




  /* ï¿½ MOBILE VERTICAL UI - nad dark mode */
  #mobile-top-ui {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
  
  #mobile-top-ui .ui-section {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  #mobile-top-ui button {
    width: 35px;
    height: 35px;
    border: none;
    border-radius: 6px;
    background: #f0f0f0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  
  #mobile-top-ui button:hover {
    background: #e0e0e0;
  }
  
  #mobile-top-ui button img {
    width: 18px;
    height: 18px;
  }
  
  /* ğŸ”§ Dark mode toggle w mobile top UI */
  #mobile-theme-toggle {
    background: #333 !important;
    color: white;
    font-size: 16px;
  }
  
  /* ğŸ”§ CANVAS - 60% szerokoÅ›ci ekranu */
  #viewer, canvas {
    margin-top: 0 !important;
    height: 100vh !important;
    width: 60vw !important; /* ğŸ”§ 60% szerokoÅ›ci dla 3D */
  }
  
  /* ğŸ“± MOBILE CHAIR PANEL CSS - ULEPSZONA WERSJA */
  #mobile-chair-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(15px);
    border-top: 1px solid #ddd;
    padding: 20px 15px 25px 15px; /* ğŸ”§ WiÄ™kszy padding */
    z-index: 45;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    max-height: 50vh; /* ğŸ”§ WiÄ™ksza wysokoÅ›Ä‡ */
    overflow-y: auto;
  }
  
  .mobile-panel-header {
    text-align: center;
    margin-bottom: 16px; /* ğŸ”§ WiÄ™cej marginesu */
  }
  
  .mobile-panel-header h3 {
    margin: 0;
    font-size: 18px; /* ğŸ”§ WiÄ™kszy font */
    color: #333;
    font-weight: 600;
  }
  
  .mobile-chair-grid {
    display: grid;
    gap: 16px; /* ğŸ”§ WiÄ™kszy gap */
    justify-items: center;
    max-width: 400px; /* ğŸ”§ Szersza siatka */
    margin: 0 auto;
    /* ğŸ”§ Responsive grid */
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  }
  
  /* ğŸ“± RESPONSIVE GRID dla rÃ³Å¼nych rozmiarÃ³w iPhone */
  @media (max-width: 375px) {
    .mobile-chair-grid {
      grid-template-columns: repeat(2, 1fr) !important; /* ğŸ”§ 2 kolumny dla SE */
      gap: 12px !important;
      max-width: 300px !important;
    }
    
    .mobile-chair-thumb {
      width: 70px !important;
      height: 70px !important;
    }
    
    .mobile-chair-name {
      font-size: 12px !important;
    }
  }
  
  @media (min-width: 376px) and (max-width: 414px) {
    .mobile-chair-grid {
      grid-template-columns: repeat(3, 1fr) !important; /* ğŸ”§ 3 kolumny dla standard */
      gap: 14px !important;
      max-width: 350px !important;
    }
  }
  
  @media (min-width: 415px) {
    .mobile-chair-grid {
      grid-template-columns: repeat(4, 1fr) !important; /* ğŸ”§ 4 kolumny dla Plus/Pro Max */
      gap: 16px !important;
      max-width: 400px !important;
    }
  }
  
  .mobile-chair-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 12px 8px; /* ğŸ”§ WiÄ™kszy padding */
    border-radius: 12px; /* ğŸ”§ WiÄ™ksze zaokrÄ…glenie */
    transition: all 0.2s;
    width: 100%;
    border: 2px solid transparent; /* ğŸ”§ Ramka dla selection */
  }
  
  .mobile-chair-item:hover {
    background: rgba(0,0,0,0.05);
    transform: scale(1.05); /* ğŸ”§ WiÄ™kszy scale */
  }
  
  .mobile-chair-item.selected {
    background: rgba(0,123,255,0.1);
    border: 2px solid #007bff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3); /* ğŸ”§ CieÅ„ dla selection */
  }
  
  .mobile-chair-thumb {
    width: 80px; /* ğŸ”§ WiÄ™ksze thumbnails jak na desktop */
    height: 80px;
    border: 1px solid #ddd;
    border-radius: 8px;
    object-fit: contain;
    background: #fff;
    padding: 6px; /* ğŸ”§ WiÄ™kszy padding */
    box-sizing: border-box;
    transition: all 0.2s;
  }
  
  .mobile-chair-item:hover .mobile-chair-thumb {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .mobile-chair-name {
    font-size: 13px; /* ğŸ”§ WiÄ™kszy font */
    color: #333;
    text-align: center;
    margin-top: 6px; /* ğŸ”§ WiÄ™cej marginesu */
    font-weight: 500;
    line-height: 1.3;
  }
  
  /* ğŸŒ™ Dark mode dla mobile chair panel */
  body.dark-mode #mobile-chair-panel {
    background: rgba(45, 45, 45, 0.98) !important;
    border-top: 1px solid #444 !important;
  }
  
  body.dark-mode .mobile-panel-header h3 {
    color: #e0e0e0 !important;
  }
  
  body.dark-mode .mobile-chair-item {
    color: #e0e0e0 !important;
  }
  
  body.dark-mode .mobile-chair-item:hover {
    background: rgba(255,255,255,0.05) !important;
  }
  
  body.dark-mode .mobile-chair-thumb {
    background: #3a3a3a !important;
    border-color: #555 !important;
  }
  
  body.dark-mode .mobile-chair-name {
    color: #e0e0e0 !important;
  }

  .control-section {
    padding: 2px;
    margin: 3px 0;
  }

  .control-section h3 {
    font-size: 11px;
    margin: 3px 0 2px 0;
  }

  /* ğŸ“± RESPONSIVE THUMBNAILS - rÃ³Å¼ne rozmiary dla rÃ³Å¼nych iPhone'Ã³w */
  .options-grid {
    gap: 2px !important;
    justify-content: center !important;
  }

  /* ğŸ“± iPhone 5/5S/SE (szerokoÅ›Ä‡ ~320px) - 3 kolumny w mobile sidebar */
  @media (max-width: 350px) and (orientation: landscape) {
    #mobile-sidebar {
      width: 45vw !important; /* ğŸ”§ WiÄ™cej UI na maÅ‚ych ekranach */
    }
    
    #viewer, canvas {
      width: 55vw !important; /* ğŸ”§ Mniej 3D na maÅ‚ych ekranach */
    }
    
    #mobile-chairs-grid,
    #mobile-legs-grid {
      grid-template-columns: repeat(3, 1fr) !important; /* ğŸ”§ 3 kolumny dla iPhone 5 */
      gap: 6px !important;
    }
  }

  /* ğŸ“± iPhone 6/6S/7/8/SE 2020 (szerokoÅ›Ä‡ ~375px) - 4 kolumny */
  @media (min-width: 351px) and (max-width: 400px) and (orientation: landscape) {
    #mobile-sidebar {
      width: 42vw !important;
    }
    
    #viewer, canvas {
      width: 58vw !important;
    }
    
    #mobile-chairs-grid,
    #mobile-legs-grid {
      grid-template-columns: repeat(4, 1fr) !important; /* ğŸ”§ 4 kolumny dla iPhone 6-8 */
      gap: 7px !important;
    }
  }

  /* ğŸ“± iPhone 6/7/8 Plus (szerokoÅ›Ä‡ ~414px) - 4 kolumny */
  @media (min-width: 401px) and (max-width: 430px) and (orientation: landscape) {
    #mobile-sidebar {
      width: 40vw !important;
    }
    
    #viewer, canvas {
      width: 60vw !important;
    }
    
    #mobile-chairs-grid,
    #mobile-legs-grid {
      grid-template-columns: repeat(4, 1fr) !important; /* ğŸ”§ 4 kolumny dla iPhone Plus */
      gap: 8px !important;
    }
  }

  /* ğŸ“± iPhone X/XS/11 Pro/12 Mini/13 Mini (szerokoÅ›Ä‡ ~375px) - 4 kolumny */
  @media (min-width: 431px) and (max-width: 450px) and (orientation: landscape) {
    #mobile-sidebar {
      width: 38vw !important;
    }
    
    #viewer, canvas {
      width: 62vw !important;
    }
    
    #mobile-chairs-grid,
    #mobile-legs-grid {
      grid-template-columns: repeat(4, 1fr) !important;
      gap: 8px !important;
    }
  }

  /* ğŸ“± iPhone XR/XS Max/11/12/13/14/15 (szerokoÅ›Ä‡ ~390-428px) - 5 kolumn */
  @media (min-width: 451px) and (orientation: landscape) {
    #mobile-sidebar {
      width: 35vw !important;
    }
    
    #viewer, canvas {
      width: 65vw !important;
    }
    
    #mobile-chairs-grid,
    #mobile-legs-grid {
      grid-template-columns: repeat(5, 1fr) !important; /* ğŸ”§ 5 kolumn dla wiÄ™kszych iPhone */
      gap: 10px !important;
    }
  }

  /* ï¿½ iPhone 12, 13, 14, 15 (szerokoÅ›Ä‡ ~390px) - 2-3 kolumny */
  @media (min-width: 401px) and (max-width: 450px) and (orientation: landscape) {
    .thumbnail {
      width: 40px !important;
      height: 40px !important;
    }
    
    .thumbnail-wrapper {
      width: calc(33.33% - 1px) !important;
    }
    
    .thumbnail-caption {
      font-size: 8px;
      margin-top: 1px;
      line-height: 1;
    }
  }

  /* ğŸ“± iPhone 12 Pro Max, 13 Pro Max, 14 Plus/Pro Max, 15 Plus/Pro Max (szerokoÅ›Ä‡ ~428px) - 3 kolumny */
  @media (min-width: 451px) and (orientation: landscape) {
    .thumbnail {
      width: 35px !important;
      height: 35px !important;
    }
    
    .thumbnail-wrapper {
      width: calc(33.33% - 1px) !important;
    }
    
    .thumbnail-caption {
      font-size: 9px;
      margin-top: 2px;
      line-height: 1;
    }
  }

  /* ğŸ”§ 3 ikonki w rzÄ™dzie na mobile */
  .thumbnail-wrapper {
    width: calc(33.333% - 2px) !important;
  }

  /* ğŸ”§ Kolekcje ikon rÃ³wnieÅ¼ mniejsze */
  .collection-icon {
    width: 25px !important;
    height: 25px !important;
  }

  /* ğŸ”§ Model image container na mobile */
  #model-image-container img {
    height: 60px !important; /* ğŸ”§ Jeszcze mniejszy */
    margin-bottom: 4px !important;
  }

  /* ğŸ”§ Przyciski dolne na mobile - bardzo maÅ‚e */
  #bottom-toolbar button {
    width: 28px; /* ğŸ”§ Zmniejszone z 35px */
    height: 28px; /* ğŸ”§ Zmniejszone z 35px */
    font-size: 10px; /* ğŸ”§ Zmniejszone z 12px */
    padding: 4px; /* ğŸ”§ Mniejszy padding */
    border-radius: 6px; /* ğŸ”§ Mniejszy border-radius */
  }

  /* ğŸ”§ Bardzo maÅ‚e ikony w przyciskach na mobile */
  #bottom-toolbar button img {
    width: 14px !important;
    height: 14px !important;
  }

  /* ğŸ”§ Przycisk toggle na mobile - floating button */
  #bottom-toolbar .toggle-btn {
    background: #007bff !important;
    color: white !important;
    font-size: 16px !important;
    width: 40px !important;
    height: 40px !important;
    border-radius: 50% !important; /* ğŸ”§ OkrÄ…gÅ‚y przycisk */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4) !important; /* ğŸ”§ CieÅ„ */
    position: fixed !important; /* ğŸ”§ Fixed position dla floating */
    bottom: 15px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 2001 !important; /* ğŸ”§ Nad toolbar */
  }

  /* ğŸ”§ Floating button - USUNIÄ˜TY */
  #floating-toggle {
    display: none !important;
  }

  /* ğŸ”§ PokaÅ¼ przycisk toggle tylko na mobile */
  #toolbar-toggle {
    display: flex !important;
  }

  /* ğŸ”§ PokaÅ¼ floating button tylko na mobile */
  #floating-toggle {
    display: flex !important;
  }

  /* ğŸŒ™ Dark mode na mobile - NAPRAWIONY */
  body.dark-mode #sidebar {
    background: #2d2d2d !important;
    color: #e0e0e0 !important;
    border-left: 1px solid #444 !important;
  }

  body.dark-mode .control-section h3 {
    color: #e0e0e0 !important;
  }

  body.dark-mode .thumbnail-caption {
    color: #b0b0b0 !important;
  }
  
  body.dark-mode .thumbnail {
    background: #3a3a3a !important;
    border-color: #555 !important;
  }
  
  body.dark-mode #mobile-top-ui {
    background: rgba(45, 45, 45, 0.95) !important;
    color: #e0e0e0 !important;
    border-bottom: 1px solid #444 !important;
  }
  
  body.dark-mode #mobile-top-ui button {
    background: #3a3a3a !important;
    color: #e0e0e0 !important;
  }
  
  body.dark-mode #mobile-top-ui button:hover {
    background: #4a4a4a !important;
  }

  /* ğŸ“± UKRYJ BOTTOM TOOLBAR - zrobimy pÃ³Åºniej */
  #bottom-toolbar {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
  
  /* ğŸ“± UKRYJ MOBILE TOP UI NA LANDSCAPE - kompletnie */
  #mobile-top-ui,
  #mobile-chair-panel {
    display: none !important;
  }

  /* Ukryj dodatkowe przyciski w mobile - bezpoÅ›rednio po ID */
  #export-config,
  #export-panel,
  #qr-button,
  #bottom-toolbar #qr-button,
  #hdr-toggle,
  #dimensions-show,
  #ar-button,
  #brightness-control,
  button[title="Pobierz konfiguracjÄ™"],
  button[title="Zobacz na telefonie"],
  button[title="Wymiary modelu"],
  button[title="AR"],
  button[title="ZmieÅ„ jasnoÅ›Ä‡"] {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }

  #part-tabs {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 8px;
    padding: 8px;
    justify-content: flex-start;
  }

  #part-tabs button,
  #part-tabs .part-btn {
    width: 48px;
    height: 48px;
    font-size: 10px;
    padding: 4px;
    flex: 0 0 auto;
    border-radius: 6px;
    box-sizing: border-box;
  }

  #part-tabs img {
    width: 28px;
    height: 28px;
  }

  #bottom-toolbar {
    left: 50%;
    transform: translateX(-50%) translateY(100%); /* ğŸ”§ DomyÅ›lnie ukryty poza ekranem */
    bottom: 0px; /* ğŸ”§ Na samym dole */
    padding: 12px 16px; /* ğŸ”§ Wygodniejszy padding */
    width: auto; /* ğŸ”§ Automatyczna szerokoÅ›Ä‡ */
    max-width: calc(100vw - 80px); /* ğŸ”§ WiÄ™cej miejsca */
    justify-content: center;
    flex-wrap: wrap;
    gap: 8px; /* ğŸ”§ Wygodniejsze odstÄ™py */
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* ğŸ”§ Smooth animacja */
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
    border: 1px solid #e0e0e0;
    border-bottom: none;
  }

  /* ğŸ”§ Dodaj wskaÅºnik Å¼e toolbar moÅ¼na wyciÄ…gnÄ…Ä‡ */
  #bottom-toolbar::before {
    content: '';
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 3px;
    background: #007bff;
    border-radius: 2px;
    opacity: 0.5;
  }

  /* ğŸ”§ Mobile toolbar visible state */
  #bottom-toolbar.mobile-ready {
    display: flex; /* ğŸ”§ PokaÅ¼ na mobile po wyborze krzesÅ‚a */
    opacity: 1;
  }

  /* ğŸ”§ WysuniÄ™ty stan dla bottom-toolbar na mobile */
  #bottom-toolbar.expanded {
    transform: translateX(-50%) translateY(0); /* ğŸ”§ W peÅ‚ni widoczny */
  }

  /* ğŸ”§ Toggle button w toolbar - do zamykania */
  #bottom-toolbar .toggle-btn {
    position: absolute;
    top: 8px;
    right: 12px;
    background: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #666;
    cursor: pointer;
    z-index: 1;
  }

  .dimension-panel {
    position: fixed !important;
    bottom: 150px !important;
    left: 200px !important;
    font-size: 12px !important;
    padding: 6px 8px !important;
    max-width: 90% !important;
    z-index: 2147483647 !important;
    background: white !important;
    border: 1px solid #ccc !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
    border-radius: 6px !important;
  }

  #export-panel {
    display: none !important;
    visibility: hidden;
    pointer-events: none;
  }

  #model-image-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    gap: 8px;
  }

  .model-image {
    width: 60px;
    height: 60px;
    flex: 0 0 auto;
    box-sizing: border-box;
  }

  #model-image-container .model-image {
    width: calc(50% - 8px);
    max-width: 80px;
    margin-bottom: 8px;
  }

  .thumbnail,
  #overview-icons img,
  .back-to-model-btn {
    width: 48px;
    height: 48px;
  }

  .thumbnail-caption {
    font-size: 11px;
    margin-top: 2px;
    text-align: center;
  }

  #buy-button {
    font-size: 14px;
    padding: 10px;
    width: 100%;
    margin-top: 12px;
  }

  #config-overview {
    display: none !important; /* ğŸ”§ Ukryj panel podsumowania na mobile na start */
  }

  #config-overview h2 {
    font-size: 6px !important;
    line-height: 1 !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  #config-overview h2::after {
    content: "+  Twoja konfiguracja";
    font-size: 14px;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #000;
  }

  #config-overview .overview-title {
    display: none;
  }
}

/* ğŸ–¥ï¸ DESKTOP STYLES - DuÅ¼y UI dla wiÄ™kszych ekranÃ³w */
@media (min-width: 821px) {
  #sidebar {
    width: 460px !important; /* ğŸ”§ DuÅ¼y sidebar na desktop */
    min-width: 460px !important;
    max-width: 460px !important;
    padding: 32px 24px 24px 24px !important; /* ğŸ”§ DuÅ¼y padding na desktop */
    border-radius: 16px !important;
    background: #fff !important;
    box-shadow: 0 4px 32px rgba(0, 0, 0, 0.10) !important;
    border: 1px solid rgba(0, 0, 0, 0.08) !important;
  }

  /* Welcome screen dla desktop */
  #welcome-screen {
    right: 460px !important; /* ğŸ”§ Zostaw miejsce na duÅ¼y sidebar */
  }

  /* ğŸ”§ Ukryj przycisk toggle na desktop */
  #toolbar-toggle,
  #floating-toggle {
    display: none !important;
  }

  /* ğŸ”§ Bottom toolbar na desktop - wyÅ›rodkowany wzglÄ™dem canvas */
  #bottom-toolbar {
    left: calc(50% - 230px) !important; /* ğŸ”§ PrzesuniÄ™ty o poÅ‚owÄ™ szerokoÅ›ci sidebara */
    transform: translateX(-50%) !important; /* ğŸ”§ WyÅ›rodkowany wzglÄ™dem tej pozycji */
    display: none !important; /* ğŸ”§ DomyÅ›lnie ukryty na desktop */
    opacity: 0 !important; /* ğŸ”§ Przezroczysty na start */
    bottom: 14px !important; /* ğŸ”§ PrzywrÃ³Ä‡ desktop bottom */
  }

  /* ğŸ”§ Visible state na desktop */
  #bottom-toolbar.visible {
    display: flex !important;
    opacity: 1 !important;
  }

  /* DuÅ¼e thumbnails na desktop */
  .thumbnail,
  #overview-icons img,
  .back-to-model-btn {
    width: 80px !important;
    height: 80px !important;
  }

  .model-image {
    width: 80px !important;
    height: 80px !important;
  }

  #part-tabs img {
    width: 48px !important;
    height: 48px !important;
  }

  .thumbnail-caption {
    font-size: 14px !important;
    margin-top: 4px !important;
  }
}

/* ğŸ–¥ï¸ Ukryj komunikat na desktopach */
@media (min-width: 821px) {
  #rotate-message {
    display: none !important;
  }
}

  /* ğŸ“± GLOBALNE UKRYWANIE NA MOBILE - wszystkie orientacje */
@media (max-width: 820px) {
  #export-config,
  #export-panel,
  #qr-button,
  #qr-close-btn,
  #qr-popup,
  button[title="Pobierz konfiguracjÄ™"],
  button[title="Zobacz na telefonie"] {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }

  /* âœ… WYMUÅš WIDOCZNOÅšÄ† TYLKO DLA JASNOÅšCI, WYMIARÃ“W I AR */
  #hdr-toggle,
  #dimensions-show,
  #brightness-control,
  #ar-button,
  button[title="Wymiary modelu"],
  button[title="AR"],
  button[title="ZmieÅ„ jasnoÅ›Ä‡"] {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    pointer-events: auto !important;
  }
}



    .dimension-panel {
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 1001;
    }

    

    #export-panel {
      position: absolute;
      bottom: 60px;
      /* nad przyciskiem */
      right: 62px;
      /* <- tu zwiÄ™ksz wartoÅ›Ä‡, Å¼eby przesunÄ…Ä‡ panel bardziej w lewo */
      background: #ffffff;
      border: 1px solid #eeeeee;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    #export-panel.hidden {
      display: none;
    }

    .export-btn {
      background-color: #444;
      color: #222222;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      white-space: nowrap;
    }

    .export-btn:hover {
      background-color: #555;
    }
/*Ukrycie przyciku exportu*/
#export-config {
  display: none;
}

#export-panel {
  display: none;
}

   .collection-icon {
  width: 64px;
  height: 64px;
  object-fit: contain;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  transition: transform 0.2s, border-color 0.2s;
}

.collection-icon:hover {
  transform: scale(1.05);
  border-color: #444;
}

.collection-icon.selected {
  outline: 2px solid #000;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}




    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #material-options details summary {
      cursor: pointer;
      font-weight: bold;
      background: #f7f7f7;
      border-radius: 8px;
      padding: 6px 10px;
      margin-bottom: 6px;
    }

    .collection-icon {
  width: 64px;
  height: 64px;
  object-fit: contain;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  transition: transform 0.2s, border-color 0.2s;
}

.collection-icon:hover {
  transform: scale(1.05);
  border-color: #444;
}

.collection-icon.selected {
  outline: 2px solid #000;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}

.collection-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 88px;
  align-items: center;
}

#custom-loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  font-family: Arial, sans-serif;
}

#custom-loader img {
  width: 220px;
  margin-bottom: 20px;
  animation: pulse 1.5s infinite;
}

#custom-loader p {
  font-size: 18px;
  color: #333;
}

#custom-loader.fade-out {
  opacity: 0;
  transition: opacity 0.5s ease;
  pointer-events: none;
}

#model-loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #fff;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  font-family: Arial, sans-serif;
}

#model-loader img {
  width: 220px;
  margin-bottom: -10px;
}

#model-loader p {
  font-size: 18px;
  color: #333;
  text-align: center;
  margin: 0;
}

.loading-dots {
  display: flex;
  justify-content: center;
  margin-top: -10px;
}

.loading-dots span {
  font-size: 64px;
  color: #333;
  animation: blink 1.5s infinite;
  margin: 0 4px;
}

.loading-dots span:nth-child(2) {
  animation-delay: 0.2s;
}
.loading-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes blink {
  0% { opacity: 0.2; }
  50% { opacity: 1; }
  100% { opacity: 0.2; }
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}

.loader {
  border: 8px solid #f3f3f3;
  border-top: 8px solid #555;
  
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-bottom: 12px;
}
#material-preloader {
  display: none;
  position: fixed; /* fixed zamiast absolute - zawsze na Å›rodku okna */
 
  z-index: 10000;
  left: 0; top: 0; right: 0; bottom: 0;
  width: 100vw; height: 100vh;
  background: rgba(255,255,255,0.85);
  display: flex;
  align-items: center;
  justify-content: center;
}
#material-preloader .preloader-box {
  text-align: center;
  background: rgba(255,255,255,0.97);
   transform: translateX(-10%);
  border-radius: 24px;
  padding: 48px 64px;
  box-shadow: 0 0 24px #0003;
}
#material-preloader .loader {
  border: 12px solid #f3f3f3;
  border-top: 12px solid #555;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-bottom: 24px;
}
@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}



#brightness-control {
  display: none;
  position: absolute;
  bottom: calc(100% + 10px); /* Nad przyciskiem Å¼arÃ³wki */
  left: 50%;
  transform: translateX(-50%); /* WyÅ›rodkuj nad przyciskiem */
  background: white;
  padding: 8px 10px; /* ğŸ”§ Mniejszy padding */
  border-radius: 6px;
  align-items: center;
  z-index: 2001;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  white-space: nowrap;
  flex-direction: column;
  width: 25px; /* ğŸ”§ StaÅ‚a szerokoÅ›Ä‡ zamiast min/max */
  height: 120px; /* ğŸ”§ StaÅ‚a wysokoÅ›Ä‡ */
  border: 1px solid #ddd;
  justify-content: center; /* ğŸ”§ WyÅ›rodkuj zawartoÅ›Ä‡ */
}

#brightness-control label {
  font-size: 10px; /* ğŸ”§ ZwiÄ™kszony z 9px na 10px */
  color: #333;
  font-weight: bold;
  margin: 0;
  text-align: center;
  line-height: 1;
}

#brightness-control input[type="range"] {
  width: 100px; /* ğŸ”§ DÅ‚ugoÅ›Ä‡ slidera */
  height: 3px;
  background: #ddd;
  border-radius: 2px;
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  transform: rotate(-90deg); /* Pionowy */
  transform-origin: center;
  margin: 0; /* ğŸ”§ UsuÅ„ margin - panel ma staÅ‚e wymiary */
}

#brightness-control input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 12px;
  height: 12px;
  background: #444;
  border-radius: 50%;
  cursor: pointer;
  border: 1px solid white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

#brightness-control input[type="range"]::-moz-range-thumb {
  width: 12px;
  height: 12px;
  background: #444;
  border-radius: 50%;
  cursor: pointer;
  border: 1px solid white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}



    /* iOS specific styles */
    .ios-device #sidebar {
      padding-bottom: env(safe-area-inset-bottom, 16px) !important;
    }
    
    /* USDZ viewer styles */
    #usdz-viewer {
      font-family: 'Poppins', sans-serif;
    }
    
    #usdz-viewer h2 {
      font-weight: 600;
      margin: 0;
    }
    
    #usdz-viewer p {
      line-height: 1.4;
      margin: 0;
    }
    
    #usdz-viewer a {
      font-family: inherit;
    }
    
    #usdz-viewer button {
      font-family: inherit;
    }
    
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body>

  <div id="rotate-message">
    <div class="rotate-icon">â†»</div>
    <p>ObrÃ³Ä‡ urzÄ…dzenie poziomo</p>
  </div>




  <div id="custom-loader">
  <img src="icons/FK_Logo.jpg" alt="Fajne KrzesÅ‚a" />
  
</div>

<div id="model-loader">
  
  <img src="icons/FK_Logo.jpg" alt="Fajne KrzesÅ‚a" />
  <div class="loading-dots">
  <span>.</span><span>.</span><span>.</span>
</div>
  <p>Loading...</p>
</div>



  <div id="app">

    <!-- ğŸŒ™ PRZYCISK DARK/LIGHT MODE - ZAWSZE WIDOCZNY W DOLNYM ROGU -->
    <button id="theme-toggle" title="PrzeÅ‚Ä…cz motyw">â˜½</button>

    <!-- ğŸ“± NOWY MOBILE SIDEBAR - tylko na mobile -->
    <div id="mobile-sidebar" style="display: none;">
      <div id="mobile-chairs-section">
        <h3 style="display: none;">KrzesÅ‚a</h3> <!-- ğŸ”§ Ukryj napisy -->
        <div id="mobile-chairs-grid">
          <!-- KrzesÅ‚a bÄ™dÄ… dodane przez JavaScript -->
        </div>
      </div>
      
      <div id="mobile-legs-section" style="display: none;">
        <h3 style="display: none;">Nogi</h3> <!-- ğŸ”§ Ukryj napisy -->
        <div id="mobile-legs-grid">
          <!-- Nogi bÄ™dÄ… dodane przez JavaScript -->
        </div>
      </div>
    </div>

<div id="material-preloader" style="display:none;">
  <div class="preloader-box">
    <span class="loader"></span>
    <div style="margin-top: 16px; font-size: 2em;">Åadowanie materiaÅ‚u...</div>
  </div>
</div>

    <canvas id="canvas"></canvas>
    
    <!-- ğŸ¯ EKRAN STARTOWY - WYBIERZ KRZESÅO -->
    <div id="welcome-screen">
      <img id="welcome-logo" src="icons/FK_Logo.jpg" alt="Fajne KrzesÅ‚a">
      <h1>Konfigurator KrzeseÅ‚</h1>
      <p>Wybierz model krzesÅ‚a z bocznego panelu, aby rozpoczÄ…Ä‡ konfiguracjÄ™ w 3D</p>
    </div>
    
    <div id="config-overview" class="collapsed hidden">
      <div class="overview-header">
        <button id="collapse-btn">+</button>
        <span class="overview-title">Twoja Konfiguracja</span>
      </div>
      <div class="overview-content">
        <!-- tu caÅ‚a zawartoÅ›Ä‡, ktÃ³ra ma siÄ™ zwijaÄ‡ -->
        <div id="overview-icons"></div>
        <div id="overview-details"></div>
        <div id="overview-total">
          <p>Suma: <strong id="overview-total-price">0.00 PLN</strong></p>
          <button id="buy-button">KupujÄ™</button>
        </div>
      </div>
    </div>

    <div id="sidebar">
      <div id="model-image-container"></div>
      <div id="model-section" style="margin-top: 20px;">
        <div id="model-thumbnails" class="options-grid"></div>
      </div>
      <div id="config-section" style="display:none;">
        <div id="back-to-models-container" style="margin-bottom: 15px;"></div>
        <div id="legs-section" class="selection-section">
          <h3>Nogi:</h3>
          <div id="legs-thumbnails" class="options-grid"></div>
        </div>
        <div id="parts-section" class="selection-section">
          <h3>Wybierz element:</h3>
          <div id="part-tabs" class="options-grid"></div>
        </div>
        <div id="materials-section" class="selection-section">
          <h3>Wybierz materiaÅ‚:</h3>
          <div id="material-options" style="display: none;"></div>

<!-- PANEL KOLEKCJI + MATERIAÅY -->
<div id="collection-container" style="display: flex; gap: 24px; margin-top: 20px;">
  <div id="collection-icons" style="display: flex; flex-direction: column; gap: 14px; width: 88px;"></div>
  <div id="material-panel-viewer" class="options-grid" style="flex-grow: 1;"></div>
</div>




      </div>
      <div id="summary"></div>
    </div>
  </div>
  <!-- FORMULARZ EMAIL - POPUP -->
  <div id="emailModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>WyÅ›lij swojÄ… konfiguracjÄ™</h2>
      <form id="emailForm">
        <label for="name">ImiÄ™ i nazwisko:</label>
        <input type="text" id="name" name="name" required>

        <label for="email">Adres e-mail:</label>
        <input type="email" id="email" name="email" required>

        <label for="phone">Numer telefonu:</label>
        <input type="tel" id="phone" name="phone">

        <!-- Ukryte pola na dane konfiguracji -->
        <input type="hidden" id="model" name="model">
        <input type="hidden" id="price" name="price">
        <input type="hidden" id="total" name="total">

        <button type="submit">WyÅ›lij</button>
      </form>
    </div>
  </div>

  



  




  <!-- KOMUNIKAT SUKCESU -->
  <div id="success-message" class="hidden">âœ… DziÄ™kujemy! Formularz zostaÅ‚ wysÅ‚any.</div>



  <!-- ğŸ“± MOBILE CHAIR PANEL - osobny panel z krzesÅ‚ami -->
  <div id="mobile-chair-panel" style="display: none;">
    <div class="mobile-panel-header">
      <h3>Wybierz krzesÅ‚o</h3>
    </div>
    <div id="mobile-chair-grid" class="mobile-chair-grid">
      <!-- KrzesÅ‚a bÄ™dÄ… dodane przez JavaScript -->
    </div>
  </div>

  <!-- ğŸ“± MOBILE TOP UI -->
  <div id="mobile-top-ui" style="display: none;">
    <div class="ui-section">
      <!-- Dark mode toggle -->
      <button id="mobile-theme-toggle" title="Tryb ciemny">ğŸŒ™</button>
      
      <!-- Brightness -->
      <button id="mobile-brightness" title="JasnoÅ›Ä‡">
        <img src="icons/bulb_icon.png" alt="JasnoÅ›Ä‡">
      </button>
      
      <!-- AR -->
      <button id="mobile-ar" title="AR">
        <img src="icons/AR_icon.png" alt="AR">
      </button>
      
      <!-- Dimensions -->
      <button id="mobile-dimensions" title="Wymiary">
        <img src="icons/dimmension_icon.png" alt="Wymiary">
      </button>
    </div>
  </div>

  <!-- Dolny panel UI -->
  <div id="bottom-toolbar" style="display: none;">

  <!-- Przycisk toggle (tylko na mobile) -->
  <button id="toolbar-toggle" class="toggle-btn" title="Ukryj narzÄ™dzia" style="display: none;">Ã—</button>

   
  <!-- Przycisk HDR z kontrolÄ… jasnoÅ›ci -->
  <div style="position: relative; display: inline-block;">
  <button id="hdr-toggle" title="ZmieÅ„ jasnoÅ›Ä‡">
    <img src="icons/bulb_icon.png" alt="JasnoÅ›Ä‡" class="bulb-icon" style="width: 30px; height: 30px;"> <!-- ğŸ”§ ZwiÄ™kszone z 20px na 30px -->
  </button>
  
  <!-- Kontrola jasnoÅ›ci - bezpoÅ›rednio nad przyciskiem HDR -->
  <div id="brightness-control">
    <input type="range" id="brightness-slider" min="0.1" max="3" step="0.1" value="1">
  </div>
</div>

    <button id="ar-button" title="AR">
      <img src="icons/AR_icon.png" alt="AR" style="width: 30px; height: 30px;">
    </button>

    <button id="dimensions-show" title="Wymiary modelu">
      <img src="icons/dimmension_icon.png" alt="Wymiary" style="width: 30px; height: 30px;"> <!-- ğŸ”§ ZwiÄ™kszone z 20px na 30px -->
    </button>

    <button id="export-config" title="Pobierz konfiguracjÄ™">
      <img src="icons/export_icon.png" alt="Eksport" style="width: 20px; height: 20px;">
    </button>

      <div id="export-panel" class="hidden">
      <button class="export-btn" data-format="fbx">FBX</button>
      <button class="export-btn" data-format="dae">DAE</button>
      <button class="export-btn" data-format="obj">OBJ</button>
    </div>

    <button id="qr-button" title="Zobacz na telefonie">
      <img src="icons/qr_icon.png" alt="QR" style="width: 20px; height: 20px;">
    </button>

  </div>

  <!-- ğŸ”§ Floating button do wysuwania toolbar na mobile -->
  <button id="floating-toggle" style="display: none;">â‹®</button>

<div id="model-image-container"></div>

  <div id="dimension-overlay" style="display: none;"></div>  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/favicon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">


  <div id="ar-popup" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-100%, -50%);
  background: white;
  padding: 20px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.2);
  display: none;
  z-index: 9999;
  text-align: center;
  max-width: 300px;
">
    <img src="icons/AR_icon.png" alt="AR Ikona" style="width: 60px; margin-bottom: 10px;" />
    <div style="font-size: 18px; font-weight: bold;">DostÄ™pne wkrÃ³tce</div>
    <div style="margin-top: 6px; font-size: 14px;">Tryb AR zostanie wkrÃ³tce uruchomiony.</div>
    <button onclick="document.getElementById('ar-popup').style.display='none'" style="
    margin-top: 12px;
    background: #141414;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
  ">Zamknij</button>
  </div>






  <div id="qr-popup"
    style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.2); z-index:3000;">
    <p style="margin-bottom:10px;">Zeskanuj kod QR telefonem:</p>
    <div id="qrcode"></div>
    <button id="qr-close-btn">Zamknij</button>

  </div>


  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script>
    function showQR() {
      const url = window.location.href;
      document.getElementById('qr-popup').style.display = 'block';
      document.getElementById('qrcode').innerHTML = ''; // czyÅ›Ä‡ stare
      document.getElementById('qr-close-btn').addEventListener('click', () => {
        document.getElementById('qr-popup').style.display = 'none';
      });

      new QRCode(document.getElementById("qrcode"), {
        text: url,
        width: 200,
        height: 200,
      });
    }
  </script>


  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script>
    emailjs.init('tjw0wCwxn3xsnfNV5');

    function generateSummaryText() {
      let text = "";
      let totalPrice = 0;

      if (window.selectedChair) {
        const price = parseFloat(window.selectedChair.Cena) || 0;
        totalPrice += price;
        text += `Model: ${window.selectedChair.Nazwa} (${price.toFixed(2)} PLN)\n`;
      }

      if (window.selectedLeg) {
        const price = parseFloat(window.selectedLeg.Cena) || 0;
        totalPrice += price;
        text += `Wariant nÃ³g: ${window.selectedLeg.Nazwa} (${price.toFixed(2)} PLN)\n`;
      }

      const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'legs_material', 'backseat'];
      partOrder.forEach(part => {
        const mat = window.selectedMaterials?.[part];
        if (mat) {
          const price = parseFloat(mat.Cena) || 0;
          totalPrice += price;
          text += `${part.replace(/_/g, ' ')}: ${mat.Nazwa} (${price.toFixed(2)} PLN)\n`;
        }
      });

      text += `\nSuma konfiguracji: ${totalPrice.toFixed(2)} PLN`;
      return { text, totalPrice };
    }



    emailForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const summary = generateSummaryText();

      document.getElementById('model').value = window.selectedChair?.Nazwa || 'Brak modelu';
      document.getElementById('price').value = parseFloat(window.selectedChair?.Cena || 0).toFixed(2);
      document.getElementById('total').value = summary.totalPrice.toFixed(2);

      let configTextInput = document.getElementById('configText');
      if (!configTextInput) {
        configTextInput = document.createElement('textarea');
        configTextInput.name = 'configText';
        configTextInput.id = 'configText';
        configTextInput.hidden = true;
        emailForm.appendChild(configTextInput);
      }
      configTextInput.value = summary.text;

      emailjs.sendForm('service_iqzcwli', 'template_qgq7htg', emailForm)
        .then(() => {
          document.getElementById('emailModal')?.classList.add('hidden');

          const successMessage = document.getElementById('success-message');
          successMessage.classList.remove('hidden');
          successMessage.classList.add('visible');

          setTimeout(() => {
            successMessage.classList.remove('visible');
            successMessage.classList.add('hidden');
          }, 3500);

          emailForm.reset();
        })
        .catch((error) => {
          alert('âŒ CoÅ› poszÅ‚o nie tak. SprÃ³buj ponownie.');
          console.error('EmailJS error:', error);
        });
    });
  </script>






  <script type="module">
    // GÅ‚Ã³wna biblioteka Three.js (z importmap)
    import * as THREE from 'three'; // opcjonalne, jeÅ›li uÅ¼ywasz tylko konkretnych importÃ³w

    // Konkretnie z Three.js (potrzebne do wymiarÃ³w i geometrii)
    import {
      Group,
      Box3,
      Vector3,
      ArrowHelper,
      Sprite,
      SpriteMaterial,
      CanvasTexture,
      Color,
      TextureLoader
    } from 'three';

    // ThreePipe core â€“ viewer i pluginy
    import {
      ThreeViewer,
      LoadingScreenPlugin,
      GBufferPlugin,
      SSAAPlugin,
    } from 'threepipe';

    // Pluginy z WebGI (ThreePipe)
    import {
      SSReflectionPlugin,
      BloomPlugin
    } from '@threepipe/webgi-plugins';








    const CAMERA_FOV = 12;
    const CAMERA_NEAR = 0.1;
    const CAMERA_FAR = 100;
    const CAMERA_POSITION = { x: -4.50, y: 0.28, z: 4.53 }; // ğŸ”§ Idealna pozycja ustawiona przez uÅ¼ytkownika v3
    const CAMERA_TARGET = { x: 1, y: -0.5, z: 2 }; // ğŸ”§ WyÅ›rodkowanie targetu

    const MIN_ZOOM_DISTANCE = 1; // minimalna odlegÅ‚oÅ›Ä‡ kamery od modelu (przybliÅ¼enie)
    const MAX_ZOOM_DISTANCE = 8; // maksymalna odlegÅ‚oÅ›Ä‡ kamery od modelu (oddalenie)
    const VERTICAL_OFFSET = 0;

    let viewer, currentModelContainer, currentLegModel;
    let allData = [];
    let selectedChair, selectedLeg, selectedMaterials = {};
    let globalCameraTargetPosition;
    let userInteracted = false;
    let dimensionHelpers = [];
    let currentModel = null;
    let selectedLegVariant = null;
    let lastOpenedCollection = null;









    const ELEMENT_ICONS = {
      seat: 'icons/m_seat_icon.png',
      backseat_inside: 'icons/m_backseat_in_icon.png',
      backseat_outside: 'icons/m_backseat_out_icon.png',
      backseat: 'icons/m_backseat_icon.png',
      legs: 'icons/m_legs_icon.png'
    };

    function showScreen(screenName) {
      document.getElementById('model-section').style.display = screenName === 'models' ? 'block' : 'none';
      document.getElementById('config-section').style.display = screenName === 'config' ? 'block' : 'none';
    }


    async function loadCameraTarget() {
      try {
        const targetsContainer = await viewer.load('camera_target.glb');
        if (targetsContainer) {
          // Szukaj obiektu o nazwie "camera_target" (lub zmieÅ„ na nazwÄ™ empty z Blender)
          const targetObject = targetsContainer.getObjectByName('camera_target');
          if (targetObject) {
            globalCameraTargetPosition = targetObject.getWorldPosition(new Vector3());
          } else {
            // JeÅ›li nie znajdzie, uÅ¼yj Å›rodka sceny
            globalCameraTargetPosition = new Vector3(0, 0, 0);
          }
          viewer.scene.remove(targetsContainer); // nie pokazuj empty w scenie
        }
      } catch (e) {
        console.warn("Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ 'camera_target.glb'. UÅ¼ywam domyÅ›lnych ustawieÅ„.");
        globalCameraTargetPosition = new Vector3(0, 0, 0);
      }
    }

    // ğŸ“± POKAZ USDZ PREVIEW (iOS AR Quick Look)
    async function showUSZDPreview(variant) {
      console.log('ğŸ“± PokazujÄ™ USDZ preview dla:', variant.Nazwa);
      
      const canvas = document.getElementById('canvas');
      const welcomeScreen = document.getElementById('welcome-screen');
      
      // Ukryj welcome screen i pokaÅ¼ canvas area
      welcomeScreen.style.display = 'none';
      canvas.style.display = 'block';
      
      // SprawdÅº czy juÅ¼ istnieje USDZ viewer
      let usdzViewer = document.getElementById('usdz-viewer');
      if (!usdzViewer) {
        usdzViewer = document.createElement('div');
        usdzViewer.id = 'usdz-viewer';
        usdzViewer.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          text-align: center;
          z-index: 5;
          padding: 20px;
        `;
        canvas.parentNode.insertBefore(usdzViewer, canvas);
      }
      
      const usdzPath = `chairs/${variant.Nazwa}.usdz`;
      
      usdzViewer.innerHTML = `
        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“±</div>
        <h2 style="margin-bottom: 15px; font-size: 1.5em;">${variant.Nazwa}</h2>
        <p style="opacity: 0.9; margin-bottom: 25px; font-size: 1.1em;">
          WyÅ›wietl krzesÅ‚o w<br>
          <strong>rzeczywistoÅ›ci rozszerzonej</strong>
        </p>
        <a href="${usdzPath}" 
           rel="ar" 
           style="
             display: inline-block;
             background: rgba(255,255,255,0.9);
             color: #333;
             padding: 15px 30px;
             border-radius: 25px;
             text-decoration: none;
             font-weight: 600;
             margin: 10px;
             box-shadow: 0 4px 16px rgba(0,0,0,0.2);
             transition: all 0.3s ease;
             font-size: 1.1em;
           "
           onmouseover="this.style.transform='scale(1.05)'"
           onmouseout="this.style.transform='scale(1)'">
          ğŸ¥½ OtwÃ³rz w AR
        </a>
        <div style="margin-top: 20px;">
          <button onclick="switchToWebGLViewer('${variant.Nazwa}')" 
                  style="
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.3);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 1em;
                  ">
            ğŸ“± PokaÅ¼ w przeglÄ…darce
          </button>
        </div>
        <p style="opacity: 0.6; font-size: 12px; margin-top: 20px;">
          ğŸ“± Zoptymalizowane dla Safari iOS
        </p>
      `;
      
      usdzViewer.style.display = 'flex';
      canvas.style.display = 'none';
    }

    // ğŸ“± PRZEÅÄ„CZENIE NA WEBGL VIEWER (fallback z USDZ)
    async function switchToWebGLViewer(chairName) {
      console.log('ğŸ“± PrzeÅ‚Ä…czam na WebGL viewer dla:', chairName);
      
      const usdzViewer = document.getElementById('usdz-viewer');
      const canvas = document.getElementById('canvas');
      
      if (usdzViewer) usdzViewer.style.display = 'none';
      canvas.style.display = 'block';
      
      // ZnajdÅº dane krzesÅ‚a i zaÅ‚aduj jako GLB
      const variant = allData.find(item => item.Nazwa === chairName);
      if (variant) {
        try {
          const glbPath = `chairs/${chairName}.glb`;
          console.log('ğŸ“± Åadowanie WebGL fallback:', glbPath);
          currentModelContainer = await loadModelWithFreshness(glbPath, viewer, { autoCenter: true });
          
          // Kontynuuj normalny flow
          renderPartButtons();
          
          if (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
            const chairBounds = new Box3().setFromObject(currentModelContainer);
            currentModelContainer.position.y -= chairBounds.min.y;

            const legsVariants = allData.filter(d => d.Grupa.toLowerCase() === 'nogi');
            const defaultLeg = legsVariants.find(l => l.Nazwa.toLowerCase().includes('regularne')) || legsVariants[0];

            if (defaultLeg) {
              await setLegModel(defaultLeg);
            }

            document.getElementById('legs-section').style.display = 'block';
            activateLegsTabAndShowMaterials();
          } else {
            document.getElementById('legs-section').style.display = 'none';
          }
          
        } catch (error) {
          console.error('âŒ BÅ‚Ä…d Å‚adowania WebGL fallback:', error);
        }
      }
    }

    // ğŸ“± FUNKCJA WYKRYWANIA FORMATU MODELU
    function getModelFormat(modelName) {
      // Na iOS uÅ¼ywamy USDZ jeÅ›li dostÄ™pny, inaczej GLB
      if (window.isIOS) {
        console.log('ğŸ“± iOS wykryty - sprawdzam dostÄ™pnoÅ›Ä‡ USDZ dla:', modelName);
        return {
          primary: { path: `chairs/${modelName}.usdz`, format: 'usdz' },
          fallback: { path: `chairs/${modelName}.glb`, format: 'glb' }
        };
      } else {
        console.log('ğŸ–¥ï¸ Desktop/Android - uÅ¼ywam GLB dla:', modelName);
        return {
          primary: { path: `chairs/${modelName}.glb`, format: 'glb' },
          fallback: null
        };
      }
    }

    // ğŸ“± FUNKCJA SPRAWDZANIA DOSTÄ˜PNOÅšCI PLIKU
    async function checkFileExists(path) {
      try {
        const response = await fetch(path, { method: 'HEAD' });
        return response.ok;
      } catch (error) {
        console.warn('Nie moÅ¼na sprawdziÄ‡ pliku:', path, error);
        return false;
      }
    }

    async function loadModelWithFreshness(path, viewer, options = {}) {
      try {
        // Wykonaj zapytanie HEAD, aby pobraÄ‡ Last-Modified z serwera
        const res = await fetch(path, { method: 'HEAD' });
        const lastModified = res.headers.get('Last-Modified');

        // JeÅ›li data jest dostÄ™pna, uÅ¼yj jej jako wersji cache-bustera
        const version = lastModified ? new Date(lastModified).getTime() : Date.now();
        const pathWithVersion = `${path}?v=${version}`;

        // ZaÅ‚aduj model z cache-busterem
        const modelContainer = await viewer.load(pathWithVersion, options);
        return modelContainer;
      } catch (e) {
        console.error(`Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ modelu: ${path}`, e);
        throw e;
      }
    }



    async function init() {
      console.log('ğŸ iPhone debug - ROZPOCZÄ˜CIE FUNKCJI INIT');
      console.log('ğŸ iPhone debug - URL:', window.location.href);
      console.log('ğŸ iPhone debug - User Agent:', navigator.userAgent);
      console.log('ğŸ iPhone debug - Online:', navigator.onLine);
      
      // ğŸŒ™ INICJALIZUJ THEME TOGGLE NA POCZÄ„TKU
      initThemeToggle();
      
      // âœ… SPRAWDZANIE WEBGL DLA IPHONE
      const canvas = document.getElementById("canvas");
      
      console.log('ğŸ“± Device info:', {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        onLine: navigator.onLine,
        cookieEnabled: navigator.cookieEnabled
      });
      
      // SprawdÅº czy WebGL jest dostÄ™pne
      let gl;
      try {
        gl = canvas.getContext('webgl2') || canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      } catch (e) {
        console.error('WebGL nie jest dostÄ™pne:', e);
      }
      
      if (!gl) {
        console.error('âŒ WebGL nie jest obsÅ‚ugiwane przez tÄ™ przeglÄ…darkÄ™/urzÄ…dzenie');
        document.getElementById('custom-loader').innerHTML = `
          <img src="icons/FK_Logo.jpg" alt="Fajne KrzesÅ‚a" />
          <p style="color: red; text-align: center; margin-top: 20px;">
            Twoja przeglÄ…darka nie obsÅ‚uguje WebGL.<br>
            SprÃ³buj zaktualizowaÄ‡ przeglÄ…darkÄ™ lub uÅ¼yj innego urzÄ…dzenia.
          </p>
        `;
        return;
      }
      
      console.log('âœ… WebGL jest dostÄ™pne:', gl.getParameter(gl.VERSION));
      console.log('ğŸ® WebGL info:', {
        vendor: gl.getParameter(gl.VENDOR),
        renderer: gl.getParameter(gl.RENDERER),
        version: gl.getParameter(gl.VERSION),
        shadingLanguageVersion: gl.getParameter(gl.SHADING_LANGUAGE_VERSION)
      });
      
      // ğŸ“± SprawdÅº specjalne przypadki dla iOS Safari
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
      
      if (isIOS) {
        console.log('ğŸ“± Wykryto urzÄ…dzenie iOS - zastosowanie optymalizacji...');
        
        // SprawdÅº ograniczenia iOS
        const maxTextureSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);
        const maxRenderbufferSize = gl.getParameter(gl.MAX_RENDERBUFFER_SIZE);
        const maxViewportDims = gl.getParameter(gl.MAX_VIEWPORT_DIMS);
        
        console.log('ğŸ“± iOS limits:', {
          maxTextureSize,
          maxRenderbufferSize,
          maxViewportDims,
          memoryInfo: performance.memory || 'not available'
        });
        
        // Dostosuj canvas dla iOS
        const canvas = document.getElementById("canvas");
        canvas.style.touchAction = 'none'; // Zapobiegaj scroll na touch
        canvas.style.webkitTouchCallout = 'none'; // WyÅ‚Ä…cz menu kontekstowe
        canvas.style.webkitUserSelect = 'none'; // WyÅ‚Ä…cz selekcjÄ™ tekstu
      }

      try {
        console.log('ğŸš€ Inicjalizacja ThreeViewer...');
        viewer = new ThreeViewer({
          canvas: canvas,
          plugins: [ GBufferPlugin, SSAAPlugin, SSReflectionPlugin, BloomPlugin],
          rendererSettings: { 
            antialias: true,
            alpha: true,
            premultipliedAlpha: false,
            preserveDrawingBuffer: false,
            powerPreference: "high-performance"
          }
        });
        console.log('âœ… ThreeViewer zainicjalizowany');
      } catch (e) {
        console.error('âŒ BÅ‚Ä…d inicjalizacji ThreeViewer:', e);
        document.getElementById('custom-loader').innerHTML = `
          <img src="icons/FK_Logo.jpg" alt="Fajne KrzesÅ‚a" />
          <p style="color: red; text-align: center; margin-top: 20px;">
            BÅ‚Ä…d inicjalizacji 3D:<br>${e.message}<br><br>
            SprÃ³buj odÅ›wieÅ¼yÄ‡ stronÄ™
          </p>
        `;
        return;
      }
      if (viewer.controls) {
        viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
        viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
        viewer.controls.dampingFactor = 0.1;
        viewer.controls.enableDamping = true;
        // Dodaj nasÅ‚uchiwanie TUTAJ, po utworzeniu viewer i controls:
        viewer.controls.addEventListener('change', clampCameraDistance);
      }

      const collapseBtn = document.getElementById('collapse-btn');
      const overviewPanel = document.getElementById('config-overview');

      if (collapseBtn && overviewPanel) {
        collapseBtn.onclick = () => {
          overviewPanel.classList.toggle('collapsed');
          collapseBtn.textContent = overviewPanel.classList.contains('collapsed') ? '+' : 'âˆ’';
        };
      }

      const buyButton = document.getElementById('buy-button');
      if (buyButton) {
        buyButton.innerHTML = '<span class="cart-icon">ğŸ›’</span>Zapytaj o produkt';

        buyButton.onclick = () => {
          const summary = generateSummaryText();
          const emailAddress = 'mrpeter@o2.pl'; // adres docelowy

          const subject = `Zapytanie o wycenÄ™: ${selectedChair.Nazwa}`;
          const body = `DzieÅ„ dobry,\n\nProszÄ™ o wycenÄ™ poniÅ¼szej konfiguracji:\n\n${summary.text}\n-------------------\nSuma: ${summary.totalPrice.toFixed(2)} PLN\n\nPozdrawiam,\n[ImiÄ™ i nazwisko]`;

          console.log("Symulowana wysyÅ‚ka wiadomoÅ›ci:");
          console.log("Temat:", subject);
          console.log("TreÅ›Ä‡:", body);

          // Zamknij modal jeÅ›li otwarty
          const modal = document.getElementById('emailModal');
          if (modal) modal.classList.add('hidden');

          // PokaÅ¼ komunikat sukcesu (dodaj klasÄ™ visible i usuÅ„ hidden)
          const successMessage = document.getElementById('success-message');
          if (successMessage) {
            successMessage.classList.add('visible');
            successMessage.classList.remove('hidden');

            // Ukryj komunikat po 3 sekundach
            setTimeout(() => {
              successMessage.classList.remove('visible');
              successMessage.classList.add('hidden');
            }, 3500);
          } else {
            // JeÅ¼eli brak komunikatu, to od razu wywoÅ‚aj mailto
            window.location.href = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          }
        };
      }




      try {
        // âœ… TIMEOUT dla Å‚adowania HDR na iPhone
        const hdrPromise = viewer.setEnvironmentMap("hdr/hamburg_hbf_1k.hdr", { isHDR: true });
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('HDR loading timeout')), 10000)
        );
        
        await Promise.race([hdrPromise, timeoutPromise]);
        console.log('âœ… HDR zaÅ‚adowane pomyÅ›lnie');
      } catch (e) { 
        console.warn("âš ï¸ BÅ‚Ä…d Å‚adowania HDR (kontynuujemy bez HDR):", e);
        // Nie przerywamy Å‚adowania - kontynuujemy bez HDR
      }

      try {
        await loadCameraTarget();
        console.log('âœ… Camera target zaÅ‚adowany');
      } catch (e) {
        console.warn("âš ï¸ BÅ‚Ä…d Å‚adowania camera target:", e);
      }

      try {
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
        console.log('âœ… Canvas resize zainicjalizowany');
      } catch (e) {
        console.warn("âš ï¸ BÅ‚Ä…d inicjalizacji resize:", e);
      }

      try {
        // ğŸ“± MOBILE: timeout dla loadDataFromSheet
        if (window.isMobile) {
          console.log('ğŸ“± Mobile: KrÃ³tszy timeout dla loadDataFromSheet');
          
          const loadDataPromise = loadDataFromSheet();
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Mobile timeout')), 3000)
          );
          
          try {
            await Promise.race([loadDataPromise, timeoutPromise]);
            console.log('âœ… Dane z arkusza zaÅ‚adowane (mobile)');
          } catch (error) {
            console.warn('âš ï¸ Mobile timeout - uÅ¼ywam danych fallback:', error);
            await useFallbackData();
          }
        } else {
          // Desktop: normalny timeout
          await loadDataFromSheet();
          console.log('âœ… Dane z arkusza zaÅ‚adowane');
        }
        
        // ğŸ”§ DODAJ FUNKCJE DEBUGOWANIA POZYCJI KAMERY DO KONSOLI
        window.getCameraPosition = function() {
          if (viewer && viewer.scene && viewer.scene.activeCamera) {
            const camera = viewer.scene.activeCamera;
            const position = camera.position;
            const target = viewer.controls ? viewer.controls.target : 'brak controls';
            console.log('ğŸ“ POZYCJA KAMERY:');
            console.log(`Position: { x: ${position.x.toFixed(2)}, y: ${position.y.toFixed(2)}, z: ${position.z.toFixed(2)} }`);
            console.log(`Target:`, target);
            console.log('ğŸ“‹ SKOPIUJ DO KODU:');
            console.log(`const CAMERA_POSITION = { x: ${position.x.toFixed(2)}, y: ${position.y.toFixed(2)}, z: ${position.z.toFixed(2)} };`);
            return { position, target };
          } else {
            console.log('âŒ Kamera nie jest dostÄ™pna');
          }
        };
        
        window.setCameraPosition = function(x, y, z) {
          if (viewer && viewer.scene && viewer.scene.activeCamera) {
            viewer.scene.activeCamera.position.set(x, y, z);
            viewer.scene.activeCamera.updateProjectionMatrix();
            if (viewer.controls) viewer.controls.update();
            console.log(`âœ… Ustawiono pozycjÄ™ kamery na: x=${x}, y=${y}, z=${z}`);
          }
        };
        
        console.log('ğŸ”§ DOSTÄ˜PNE FUNKCJE DEBUGOWANIA:');
        console.log('ğŸ“ getCameraPosition() - pokaÅ¼ aktualnÄ… pozycjÄ™ kamery');
        console.log('ğŸ¯ setCameraPosition(x, y, z) - ustaw pozycjÄ™ kamery');
        console.log('ï¿½ï¸ checkViewport() - sprawdÅº wymiary canvas i viewport');
        console.log('ï¿½ğŸ’¡ PRZYKÅAD: setCameraPosition(-1.5, 0.76, 3.9)');
        
        // Funkcja debug viewport i canvas
        window.checkViewport = function() {
          const sidebar = document.getElementById("sidebar");
          const canvas = document.getElementById("canvas");
          const sidebarWidth = sidebar ? sidebar.offsetWidth : 0;
          console.log('=== VIEWPORT DEBUG ===');
          console.log('Window:', window.innerWidth, 'x', window.innerHeight);
          console.log('Sidebar width:', sidebarWidth);
          console.log('Canvas CSS:', canvas.style.width, 'x', canvas.style.height);
          console.log('Canvas actual:', canvas.width, 'x', canvas.height);
          console.log('Canvas position:', canvas.offsetLeft, canvas.offsetTop);
          const rect = canvas.getBoundingClientRect();
          console.log('Canvas viewport:', rect.width, 'x', rect.height, 'at', rect.left, rect.top);
          return { window: {w: window.innerWidth, h: window.innerHeight}, sidebar: sidebarWidth, canvas: rect };
        };

        // Funkcja debug toolbar
        window.checkToolbar = function() {
          const toolbar = document.getElementById('bottom-toolbar');
          const floating = document.getElementById('floating-toggle');
          console.log('=== TOOLBAR DEBUG ===');
          console.log('Toolbar display:', getComputedStyle(toolbar).display);
          console.log('Toolbar opacity:', getComputedStyle(toolbar).opacity);
          console.log('Toolbar transform:', getComputedStyle(toolbar).transform);
          console.log('Toolbar classes:', toolbar.className);
          console.log('Floating display:', getComputedStyle(floating).display);
          console.log('Window width:', window.innerWidth);
          console.log('Is mobile:', window.innerWidth <= 820);
        };
      } catch (e) {
        console.error("âŒ Krytyczny bÅ‚Ä…d Å‚adowania danych:", e);
        document.getElementById('custom-loader').innerHTML = `
          <img src="icons/FK_Logo.jpg" alt="Fajne KrzesÅ‚a" />
          <p style="color: red; text-align: center; margin-top: 20px;">
            BÅ‚Ä…d Å‚adowania danych konfiguracji.<br>
            SprawdÅº poÅ‚Ä…czenie z internetem i odÅ›wieÅ¼ stronÄ™.
          </p>
        `;
        return;
      }
      
      // âœ… WYWOÅAJ FUNKCJE INICJALIZACYJNE NA KOÅƒCU
      try {
        console.log('ğŸ”§ WywoÅ‚ujÄ™ funkcje inicjalizacyjne...');
        if (typeof setDefaultMaterialsFromSheet === 'function') {
          setDefaultMaterialsFromSheet();
        }
        if (typeof updateSummary === 'function') {
          updateSummary();
        }
        console.log('âœ… Funkcje inicjalizacyjne zakoÅ„czone');
      } catch (initError) {
        console.error('âŒ BÅ‚Ä…d funkcji inicjalizacyjnych:', initError);
      }
      
      // ğŸ“± DIAGNOZA LOADING SCREEN
      console.log('ğŸ” DIAGNOZA LOADING SCREEN:');
      const loader = document.getElementById('custom-loader');
      const app = document.getElementById('app');
      const welcomeScreen = document.getElementById('welcome-screen');
      
      console.log('ğŸ” Custom loader display:', loader ? getComputedStyle(loader).display : 'null');
      console.log('ğŸ” App visibility:', app ? app.classList.contains('visible') : 'null');
      console.log('ğŸ” Welcome screen display:', welcomeScreen ? getComputedStyle(welcomeScreen).display : 'null');
      console.log('ğŸ” Is mobile:', window.isMobile);
      console.log('ğŸ” Is iOS:', window.isIOS);
      
      // ğŸ“± FORCE HIDE LOADER NA MOBILE
      if (window.isMobile && loader) {
        console.log('ğŸ“± Wymuszam ukrycie loading screen na mobile');
        loader.style.display = 'none';
        
        if (app) {
          app.classList.add('visible');
          console.log('ğŸ“± App visible dodane');
        }
        
        if (welcomeScreen) {
          welcomeScreen.style.display = 'none';
          console.log('ğŸ“± Welcome screen ukryty');
        }
      }
    }

    function setCameraView(targetPosition) {
      const camera = viewer.scene.activeCamera;
      camera.fov = CAMERA_FOV;
      camera.near = CAMERA_NEAR;
      camera.far = CAMERA_FAR;
      camera.position.set(CAMERA_POSITION.x, CAMERA_POSITION.y, CAMERA_POSITION.z);

      // Ustaw target na wybranÄ… pozycjÄ™ (np. globalCameraTargetPosition)
      let center = globalCameraTargetPosition || new Vector3(0, 0, 0);
      camera.lookAt(center);
      camera.updateProjectionMatrix();

      // Ustawienia kontrolek: tylko ZOOM i OBRÃ“T
      if (viewer.controls) {
        viewer.controls.target.copy(center);
        viewer.controls.enableRotate = true;    // âœ… ObrÃ³t dozwolony
        viewer.controls.enablePan = false;      // ğŸš« PAN zablokowany
        viewer.controls.screenSpacePanning = false; // ğŸš« Dodatkowa blokada PAN
        viewer.controls.enableZoom = true;      // âœ… ZOOM dozwolony
        viewer.controls.enabled = true;
        viewer.controls.update();
      }
    }

    function resizeCanvas() {
      const sidebar = document.getElementById("sidebar");
      const sidebarWidth = sidebar ? sidebar.offsetWidth : 0;
      const canvas = document.getElementById("canvas");
      const width = window.innerWidth - sidebarWidth;
      const height = window.innerHeight;
      // Ustaw rozmiar CSS
      canvas.style.width = width + "px";
      canvas.style.height = height + "px";
      // Ustaw rozmiar atrybutÃ³w (dla WebGL)
      canvas.width = width;
      canvas.height = height;
      if (viewer && viewer.renderer && viewer.scene && viewer.scene.activeCamera) {
        viewer.renderer.setSize(width, height, false);
        viewer.scene.activeCamera.aspect = width / height;
        viewer.scene.activeCamera.updateProjectionMatrix();
      }
    }

    async function silentLoadModel(variant) {
      if (currentModelContainer) viewer.scene.remove(currentModelContainer);
      
      // ğŸ“± UÅ»YJ NOWEJ LOGIKI FORMATÃ“W RÃ“WNIEÅ» W SILENT LOAD
      const formatInfo = getModelFormat(variant.Nazwa);
      let modelPath = formatInfo.primary.path;
      
      // Na iOS: sprawdÅº USDZ, jeÅ›li nie ma to uÅ¼yj GLB (ale bez AR preview)
      if (window.isIOS && formatInfo.primary.format === 'usdz') {
        const usdzExists = await checkFileExists(formatInfo.primary.path);
        if (!usdzExists && formatInfo.fallback) {
          console.log('ğŸ“± Silent load: USDZ niedostÄ™pny, uÅ¼ywam GLB:', formatInfo.fallback.path);
          modelPath = formatInfo.fallback.path;
        } else if (usdzExists) {
          console.log('ğŸ“± Silent load: USDZ dostÄ™pny ale Å‚adujÄ™ GLB dla preview:', formatInfo.fallback.path);
          modelPath = formatInfo.fallback.path; // Dla silent load zawsze GLB
        }
      }
      
      currentModelContainer = await loadModelWithFreshness(modelPath, viewer, { autoCenter: true });

      console.log("Meshe w modelu:", currentModelContainer.children.map(obj => obj.name)); // <-- DODAJ TO TUTAJ
      //selectedChair = variant; // <-- DODAJ TO!

      
      // WyÅ›rodkuj kamerÄ™ na modelu
      const box = new Box3().setFromObject(currentModelContainer);
      const center = box.getCenter(new Vector3());
      setCameraView(center);
      currentModelContainer.position.sub(center);
      updateSummary();
      
    }
    
    // ğŸ¯ FUNKCJA POKAZUJÄ„CA UI PO PIERWSZYM WYBORZE KRZESÅA
    function showAfterFirstSelection() {
      console.log('ğŸ¯ PokazujÄ™ interfejs po wyborze krzesÅ‚a...');
      
      // Ukryj welcome screen
      const welcomeScreen = document.getElementById('welcome-screen');
      if (welcomeScreen && !welcomeScreen.classList.contains('hidden')) {
        welcomeScreen.classList.add('hidden');
        console.log('âœ… Welcome screen ukryty');
      }
      
      // PokaÅ¼ canvas 3D
      const canvas = document.getElementById('canvas');
      if (canvas && !canvas.classList.contains('visible')) {
        canvas.classList.add('visible');
        console.log('âœ… Canvas 3D pokazany');
      }
      
      // Sidebar juÅ¼ jest widoczny - nie trzeba go pokazywaÄ‡
      console.log('âœ… Sidebar juÅ¼ widoczny');
      
      // PokaÅ¼ panel podsumowania
      const configOverview = document.getElementById('config-overview');
      if (configOverview && !configOverview.classList.contains('visible')) {
        configOverview.classList.add('visible');
        configOverview.classList.remove('hidden'); // usuÅ„ takÅ¼e hidden
        console.log('âœ… Panel podsumowania pokazany');
      }
      
      // PokaÅ¼ dolny toolbar lub floating button na mobile
      const bottomToolbar = document.getElementById('bottom-toolbar');
      const floatingToggle = document.getElementById('floating-toggle');
      
      // Na desktop uÅ¼ywamy normalnej klasy .visible
      if (window.innerWidth > 820) {
        if (bottomToolbar && !bottomToolbar.classList.contains('visible')) {
          bottomToolbar.classList.add('visible');
          console.log('âœ… Dolny toolbar pokazany na desktop');
        }
      } else {
        // Na mobile uÅ¼ywamy .mobile-ready zamiast .visible
        if (bottomToolbar && !bottomToolbar.classList.contains('mobile-ready')) {
          bottomToolbar.classList.add('mobile-ready');
          console.log('âœ… Bottom toolbar mobile-ready');
        }
        if (floatingToggle) {
          floatingToggle.style.display = 'flex';
          console.log('âœ… Floating button pokazany na mobile');
        }
      }
      
      console.log('ğŸ‰ Interfejs w peÅ‚ni widoczny!');
    }

    async function loadModel(variant) {
      console.log("loadModel() wywoÅ‚ane!");
      
      // ğŸ¯ POKAÅ» WIDOK 3D PO PIERWSZYM WYBORZE KRZESÅA
      showAfterFirstSelection();
      
      if (currentModelContainer) {
        viewer.scene.remove(currentModelContainer);
        if (typeof currentModelContainer.dispose === 'function') currentModelContainer.dispose();
      }
      if (currentLegModel) {
        viewer.scene.remove(currentLegModel);
        if (typeof currentLegModel.dispose === 'function') currentLegModel.dispose();
      }
      currentModelContainer = null;
      currentLegModel = null;
      selectedLeg = null;
      selectedMaterials = {};

      document.getElementById('model-loader').style.display = 'flex';

  try {
    // ğŸ“± NOWA LOGIKA FORMATÃ“W - USDZ dla iOS, GLB dla reszty
    const formatInfo = getModelFormat(variant.Nazwa);
    selectedChair = variant;
    
    console.log('ğŸ“± Format info for', variant.Nazwa, ':', formatInfo);
    
    let modelPath = formatInfo.primary.path;
    let loadSuccess = false;
    
    // Na iOS: sprawdÅº czy USDZ istnieje, jeÅ›li nie to uÅ¼yj GLB
    if (window.isIOS && formatInfo.primary.format === 'usdz') {
      const usdzExists = await checkFileExists(formatInfo.primary.path);
      
      if (usdzExists) {
        console.log('ğŸ“± USDZ dostÄ™pny dla iOS:', formatInfo.primary.path);
        // Na iOS z USDZ pokazujemy AR Quick Look zamiast wczytywania do WebGL
        await showUSZDPreview(variant);
        loadSuccess = true;
      } else {
        console.log('ğŸ“± USDZ niedostÄ™pny, fallback na GLB:', formatInfo.fallback.path);
        modelPath = formatInfo.fallback.path;
      }
    }
    
    // JeÅ›li nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ USDZ lub nie jest iOS, Å‚aduj normalnie
    if (!loadSuccess) {
      console.log('ğŸ¨ Åadowanie modelu WebGL:', modelPath);
      currentModelContainer = await loadModelWithFreshness(modelPath, viewer, { autoCenter: true });
    }

    renderPartButtons(); // <-- PRZENIEÅš TUTAJ!

    // JeÅ›li kubeÅ‚ek, to ewentualnie zaÅ‚aduj domyÅ›lne nogi
    if (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
      const chairBounds = new Box3().setFromObject(currentModelContainer);
      currentModelContainer.position.y -= chairBounds.min.y;

      const legsVariants = allData.filter(d => d.Grupa.toLowerCase() === 'nogi');
      const defaultLeg = legsVariants.find(l => l.Nazwa.toLowerCase().includes('regularne')) || legsVariants[0];

      if (defaultLeg) {
        await setLegModel(defaultLeg);
      }

      document.getElementById('legs-section').style.display = 'block';
      activateLegsTabAndShowMaterials();
    } else {
      document.getElementById('legs-section').style.display = 'none';
      if (currentLegModel) {
        viewer.scene.remove(currentLegModel);
        currentLegModel = null;
        selectedLeg = null;
      }
    }

    // âœ… Dopiero teraz chowamy loader
    // âœ… Eleganckie ukrycie z fade-out
    document.getElementById('model-loader').classList.add('fade-out');
    setTimeout(() => {
      document.getElementById('model-loader').style.display = 'none';
      document.getElementById('model-loader').classList.remove('fade-out');
    }, 500);


    userInteracted = true;
    hideDimensions();

    // PokaÅ¼ sekcjÄ™ materiaÅ‚Ã³w nÃ³g
    document.getElementById('materials-section').style.display = 'block';

    // Wyrenderuj kafelki materiaÅ‚Ã³w nÃ³g
    const legsMaterials = allData.filter(d => d.Grupa.toLowerCase() === 'nogi');
    renderOptions('materials-thumbnails', legsMaterials, (item) => {
      setLegMaterial(item);
    });

    setCameraView(globalCameraTargetPosition);
    enforceZoomLimits();
    updateUI();
    showScreen('config');

  } catch (e) {
    console.error(`BÅÄ„D Å‚adowania modelu: ${e.message}`, e);
    // Ukryj loader nawet przy bÅ‚Ä™dzie
    document.getElementById('model-loader').style.display = 'none';
  }
}









    function createLegMaterial(legData) {
      const metalness = isNaN(parseFloat(legData.metalness)) ? 1 : parseFloat(legData.metalness);
      const roughness = isNaN(parseFloat(legData.roughness)) ? 0.1 : parseFloat(legData.roughness);
      const color = legData.color || '#FFFFFF';

      return new THREE.MeshStandardMaterial({
        color: new THREE.Color(color),
        metalness: metalness,
        roughness: roughness,
      });
    }
    
    function czyNogaPasujeDoKubeÅ‚ka(nogaVariant, kubelekNazwa) {
  const zgodneKubeÅ‚ki = (nogaVariant.DlaKubeÅ‚ka || '')
    .toLowerCase()
    .split(',')
    .map(k => k.trim());
  return zgodneKubeÅ‚ki.includes(kubelekNazwa.toLowerCase());
}


    async function setLegModel(variant) {
  userInteracted = true;
  console.log("WywoÅ‚anie setLegModel dla wariantu:", variant);

  // âœ… Sprawdzenie zgodnoÅ›ci kubeÅ‚ka z wariantem nÃ³g
  if (selectedChair && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
    const zgodneKubeÅ‚ki = (variant.DlaKubeÅ‚ka || '').toLowerCase().split(',').map(k => k.trim());
    const nazwaKubeÅ‚ka = selectedChair.Nazwa?.toLowerCase();
    if (!zgodneKubeÅ‚ki.includes(nazwaKubeÅ‚ka)) {
      console.warn(`âŒ Wariant nÃ³g "${variant.Nazwa}" nie pasuje do kubeÅ‚ka "${selectedChair.Nazwa}"`);
      return;
    }
  }


      console.log("WywoÅ‚anie setLegModel dla wariantu:", variant);
      const oldLegs = currentLegModel;
      try {
        const modelPath = `legs/${variant.Nazwa}.glb`;
        console.log("ÅadujÄ™ model nÃ³g z Å›cieÅ¼ki:", modelPath);
        const newLegs = await loadModelWithFreshness(modelPath, viewer, { autoCenter: false });


        const legBounds = new Box3().setFromObject(newLegs);
        const legHeight = legBounds.max.y - legBounds.min.y;

        if (currentModelContainer && selectedChair) {
          if (selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
            let height = parseFloat(variant.height) || legHeight;
            newLegs.position.y = -height;
            currentModelContainer.position.y = 0;
          } else {
            currentModelContainer.position.y = legHeight + VERTICAL_OFFSET;
            newLegs.position.y = 0;
          }
        }

        if (oldLegs) {
          viewer.scene.remove(oldLegs);
          if (typeof oldLegs.dispose === 'function') oldLegs.dispose();
        }
        viewer.scene.add(newLegs);
        currentLegModel = newLegs;
        selectedLeg = variant;
        renderFilteredMaterialOptions('legs'); // â¬…ï¸ to odÅ›wieÅ¼a widok kafelkÃ³w materiaÅ‚Ã³w nÃ³g
        updateMaterialTiles(); // â¬…ï¸ MUSI byÄ‡ tutaj!


        // OdÅ›wieÅ¼ listÄ™ nÃ³g, Å¼eby podÅ›wietliÄ‡ wybrany wariant
        const legs = allData
  .filter(d => d.Grupa.toLowerCase() === 'nogi')
  .filter(noga => {
    if (!selectedChair || selectedChair.Grupa.toLowerCase() !== 'kubeÅ‚ek') return true;
    return czyNogaPasujeDoKubeÅ‚ka(noga, selectedChair.Nazwa);
  });



// Ustaw pierwszÄ… nogÄ™ jeÅ›li jeszcze Å¼adna nie zostaÅ‚a wybrana
if (!selectedLeg && legs.length > 0) {
  setLegModel(legs[0]); // automatycznie ustawia pierwszÄ… pasujÄ…cÄ… nogÄ™
}
    renderOptions('legs-thumbnails', legs, item => {
  setLegModel(item);
});    



        updateSummary();

        // Wymuszenie odÅ›wieÅ¼enia sceny
        if (viewer.render) viewer.render();
      } catch (e) {
        console.error(`BÅÄ„D Å‚adowania nÃ³g: ${e.message}`, e);
      }
    }



    let forceRenderInterval;

    function triggerSceneRefresh() {
      if (viewer?.camera) {
        viewer.camera.position.x += 0.00001;
        viewer.camera.zoom += 0.0001; // â¬…ï¸ mikroskopijny zoom
        viewer.camera.updateProjectionMatrix();
      }
      if (viewer?.renderer?.info) {
        viewer.renderer.info.reset();
      }
      if (viewer?.render) viewer.render();
    }


    function startForceRender(duration = 2000) {
      clearInterval(forceRenderInterval);
      forceRenderInterval = setInterval(() => {
        triggerSceneRefresh();
      }, 100);

      setTimeout(() => {
        clearInterval(forceRenderInterval);
        console.log("ğŸ›‘ ZakoÅ„czono wymuszone odÅ›wieÅ¼anie");
      }, duration);
    }



    const textureLoader = new TextureLoader();

    

    if (
      selectedChair?.Grupa?.toLowerCase() === 'kubeÅ‚ek' &&
      variant.TargetMeshOrModel?.toLowerCase().includes('legs') &&
      variant.WariantModelu
    ) {
      // ğŸ‘‰ dla kubeÅ‚kÃ³w z podmianÄ… nÃ³g â€” zmieÅ„ model nÃ³g
      setLegModel(variant);
    } else if (
      selectedChair &&
      (selectedChair.Grupa.toLowerCase() !== 'kubeÅ‚ek' || !variant.WariantModelu)
    ) {
      // ğŸ‘‰ dla pozostaÅ‚ych krzeseÅ‚ bez wariantÃ³w nÃ³g â€” wyÅ›wietl materiaÅ‚y nÃ³g do wyboru
      showLegMaterialsForSimpleChairs(selectedChair);
    }

    // Funkcje preloadera â€“ wklej na gÃ³rze pliku JS (lub przed applyMaterial)
function showPreloader() {
  const el = document.getElementById('material-preloader');
  if (el) el.style.display = 'flex';
}
function hidePreloader() {
  const el = document.getElementById('material-preloader');
  if (el) el.style.display = 'none';
}

    function applyMaterialToMesh(variant, forcedMeshName) {
      const clone = { ...variant };
      clone.TargetMeshOrModel = forcedMeshName;
      console.log(`ğŸ¯ Przypisano '${clone.Nazwa}' tylko do mesh '${forcedMeshName}'`);
      applyMaterial(clone);
    }

    // Funkcja, ktÃ³ra wyÅ›wietla kafelki materiaÅ‚Ã³w nÃ³g dla prostych krzeseÅ‚
    function showLegMaterialsForSimpleChairs(chair) {
      const legsMaterialsContainer = document.getElementById('legs-thumbnails');
      // UsuÅ„ tylko kafelki materiaÅ‚Ã³w (pozostaw warianty nÃ³g)
      legsMaterialsContainer.querySelectorAll('.material-tile').forEach(tile => tile.remove());


      // Pobierz materiaÅ‚y nÃ³g dla danego krzesÅ‚a (przykÅ‚ad, wymaga dostosowania)
      const materials = getMaterialsForLegs(chair.defaultLegsId || 'default');

      materials.forEach(mat => {
        const tile = document.createElement('div');
        tile.className = 'material-tile';
        tile.textContent = mat.Nazwa;
        tile.style.backgroundImage = `url(${mat.Obrazek || 'fallback.png'})`;
        tile.onclick = () => {
          onLegVariantClick(mat.DlaModeliNÃ³g || mat.Nazwa);
          applyLegMaterial(mat);
        };

        legsMaterialsContainer.appendChild(tile);
      });
    }


    



// DOBRE PROGRESYWNE ÅADOWANIE MATERIAÅÃ“W!!!

async function applyMaterial(variant) {
  showPreloader();
  try {
    console.log('ğŸ“¦ variant:', variant);

    if (!currentModelContainer) {
      console.warn('currentModelContainer jest null lub undefined');
      hidePreloader();
      return;
    }

    if (!variant.TargetMeshOrModel) {
      console.warn('Brak TargetMeshOrModel w wariancie');
      hidePreloader();
      return;
    }

    const targetNames = variant.TargetMeshOrModel.split(',').map(name => name.trim());
    const isHex = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(variant.Color || variant.WartoÅ›Ä‡);
    const folderPath = (!isHex && variant.WartoÅ›Ä‡.startsWith('textures/')) ? variant.WartoÅ›Ä‡ : `textures/${variant.WartoÅ›Ä‡}`;

    // Progresywna obsÅ‚uga wielu meshÃ³w - loader znika dopiero po wszystkich meshach
    const meshPromises = targetNames.map(async (targetName) => {
      let container;
      if (targetName.toLowerCase() === 'legs') {
        if (selectedChair?.Grupa?.toLowerCase() === 'krzesÅ‚o' || !currentLegModel) {
          container = currentModelContainer;
        } else {
          container = currentLegModel;
        }
      } else {
        container = currentModelContainer;
      }

      let targetObject = null;
      container?.traverse(obj => {
        if (
          obj.isMesh &&
          obj.name &&
          obj.name.toLowerCase().trim() === targetName.toLowerCase().trim()
        ) {
          targetObject = obj;
        }
      });

      if (!targetObject) {
        console.warn(`âŒ Mesh '${targetName}' nie znaleziony w modelu`);
        return;
      }

      if (!targetObject.material) {
        console.warn(`âš ï¸ Mesh '${targetName}' nie ma materiaÅ‚u.`);
        return;
      }

      // Funkcja do bezpiecznego Å‚adowania tekstury (zwraca null, jeÅ›li nie uda siÄ™ zaÅ‚adowaÄ‡)
      async function loadTextureSafe(url) {
        try {
          const tex = await textureLoader.loadAsync(url);
          tex.magFilter = THREE.LinearFilter;
          tex.minFilter = THREE.LinearMipMapLinearFilter;
          tex.anisotropy = viewer?.renderer?.capabilities?.getMaxAnisotropy?.() || 4;
          tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
          tex.encoding = THREE.sRGBEncoding;
          tex.offset.set(0, 0);
          tex.repeat.set(1, 1);
          tex.needsUpdate = true;
          return tex;
        } catch {
          return null;
        }
      }

      if (isHex) {
        // JeÅ›li kolor HEX â€“ podmieÅ„ od razu (nie ma tekstur)
        const material = targetObject.material.clone();
        material.color.set(variant.Color || variant.WartoÅ›Ä‡);
        material.map = null;
        material.normalMap = null;
        material.roughnessMap = null;
        material.metalnessMap = null;
        material.needsUpdate = true;
        targetObject.material = material;
        viewer.render?.();
      } else if (folderPath && !/\.(jpg|jpeg|png|gif)$/i.test(folderPath)) {
        // --- PROGRESYWNE ÅADOWANIE ---

        // 1. Najpierw zaÅ‚aduj basecolor
        let baseColorTex = null;
        try {
          baseColorTex = await loadTextureSafe(`${folderPath}/baseColor.jpg`);
        } catch (err) {
          console.warn("BÅ‚Ä…d Å‚adowania baseColor:", err);
        }

        // 2. Skopiuj materiaÅ‚ i podepnij basecolor (lub null)
        const material = targetObject.material.clone();
        material.map = baseColorTex || null;
        material.color.set(0xffffff);
        material.normalMap = null;
        material.roughnessMap = null;
        material.metalnessMap = null;
        material.needsUpdate = true;

        // 3. Metalness i roughness z wariantu
        function parseValue(val, fallback) {
          const raw = (val || '')
            .toString()
            .trim()
            .replace(/['"]/g, '')
            .replace(',', '.');
          const parsed = parseFloat(raw);
          return !isNaN(parsed) ? parsed : fallback;
        }
        material.metalness = parseValue(variant.Metalness, 0);
        material.roughness = parseValue(variant.Roughness, 0.814);

        // 4. PodmieÅ„ materiaÅ‚ dopiero teraz (dopiero po basecolor)
        targetObject.material = material;
        if (targetObject.geometry?.computeVertexNormals) {
          targetObject.geometry.computeVertexNormals();
        }
        viewer.render?.();

        // 6. Progresywnie doÅ‚adowuj pozostaÅ‚e mapy i podmieniaj "w locie"
        loadTextureSafe(`${folderPath}/normal.jpg`).then(tex => {
          if (tex) {
            tex.encoding = THREE.LinearEncoding;
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            tex.offset.set(0, 0);
            tex.repeat.set(1.001, 1.001);
            material.normalMap = tex;
            material.needsUpdate = true;
            targetObject.material = material;
            viewer.render?.();
          }
        });

        loadTextureSafe(`${folderPath}/roughness.jpg`).then(tex => {
          if (tex) {
            tex.encoding = THREE.LinearEncoding;
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            tex.offset.set(0, 0);
            tex.repeat.set(1.001, 1.001);
            material.roughnessMap = tex;
            material.needsUpdate = true;
            targetObject.material = material;
            viewer.render?.();
          }
        });

        loadTextureSafe(`${folderPath}/metallic.jpg`).then(tex => {
          if (tex) {
            tex.encoding = THREE.LinearEncoding;
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            tex.offset.set(0, 0);
            tex.repeat.set(1.001, 1.001);
            material.metalnessMap = tex;
            material.needsUpdate = true;
            targetObject.material = material;
            viewer.render?.();
          }
        });

        console.log(`âœ… Progresywne Å‚adowanie tekstur na '${targetName}'`);
        console.log(`ğŸ§ª Metalness=${material.metalness}, Roughness=${material.roughness}`);
      }

      // ZapamiÄ™tanie wyboru i odÅ›wieÅ¼enie sceny
      selectedMaterials[targetName] = variant;
      if (targetName === 'legs' || targetName === 'legs_material') {
        selectedMaterials['legs_material'] = variant;
      }
    });

    await Promise.all(meshPromises); // czekaj aÅ¼ wszystkie meshe ogarnÄ… materiaÅ‚
hidePreloader();
    // ğŸ—‚ï¸ Automatycznie przypisz Folder do eksportu
    Object.entries(selectedMaterials).forEach(([key, mat]) => {
      if (!mat.Folder && typeof mat.WartoÅ›Ä‡ === 'string') {
        const parts = mat.WartoÅ›Ä‡.split('/');
        const last = parts[parts.length - 1];
        if (last && texturesFilesByFolder?.[last]) {
          mat.Folder = last;
          console.log(`ğŸ“ Dodano Folder='${last}' do '${key}'`);
        }
      }
    });

    viewer.scene.traverse(obj => {
      if (obj.isMesh && obj.material) {
        obj.material.needsUpdate = true;
      }
    });

    if (viewer?.camera) {
      viewer.camera.position.x += 0.00001;
      viewer.camera.updateProjectionMatrix();
    }

    if (viewer?.render) viewer.render();

    updateSummary();
  } catch (e) {
    hidePreloader();
    console.error("BÅ‚Ä…d w applyMaterial:", e);
  }
}

function applyMaterialToSpecificMesh(variant, meshKey) {
  const clone = { ...variant };
  clone.TargetMeshOrModel = meshKey;
  console.log(`ğŸ¯ Przypisano '${variant.Nazwa}' tylko do mesh '${meshKey}'`);
  applyMaterial(clone);
}

// DOBRE PROGRESYWNE ÅADOWANIE MATERIAÅÃ“W!!!





      function renderOptions(containerId, items, onSelect, isInteractive = true) {
        console.log(`ğŸ”„ renderOptions wywoÅ‚ane dla ${containerId} z ${items.length} elementami`);
        const container = document.getElementById(containerId);
        if (!container) {
          console.error(`âŒ Kontener ${containerId} nie istnieje!`);
          return;
        }
        console.log(`âœ… Kontener ${containerId} znaleziony`);
        container.innerHTML = '';
        items.forEach((item, index) => {
          console.log(`ğŸ”„ Tworzenie elementu ${index}: ${item.Nazwa || 'Brak nazwy'}`, item);
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          const button = document.createElement('div');
          button.className = 'thumbnail';
          button.title = item.Nazwa;

          // PODÅšWIETLENIE WYBRANEGO
          let isSelected = false;
          if (containerId === 'material-options') {
            if (item.Grupa && item.Grupa.toLowerCase() === 'materiaÅ‚y_nÃ³g') {
              isSelected = selectedMaterials['legs_material'] && selectedMaterials['legs_material'].Nazwa === item.Nazwa;
            } else if (item.TargetMeshOrModel) {
              const targets = item.TargetMeshOrModel.split(',').map(t => t.trim());
              isSelected = targets.some(t => selectedMaterials[t] && selectedMaterials[t].Nazwa === item.Nazwa);
            }
          } else if (containerId === 'legs-thumbnails') {
            isSelected = selectedLeg && selectedLeg.Nazwa === item.Nazwa;
          }
          if (isSelected) button.classList.add('selected');

          if (isInteractive) {
            button.addEventListener('click', () => {
              onSelect(item);
              container.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
              button.classList.add('selected');
            });
          }
          const img = document.createElement('img');
          // ğŸ”§ iPhone fix - popraw Å›cieÅ¼ki obrazkÃ³w
          let imageSrc = item.Obrazek || item.Image || item.icon || item.Icon || 'icons/placeholder.svg';
          
          // Normalizuj Å›cieÅ¼ki dla iPhone
          if (imageSrc.startsWith('./')) {
            imageSrc = imageSrc.substring(2);
          }
          if (!imageSrc.startsWith('http') && !imageSrc.startsWith('/')) {
            imageSrc = './' + imageSrc;
          }
          
          img.src = imageSrc && imageSrc.length > 4 ? imageSrc : './icons/placeholder.svg';
          img.alt = item.Nazwa || item.Name || 'Bez nazwy';
          console.log(`ğŸ–¼ï¸ Tworzenie obrazka dla ${img.alt}: ${img.src}`);
          button.appendChild(img);
          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = item.Nazwa;
          wrapper.appendChild(button);
          wrapper.appendChild(caption);
          container.appendChild(wrapper);
        });
      }





      function renderFilteredMaterialOptions(targetMesh) {
  if (!selectedChair || !selectedChair.Grupa) return;

  const grupa = selectedChair.Grupa.toLowerCase();

  function isAllowedForGroup(entryGroupDocelowa) {
    if (!entryGroupDocelowa) return false;
    const values = entryGroupDocelowa.toLowerCase().split(',').map(s => s.trim());
    return values.includes('wszystkie') || values.includes(grupa) || values.includes('kubeÅ‚ek, krzesÅ‚o');
  }

  let materialOptions = [];

  const isLegs = targetMesh === 'legs' || targetMesh === 'legs_material';

  if (isLegs) {
    materialOptions = allData.filter(d =>
      d.Grupa?.toLowerCase() === 'materiaÅ‚y_nÃ³g' &&
      isAllowedForGroup(d.GrupaDocelowa) &&
      d.Visible?.toLowerCase() !== 'false'
    );

    if (selectedLeg && selectedLeg.Typ) {
      materialOptions = materialOptions.filter(mat =>
        !mat.Typ || mat.Typ.toLowerCase().trim() === selectedLeg.Typ.toLowerCase().trim()
      );
    }

    if (selectedLeg && selectedLeg.Nazwa) {
      const currentLegName = selectedLeg.Nazwa.toLowerCase().trim();
      materialOptions = materialOptions.filter(mat => {
        const allowedLegs = mat.DlaModeluNÃ³g
          ? mat.DlaModeluNÃ³g.split(',').map(s => s.trim().toLowerCase())
          : [];
        return allowedLegs.length === 0 || allowedLegs.includes(currentLegName);
      });
    }

    if (selectedChair && selectedChair.Nazwa) {
  const currentChairName = selectedChair.Nazwa.toLowerCase().trim();
  materialOptions = materialOptions.filter(mat => {
    // â›”ï¸ JeÅ›li pole DlaKrzesÅ‚a jest puste â†’ odrzucamy
    if (!mat.DlaKrzesÅ‚a || mat.DlaKrzesÅ‚a.trim().length === 0) return false;

    const allowedChairs = mat.DlaKrzesÅ‚a
      .split(',')
      .map(s => s.trim().toLowerCase());

    return allowedChairs.includes(currentChairName);
  });
}



    const groupedByCollection = {};
    materialOptions.forEach(mat => {
      const key = mat.Kolekcja?.trim() || 'Inne';
      if (!groupedByCollection[key]) groupedByCollection[key] = [];
      groupedByCollection[key].push(mat);
    });

    renderCollectionsAndMaterials(groupedByCollection, 'legs');
    return;
  }

  // ğŸ§µ TKANINY (siedzisko, oparcie itd.)
  materialOptions = allData.filter(d =>
    d.Grupa?.toLowerCase() === 'tkanina' &&
    d.TargetMeshOrModel &&
    d.TargetMeshOrModel.split(',').map(t => t.trim()).includes(targetMesh) &&
    isAllowedForGroup(d.GrupaDocelowa) &&
    d.Visible?.toLowerCase() !== 'false'
  );

  const groupedByCollection = {};
  materialOptions.forEach(mat => {
    const key = mat.Kolekcja?.trim() || 'Inne';
    if (!groupedByCollection[key]) groupedByCollection[key] = [];
    groupedByCollection[key].push(mat);
  });

  renderCollectionsAndMaterials(groupedByCollection, targetMesh);
}

     




// âœ… Po wygenerowaniu â€” otwÃ³rz ostatnio klikniÄ™tÄ… kolekcjÄ™
if (lastOpenedCollection) {
  const toOpen = container.querySelector(`details[data-kolekcja="${lastOpenedCollection}"]`);
  if (toOpen) toOpen.open = true;
}












      function activateLegsTabAndShowMaterials() {
        // PodÅ›wietl zakÅ‚adkÄ™ "Nogi" po data-key
        const partTabs = document.querySelectorAll('#part-tabs .thumbnail');
        partTabs.forEach(tab => tab.classList.remove('selected'));
        partTabs.forEach(tab => {
          if (tab.dataset.key === 'legs') {
            tab.classList.add('selected');
          }
        });

        // PokaÅ¼ sekcjÄ™ materiaÅ‚Ã³w i wyÅ›wietl wszystkie materiaÅ‚y nÃ³g
        document.getElementById('materials-section').style.display = 'block';
        renderFilteredMaterialOptions('legs');

      }

      function renderPartTabs() {
        const container = document.getElementById('part-tabs');
        container.innerHTML = '';
        // Pobierz unikalne elementy do wyboru
        const allTargets = allData.filter(d => d.TargetMeshOrModel)
          .flatMap(d => d.TargetMeshOrModel.split(',').map(t => t.trim()));
        const uniqueTargets = [...new Set(allTargets)];
        if (uniqueTargets.length === 0) {
          document.getElementById('parts-section').style.display = 'none';
          return;
        }
        document.getElementById('parts-section').style.display = 'block';

        // Mapowanie nazw technicznych na polskie
        const POLISH_LABELS = {
          seat: 'Siedzisko',
          backseat_inside: 'Oparcie wew.',
          backseat_outside: 'Oparcie zew.',
          backseat: 'Siedzisko/Oparcie',
          legs: 'Nogi'
        };

        renderOptions('part-tabs', uniqueTargets.map(name => {
          const key = name.trim().toLowerCase();
          return {
            Nazwa: POLISH_LABELS[key] || name.trim(),
            Obrazek: ELEMENT_ICONS[key] || 'icons/placeholder.svg',
            _technicalKey: key
          };
        }), (item) => {
          if (item._technicalKey === 'legs') {
            activateLegsTabAndShowMaterials();
          } else {
            // PodÅ›wietl klikniÄ™tÄ… zakÅ‚adkÄ™
            const partTabs = document.querySelectorAll('#part-tabs .thumbnail');
            partTabs.forEach(tab => tab.classList.remove('selected'));
            partTabs.forEach(tab => {
              if (tab.title && tab.title.toLowerCase().includes(item.Nazwa.toLowerCase())) {
                tab.classList.add('selected');
              }
            });
            document.getElementById('materials-section').style.display = 'block';
            renderFilteredMaterialOptions(item._technicalKey);
          }
        });
      }

      function updateUI() {
        const backContainer = document.getElementById('back-to-models-container');
        backContainer.innerHTML = '';
        if (selectedChair && (selectedChair.Obrazek || selectedChair.Image)) {
          // StwÃ³rz ramkÄ™ z ikonkÄ… i X
          const btn = document.createElement('div');
          btn.className = 'back-to-model-btn';
          btn.title = 'WrÃ³Ä‡ do wyboru modelu';

          // Ikonka modelu
          const img = document.createElement('img');
          img.src = selectedChair.Obrazek || selectedChair.Image;
          img.alt = selectedChair.Nazwa;
          btn.appendChild(img);

          // Przycisk X w rogu
          const xBtn = document.createElement('button');
          xBtn.className = 'close-x';
          xBtn.innerHTML = '&times;';
          xBtn.title = 'WrÃ³Ä‡ do wyboru modelu';
          xBtn.onclick = (e) => {
            e.stopPropagation();
            showScreen('models');
          };
          btn.appendChild(xBtn);

          // KlikniÄ™cie w caÅ‚Ä… ramkÄ™ teÅ¼ wraca do wyboru modelu
          btn.onclick = () => showScreen('models');

          backContainer.appendChild(btn);
        }

        const legs = allData.filter(d => {
  if (d.Grupa.toLowerCase() !== 'nogi') return false;
  if (!selectedChair || selectedChair.Grupa.toLowerCase() !== 'kubeÅ‚ek') return true;
  return czyNogaPasujeDoKubeÅ‚ka(d, selectedChair.Nazwa);
});


        renderOptions('legs-thumbnails', legs, item => {
  setLegModel(item);
});



        // Sekcja nÃ³g i materiaÅ‚y nÃ³g â€“ nogi tylko dla kubeÅ‚kÃ³w, materiaÅ‚y dla kubeÅ‚kÃ³w i krzeseÅ‚
    if (selectedChair && selectedChair.Grupa) {    
          const grupa = selectedChair.Grupa.toLowerCase();

          if (grupa === 'kubeÅ‚ek') {
            console.log("PokazujÄ™ nogi i materiaÅ‚y nÃ³g dla kubeÅ‚ka");
            document.getElementById('legs-section').style.display = 'block';
            

            // Ustaw pierwszÄ… nogÄ™ jeÅ›li jeszcze Å¼adna nie zostaÅ‚a wybrana
if (!selectedLeg && legs.length > 0) {
  setLegModel(legs[0]); // automatycznie ustawia pierwszÄ… pasujÄ…cÄ… nogÄ™
}

renderOptions('legs-thumbnails', legs, item => {
              setLegModel(item);
            });

            // Ukryj sekcjÄ™ materiaÅ‚Ã³w, pokaÅ¼e siÄ™ po klikniÄ™ciu w zakÅ‚adkÄ™
            document.getElementById('materials-section').style.display = 'none';
          } else if (grupa === 'krzesÅ‚o') {
            console.log("Ukrywam sekcjÄ™ nÃ³g dla krzesÅ‚a");
            document.getElementById('legs-section').style.display = 'none';

            // Ukryj sekcjÄ™ materiaÅ‚Ã³w, pokaÅ¼e siÄ™ po klikniÄ™ciu w zakÅ‚adkÄ™
            document.getElementById('materials-section').style.display = 'none';
          } else {
            console.log("Ukrywam sekcje nÃ³g i materiaÅ‚Ã³w");
            document.getElementById('legs-section').style.display = 'none';
            document.getElementById('materials-section').style.display = 'none';
          }
        } else {
          console.log("Brak wybranego elementu lub grupy");
          document.getElementById('legs-section').style.display = 'none';
          document.getElementById('materials-section').style.display = 'none';
        }

        updateSummary();
      }

      const visibleData = allData.filter(d =>
        d.Visible?.toString().trim().length > 0
      );


      // âœ… FUNKCJE POMOCNICZE DLA DEBUGOWANIA
      
      // Funkcja sprawdzajÄ…ca Å‚Ä…cznoÅ›Ä‡ sieciowÄ…
      async function checkNetworkConnectivity() {
        console.log('ğŸŒ Sprawdzanie Å‚Ä…cznoÅ›ci sieciowej...');
        
        const testUrls = [
          'https://www.google.com/favicon.ico',
          'https://httpbin.org/get',
          'https://jsonplaceholder.typicode.com/posts/1'
        ];
        
        for (const url of testUrls) {
          try {
            const start = Date.now();
            const response = await fetch(url, { 
              method: 'HEAD', 
              mode: 'no-cors',
              cache: 'no-cache'
            });
            const duration = Date.now() - start;
            console.log(`âœ… ${url}: ${duration}ms`);
            return true;
          } catch (error) {
            console.log(`âŒ ${url}: ${error.message}`);
          }
        }
        return false;
      }
      
      // SprawdÅº Å‚Ä…cznoÅ›Ä‡ przed gÅ‚Ã³wnym Å‚adowaniem
      const hasNetwork = await checkNetworkConnectivity();
      if (!hasNetwork && !navigator.onLine) {
        console.warn('âš ï¸ Problemy z Å‚Ä…cznoÅ›ciÄ… sieciowÄ… wykryte');
        document.getElementById('custom-loader').innerHTML = `
          <img src="icons/FK_Logo.jpg" alt="Fajne KrzesÅ‚a" />
          <div style="color: orange; text-align: center; margin-top: 20px; font-size: 14px;">
            <p>âš ï¸ SÅ‚abe poÅ‚Ä…czenie internetowe</p>
            <p>Åadowanie moÅ¼e byÄ‡ wolniejsze...</p>
            <div style="margin-top: 15px;">
              <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #e3242b; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
          </div>
        `;
      }
      
      
      // ğŸ“± FALLBACK DATA FUNCTION
      async function useFallbackData() {
        console.log('ğŸ“± UÅ¼ywam danych fallback dla mobile');
        
        window.allData = [
          {
            Nazwa: 'Amy-2',
            Grupa: 'KrzesÅ‚o',
            Obrazek: './icons/chair_icon.png',
            Cena: '299.00',
            Visible: 'true'
          },
          {
            Nazwa: 'Ava',
            Grupa: 'KrzesÅ‚o',
            Obrazek: './icons/chair_icon.png',
            Cena: '349.00',
            Visible: 'true'
          },
          {
            Nazwa: 'Carine',
            Grupa: 'KrzesÅ‚o',
            Obrazek: './icons/chair_icon.png',
            Cena: '399.00',
            Visible: 'true'
          },
          {
            Nazwa: 'Soul',
            Grupa: 'KrzesÅ‚o',
            Obrazek: './icons/chair_icon.png',
            Cena: '459.00',
            Visible: 'true'
          },
          {
            Nazwa: 'Tulla-2',
            Grupa: 'KrzesÅ‚o',
            Obrazek: './icons/chair_icon.png',
            Cena: '389.00',
            Visible: 'true'
          },
          // MateriaÅ‚y
          {
            Nazwa: 'Brooklyn',
            Grupa: 'Tkanina',
            Obrazek: './icons/brooklyn.png',
            Color: '#8B4513',
            Visible: 'true'
          },
          {
            Nazwa: 'Leo',
            Grupa: 'Tkanina',
            Obrazek: './icons/leo.png',
            Color: '#2F4F4F',
            Visible: 'true'
          }
        ];
        
        // Ustaw globalne dane
        window.allData = window.allData;
        console.log('âœ… Fallback data zaÅ‚adowane:', window.allData.length, 'elementÃ³w');
        
        // WywoÅ‚aj funkcjÄ™ ktÃ³ra renderuje przyciski (jeÅ›li istnieje)
        if (typeof window.renderThumbnails === 'function') {
          window.renderThumbnails();
        } else {
          console.log('ğŸ“± renderThumbnails nie istnieje - dane gotowe do uÅ¼ycia');
        }
      }

      async function loadDataFromSheet() {
        console.log('ğŸ iPhone debug - ROZPOCZÄ˜CIE loadDataFromSheet');
        console.log('ğŸ iPhone debug - navigator.userAgent:', navigator.userAgent);
        console.log('ğŸ iPhone debug - window.location:', window.location.href);
        console.log('ğŸ iPhone debug - document.readyState:', document.readyState);
        
        const sheetId = '1vCs6YeHgKqlYwg8rvJOqVzNRnXeATJCBuK-zh3NNj78';
        const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Dane&v=${new Date().getTime()}`;
        
        try {
          console.log('ğŸ”„ Åadowanie danych z arkusza...');
          console.log('ğŸ“± User agent:', navigator.userAgent);
          console.log('ğŸ“¡ URL:', sheetURL);
          console.log('ğŸ iPhone debug - rozpoczÄ™cie pobierania danych...');
          
          let attemptCount = 0;
          const maxAttempts = 3;
          let lastError;
          
          while (attemptCount < maxAttempts) {
            attemptCount++;
            console.log(`ğŸ”„ PrÃ³ba ${attemptCount}/${maxAttempts}...`);
            
            try {
              // âœ… TIMEOUT dla fetch na iPhone - zwiÄ™kszony czas
              const fetchPromise = fetch(sheetURL + '?nocache=' + Date.now(), { 
                cache: 'no-store',
                mode: 'cors',
                headers: {
                  'Cache-Control': 'no-cache',
                  'Pragma': 'no-cache',
                  'Accept': 'text/csv,*/*'
                }
              });
              const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Fetch timeout - sprawdÅº poÅ‚Ä…czenie')), 15000 + (attemptCount * 5000))
              );
              
              const response = await Promise.race([fetchPromise, timeoutPromise]);
              console.log('ğŸ“¡ Response status:', response.status, response.statusText);
              
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              const csvText = await response.text();
              console.log('ğŸ“„ CSV length:', csvText.length);
              
              if (csvText.length < 100) {
                throw new Error('CSV data too short - moÅ¼liwe problemy z poÅ‚Ä…czeniem');
              }
              
              // Sukces - dane zaÅ‚adowane
              const rows = csvText.trim().split('\n');
              const headers = rows.shift().split(',').map(h => h.trim().replace(/"/g, ''));
              
              allData = rows.map(row => {
                const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                const obj = {};
                headers.forEach((header, index) => obj[header] = values[index]?.trim().replace(/"/g, '') || '');
                return obj;
              }).filter(item => item.Visible?.toLowerCase() !== 'false');

              console.log('âœ… Dane zaÅ‚adowane:', allData.length, 'elementÃ³w');
          console.log('ğŸ“Š PrzykÅ‚adowe dane:', allData.slice(0, 2));
          console.log('ğŸ“Š Wszystkie kolumny w pierwszym elemencie:', Object.keys(allData[0] || {}));
              break; // WyjdÅº z pÄ™tli - sukces!
              
            } catch (attemptError) {
              lastError = attemptError;
              console.error(`âŒ PrÃ³ba ${attemptCount} nieudana:`, attemptError.message);
              
              if (attemptCount >= maxAttempts) {
                throw lastError; // RzuÄ‡ ostatni bÅ‚Ä…d
              }
              
              // Czekaj przed kolejnÄ… prÃ³bÄ…
              const waitTime = attemptCount * 2000; // 2s, 4s, 6s
              console.log(`â±ï¸ Czekam ${waitTime/1000}s przed kolejnÄ… prÃ³bÄ…...`);
              await new Promise(resolve => setTimeout(resolve, waitTime));
            }
          }

          const mainModels = allData.filter(d => {
            const grupa = (d.Grupa || d.Group || d.grupa || '').toLowerCase();
            const typ = (d.Typ || d.Type || d.typ || '').toLowerCase();
            const kategoria = (d.Kategoria || d.Category || d.kategoria || '').toLowerCase();
            
            return ['krzesÅ‚o', 'kubeÅ‚ek', 'chair', 'bucket'].some(term => 
              grupa.includes(term) || typ.includes(term) || kategoria.includes(term)
            );
          });
          
          // ğŸ”§ ZAPISZ GLOBALNIE
          window.mainModels = mainModels;
          
          console.log('ğŸª‘ Modele gÅ‚Ã³wne:', mainModels.length);
          console.log('ğŸª‘ PrzykÅ‚adowe modele:', mainModels.slice(0, 3));
          
          // JeÅ›li nie ma gÅ‚Ã³wnych modeli, pokaÅ¼ wszystkie dane dla debugowania
          if (mainModels.length === 0) {
            console.warn('âš ï¸ Nie znaleziono gÅ‚Ã³wnych modeli! PokazujÄ™ wszystkie dane dla debugowania:');
            console.log('ğŸ“Š Wszystkie dane:', allData.slice(0, 5));
            console.log('ğŸ“Š DostÄ™pne grupy:', [...new Set(allData.map(d => d.Grupa).filter(Boolean))]);
          }
          
          // ğŸ“± MOBILE SIDEBAR - tylko dla mobile landscape
          const mobileChairsGrid = document.getElementById('mobile-chairs-grid');
          const mobileSidebar = document.getElementById('mobile-sidebar');
          
          // ğŸ”§ ZAWSZE POKAÅ» NA MOBILE LANDSCAPE (bez skÅ‚adanych warunkÃ³w)
          const isMobile = window.innerWidth <= 820 && window.innerWidth > window.innerHeight;
          // ğŸ”§ DEBUG: Force mobile sidebar on mobile devices regardless of orientation
          const isMobileDevice = window.innerWidth <= 820;
          const shouldShowMobile = isMobile || isMobileDevice; // Show if mobile landscape OR any mobile device
          
          console.log('ğŸ“± Mobile sidebar check:', {
            width: window.innerWidth,
            height: window.innerHeight,
            isMobile,
            isMobileDevice,
            shouldShowMobile,
            mobileChairsGrid: !!mobileChairsGrid,
            mobileSidebar: !!mobileSidebar,
            mainModelsLength: mainModels.length,
            allDataLength: allData.length,
            sampleMainModel: mainModels[0]?.Nazwa || 'brak'
          });
          
          if (shouldShowMobile && mobileChairsGrid && mobileSidebar) {
            console.log('ğŸ“± SHOWING MOBILE SIDEBAR');
            
            // ğŸ”§ POKAÅ» MOBILE SIDEBAR
            mobileSidebar.style.display = 'block';
            
            // ğŸ”§ POPULUJ KRZESÅA
            mobileChairsGrid.innerHTML = ''; // WyczyÅ›Ä‡
            
            if (mainModels.length > 0) {
              console.log('ğŸ“± Starting to populate mobile chairs...');
              mainModels.forEach((model, index) => {
                const chairItem = document.createElement('div');
                chairItem.className = 'mobile-chair-item';
                
                // Obrazek - absolutna Å›cieÅ¼ka
                let imagePath = model.Obrazek || model.Image || './icons/chair_icon.png';
                if (!imagePath.startsWith('http') && !imagePath.startsWith('./')) {
                  imagePath = './' + imagePath;
                }
                
                console.log(`ğŸ“± Adding chair ${index}: ${model.Nazwa}, image: ${imagePath}`);
                
                chairItem.innerHTML = `<img src="${imagePath}" alt="${model.Nazwa}" onerror="this.src='./icons/chair_icon.png';">`;
                
                // Klik
                chairItem.onclick = () => {
                  document.querySelectorAll('.mobile-chair-item').forEach(item => item.classList.remove('selected'));
                  chairItem.classList.add('selected');
                  loadModel(model);
                };
                
                mobileChairsGrid.appendChild(chairItem);
              });
              console.log('ğŸ“± Mobile sidebar populated with', mainModels.length, 'chairs');
            } else {
              console.log('ğŸ“± No mainModels to populate!');
            }
          } else {
            console.log('ğŸ“± Mobile sidebar HIDDEN:', { isMobile, mobileChairsGrid: !!mobileChairsGrid, mobileSidebar: !!mobileSidebar });
          }

          // ğŸ“± MOBILE LEGS - tylko dla mobile
          const mobileLegsGrid = document.getElementById('mobile-legs-grid');
          const mobileLegsSection = document.getElementById('mobile-legs-section');
          
          if (shouldShowMobile && mobileLegsGrid) {
            const legModels = allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'nogi');
            
            if (legModels.length > 0) {
              mobileLegsGrid.innerHTML = '';
              
              legModels.forEach((leg) => {
                const legItem = document.createElement('div');
                legItem.className = 'mobile-leg-item';
                
                let imagePath = leg.Obrazek || leg.Image || './icons/legs_icon.png';
                if (imagePath.startsWith('./')) imagePath = imagePath.substring(2);
                if (!imagePath.startsWith('http') && !imagePath.startsWith('/')) imagePath = './' + imagePath;
                
                legItem.innerHTML = `<img src="${imagePath}" alt="${leg.Nazwa}" onerror="this.src='./icons/legs_icon.png';">`;
                
                legItem.onclick = () => {
                  document.querySelectorAll('.mobile-leg-item').forEach(item => item.classList.remove('selected'));
                  legItem.classList.add('selected');
                  if (typeof setLegModel === 'function') setLegModel(leg);
                };
                
                mobileLegsGrid.appendChild(legItem);
              });
              
              console.log('ğŸ“± Mobile legs populated');
            }
          }
          
          // ğŸª‘ FALLBACK: Stary sidebar dla desktop lub gdy mobile panel nie dziaÅ‚a
          const modelContainer = document.getElementById('model-thumbnails');
          console.log('ğŸ iPhone debug - model container:', modelContainer);
          if (modelContainer) {
            modelContainer.innerHTML = ''; // WyczyÅ›Ä‡ kontener
            
            // JeÅ›li mamy dane, utwÃ³rz przyciski
            if (mainModels.length > 0) {
              console.log('ğŸª‘ Tworzenie przyciskÃ³w dla krzeseÅ‚...');
              console.log('ğŸ iPhone debug - bÄ™dzie tworzonych', mainModels.length, 'przyciskÃ³w');
              mainModels.forEach((model, index) => {
                console.log(`ğŸª‘ KrzesÅ‚o ${index + 1}:`, model.Nazwa, model);
                
                try {
                  const button = document.createElement('div');
                  button.className = 'thumbnail-wrapper';
                  
                  // ğŸ“± IPHONE FIX - bezwzglÄ™dne Å›cieÅ¼ki obrazÃ³w
                  let imagePath = model.Obrazek || model.Image || 'icons/placeholder.svg';
                  
                  // Popraw Å›cieÅ¼ki dla iPhone
                  if (imagePath.startsWith('./')) {
                    imagePath = imagePath.substring(2); // UsuÅ„ ./
                  }
                  if (!imagePath.startsWith('http') && !imagePath.startsWith('/')) {
                    imagePath = './' + imagePath; // Dodaj ./
                  }
                  
                  console.log(`ğŸ–¼ï¸ iPhone fix - obraz dla ${model.Nazwa}:`, imagePath);
                  
                  button.innerHTML = `
                    <div class="thumbnail" title="${model.Nazwa || 'KrzesÅ‚o'}">
                      <img src="${imagePath}" 
                           alt="${model.Nazwa || 'KrzesÅ‚o'}" 
                           onerror="console.log('âŒ iPhone bÅ‚Ä…d:', this.src); this.src='icons/chair_icon.png';"
                           onload="console.log('âœ… iPhone OK:', this.alt, this.src);">
                    </div>
                    <div class="thumbnail-caption">${model.Nazwa || 'KrzesÅ‚o'}</div>
                  `;
                  
                  // Dodaj klikniÄ™cie
                  button.querySelector('.thumbnail').onclick = () => {
                    console.log('ğŸ–±ï¸ KlikniÄ™to krzesÅ‚o:', model.Nazwa);
                    loadModel(model);
                  };
                  
                  modelContainer.appendChild(button);
                  console.log('ğŸ iPhone debug - przycisk', index + 1, 'dodany');
                } catch (buttonError) {
                  console.error('âŒ iPhone debug - bÅ‚Ä…d tworzenia przycisku', index + 1, ':', buttonError);
                }
              });
              console.log(`âœ… Utworzono ${mainModels.length} przyciskÃ³w krzeseÅ‚`);
              console.log('ğŸ iPhone debug - wszystkie przyciski utworzone');
            } else {
              console.warn('âš ï¸ Brak modeli krzeseÅ‚ do wyÅ›wietlenia');
              modelContainer.innerHTML = '<p style="color: #999; text-align: center;">Brak dostÄ™pnych krzeseÅ‚</p>';
            }
          } else {
            console.error('âŒ Nie znaleziono kontenera model-thumbnails');
            console.error('ğŸ iPhone debug - kontener model-thumbnails nie istnieje!');
          }
          
          // Zamiast renderOptions - uÅ¼ywamy prostej metody powyÅ¼ej
          // renderOptions('model-thumbnails', mainModels, item => loadModel(item));
          console.log('âœ… Przyciski krzeseÅ‚ utworzone');
          showScreen('models');

          const hdrEntries = allData.filter(d => d.HDR && d.HDRIcon);
          renderHDROptions(hdrEntries);

          // ğŸš« NIE ÅADUJ DOMYÅšLNEGO MODELU - pokaÅ¼e siÄ™ po wyborze krzesÅ‚a
          console.log('âœ… Dane zaÅ‚adowane, oczekujÄ™ na wybÃ³r krzesÅ‚a...');

          // âœ… UKRYJ LOADER I POKAÅ» WELCOME SCREEN
          console.log('ğŸ¯ Ukrywanie loadera, pokazujÄ™ welcome screen...');
          console.log('ğŸ iPhone debug - przed ukryciem loadera:', {
            loader: document.getElementById('custom-loader'),
            app: document.getElementById('app'),
            welcomeScreen: document.getElementById('welcome-screen'),
            sidebar: document.getElementById('sidebar')
          });
          
          // SprawdÅº czy elementy istniejÄ…
          const loader = document.getElementById('custom-loader');
          const app = document.getElementById('app');
          const welcomeScreen = document.getElementById('welcome-screen');
          
          if (!loader) console.error('âŒ Brak custom-loader');
          if (!app) console.error('âŒ Brak app');
          if (!welcomeScreen) console.error('âŒ Brak welcome-screen');
          
          if (loader) {
            loader.classList.add('fade-out');
            console.log('ğŸ iPhone debug - dodano fade-out do loadera');
          }
          
          setTimeout(() => {
            console.log('ğŸ iPhone debug - setTimeout callback wykonany');
            if (loader) {
              loader.style.display = 'none';
              console.log('ğŸ iPhone debug - loader ukryty');
            }
            if (app) {
              app.style.visibility = 'visible';
              app.classList.add('visible');
              console.log('ğŸ iPhone debug - app pokazany');
            }
            
            // Sidebar juÅ¼ jest widoczny dziÄ™ki CSS - nie trzeba go pokazywaÄ‡
            console.log('âœ… Sidebar juÅ¼ widoczny - moÅ¼na wybieraÄ‡ krzesÅ‚a');
            
            console.log('âœ… Loader ukryty, welcome screen widoczny');
            
            // DODAJ SZCZEGÃ“ÅOWE LOGOWANIE STANU KOÅƒCOWEGO DLA IPHONE
            console.log('ğŸ iPhone debug - STAN KOÅƒCOWY:');
            const finalLoader = document.getElementById('custom-loader');
            const finalApp = document.getElementById('app');
            const finalWelcome = document.getElementById('welcome-screen');
            const finalSidebar = document.getElementById('sidebar');
            
            console.log('ğŸ iPhone debug - finalLoader:', finalLoader);
            console.log('ğŸ iPhone debug - finalLoader display:', finalLoader?.style.display);
            console.log('ğŸ iPhone debug - finalLoader classList:', finalLoader?.classList.toString());
            
            console.log('ğŸ iPhone debug - finalApp:', finalApp);
            console.log('ğŸ iPhone debug - finalApp visibility:', finalApp?.style.visibility);
            console.log('ğŸ iPhone debug - finalApp classList:', finalApp?.classList.toString());
            
            console.log('ğŸ iPhone debug - finalWelcome:', finalWelcome);
            console.log('ğŸ iPhone debug - finalWelcome style:', finalWelcome?.style.cssText);
            
            console.log('ğŸ iPhone debug - finalSidebar:', finalSidebar);
            console.log('ğŸ iPhone debug - finalSidebar style:', finalSidebar?.style.cssText);
            console.log('ğŸ iPhone debug - finalSidebar classList:', finalSidebar?.classList.toString());
            
            // SprawdÅº czy loader jest rzeczywiÅ›cie niewidoczny
            if (finalLoader) {
              const loaderComputedStyle = window.getComputedStyle(finalLoader);
              console.log('ğŸ iPhone debug - loader computed display:', loaderComputedStyle.display);
              console.log('ğŸ iPhone debug - loader computed visibility:', loaderComputedStyle.visibility);
              console.log('ğŸ iPhone debug - loader computed opacity:', loaderComputedStyle.opacity);
            }
            
            // SprawdÅº czy welcome screen jest widoczny
            if (finalWelcome) {
              const welcomeComputedStyle = window.getComputedStyle(finalWelcome);
              console.log('ğŸ iPhone debug - welcome computed display:', welcomeComputedStyle.display);
              console.log('ğŸ iPhone debug - welcome computed visibility:', welcomeComputedStyle.visibility);
              console.log('ğŸ iPhone debug - welcome computed opacity:', welcomeComputedStyle.opacity);
              console.log('ğŸ iPhone debug - welcome computed z-index:', welcomeComputedStyle.zIndex);
            }
            
            console.log('ğŸ iPhone debug - KONIEC DEBUGOWANIA');
          }, 500);

          // ğŸš« NIE POKAZUJ TOOLBAR NA START - pokaÅ¼e siÄ™ po wyborze krzesÅ‚a

        } catch (e) { 
          console.error("âŒ BÅ‚Ä…d Å‚adowania danych:", e); 
          console.error("âŒ Stack trace:", e.stack);
          console.error("ğŸŒ Stan poÅ‚Ä…czenia:", {
            online: navigator.onLine,
            userAgent: navigator.userAgent,
            language: navigator.language,
            platform: navigator.platform
          });
          
          // SprawdÅº typ bÅ‚Ä™du i dostosuj komunikat
          let errorMessage = e.message;
          let troubleshootingTips = '';
          
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
          
          if (e.message.includes('timeout') || e.message.includes('network')) {
            errorMessage = isIOS ? 'Przekroczono czas Å‚adowania' : e.message;
            troubleshootingTips = isIOS ? `
              <br><small style="color: #666; font-size: 12px;">
                ğŸ <strong>Porady dla iPhone:</strong><br>
                â€¢ Zamknij inne karty w Safari<br>
                â€¢ SprawdÅº czy masz dobre WiFi/LTE<br>
                â€¢ SprÃ³buj tryb samolotowy ON/OFF<br>
                â€¢ Odczekaj 30s i sprÃ³buj ponownie
              </small>
            ` : `
              <br><small style="color: #666; font-size: 12px;">
                â€¢ SprawdÅº poÅ‚Ä…czenie Wi-Fi/komÃ³rkowe<br>
                â€¢ SprÃ³buj wyÅ‚Ä…czyÄ‡/wÅ‚Ä…czyÄ‡ WiFi<br>
                â€¢ PrzeÅ‚aduj stronÄ™ po 30 sekundach
              </small>
            `;
          } else if (e.message.includes('CORS') || e.message.includes('Access-Control')) {
            errorMessage = isIOS ? 'Problem z zabezpieczeniami Safari' : e.message;
            troubleshootingTips = isIOS ? `
              <br><small style="color: #666; font-size: 12px;">
                ğŸ <strong>RozwiÄ…zanie dla iPhone:</strong><br>
                â€¢ OtwÃ³rz Ustawienia â†’ Safari<br>
                â€¢ WyÅ‚Ä…cz "Zapobiegaj Å›ledzeniu miÄ™dzy witrynami"<br>
                â€¢ SprÃ³buj odÅ›wieÅ¼yÄ‡ stronÄ™<br>
                â€¢ Lub uÅ¼yj Chrome zamiast Safari
              </small>
            ` : `
              <br><small style="color: #666; font-size: 12px;">
                â€¢ Problemem moÅ¼e byÄ‡ blokada zabezpieczeÅ„<br>
                â€¢ SprÃ³buj odÅ›wieÅ¼yÄ‡ stronÄ™<br>
                â€¢ SprawdÅº czy Safari nie blokuje treÅ›ci
              </small>
            `;
          } else if (!navigator.onLine) {
            errorMessage = 'Brak poÅ‚Ä…czenia z internetem';
            troubleshootingTips = isIOS ? `
              <br><small style="color: #666; font-size: 12px;">
                ğŸ <strong>SprawdÅº na iPhone:</strong><br>
                â€¢ Ustawienia â†’ WiFi (czy jesteÅ› poÅ‚Ä…czony)<br>
                â€¢ Ustawienia â†’ KomÃ³rkowe â†’ Dane komÃ³rkowe<br>
                â€¢ Centrum kontroli â†’ sprawdÅº tryb samolotowy<br>
                â€¢ SprÃ³buj inne WiFi lub LTE
              </small>
            ` : `
              <br><small style="color: #666; font-size: 12px;">
                â€¢ SprawdÅº poÅ‚Ä…czenie Wi-Fi<br>
                â€¢ SprawdÅº poÅ‚Ä…czenie komÃ³rkowe<br>
                â€¢ SprÃ³buj ponownie gdy poÅ‚Ä…czenie wrÃ³ci
              </small>
            `;
          }
          
          // PokaÅ¼ szczegÃ³Å‚owy bÅ‚Ä…d w loaderze
          document.getElementById('custom-loader').innerHTML = `
            <img src="icons/FK_Logo.jpg" alt="Fajne KrzesÅ‚a" />
            <div style="color: red; text-align: center; margin-top: 20px; font-size: 14px; max-width: 300px; margin-left: auto; margin-right: auto;">
              <p>âŒ Problem z Å‚adowaniem:</p>
              <p><strong>${errorMessage}</strong></p>
              ${troubleshootingTips}
              <br>
              <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #e3242b; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                ğŸ”„ SprÃ³buj ponownie
              </button>
            </div>
          `;
          
          // ğŸš« NIE ÅADUJ FALLBACK MODELU - pokaÅ¼ tylko welcome screen
          console.log('âŒ BÅ‚Ä…d Å‚adowania danych - pokazujÄ™ welcome screen');
          
          throw e; // PrzekaÅ¼ bÅ‚Ä…d wyÅ¼ej
        }
        
        // ğŸ“± AKTUALIZUJ MOBILE SIDEBAR PO ZAÅADOWANIU DANYCH
        console.log('ğŸ“± Calling updateMobileSidebar after data load');
        updateMobileSidebar();
      }

      document.getElementById('hdr-toggle')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const panel = document.getElementById('hdr-panel');
        if (!panel) {
          console.warn('âš ï¸ Element hdr-panel nie istnieje');
          return;
        }
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden')) {
          panel.style.display = 'block';
        }
      });

      // ğŸ”§ MOBILE: Nowy system wysuwania bottom-toolbar z gesture detection
      let touchStartY = 0;
      let toolbarVisible = false;
      
      // Gesture detection dla wysuwania toolbar
      document.addEventListener('touchstart', (e) => {
        if (window.innerWidth > 820) return; // Tylko na mobile
        touchStartY = e.touches[0].clientY;
      });
      
      document.addEventListener('touchmove', (e) => {
        if (window.innerWidth > 820) return; // Tylko na mobile
        const touchY = e.touches[0].clientY;
        const deltaY = touchStartY - touchY;
        const toolbar = document.getElementById('bottom-toolbar');
        
        // JeÅ›li gesture w gÃ³rÄ™ od doÅ‚u ekranu i toolbar ukryty
        if (deltaY > 30 && touchStartY > window.innerHeight - 100 && !toolbarVisible) {
          showMobileToolbar();
        }
        // JeÅ›li gesture w dÃ³Å‚ i toolbar widoczny
        else if (deltaY < -30 && toolbarVisible) {
          hideMobileToolbar();
        }
      });

      function showMobileToolbar() {
        const toolbar = document.getElementById('bottom-toolbar');
        const floatingBtn = document.getElementById('floating-toggle');
        const toggleBtn = document.getElementById('toolbar-toggle');
        
        if (toolbar) {
          toolbar.classList.add('expanded');
          toolbar.classList.add('mobile-ready');
        }
        if (floatingBtn) floatingBtn.style.display = 'none';
        if (toggleBtn) toggleBtn.style.display = 'flex';
        toolbarVisible = true;
      }
      
      function hideMobileToolbar() {
        const toolbar = document.getElementById('bottom-toolbar');
        const floatingBtn = document.getElementById('floating-toggle');
        const toggleBtn = document.getElementById('toolbar-toggle');
        
        if (toolbar) toolbar.classList.remove('expanded');
        if (floatingBtn) floatingBtn.style.display = 'flex';
        if (toggleBtn) toggleBtn.style.display = 'none';
        toolbarVisible = false;
      }

      // Floating button - klikniÄ™cie teÅ¼ otwiera toolbar
      document.getElementById('floating-toggle')?.addEventListener('click', (e) => {
        e.stopPropagation();
        showMobileToolbar();
      });


// ğŸŒ™ DARK/LIGHT MODE FUNCTIONALITY - PRAWDZIWE CZARNO-BIAÅE IKONY
function initThemeToggle() {
  const themeToggle = document.getElementById('theme-toggle');
  if (!themeToggle) {
    console.error('âŒ Theme toggle button nie znaleziony');
    return;
  }
  
  // SprawdÅº zapisany motyw lub ustaw domyÅ›lny
  const savedTheme = localStorage.getItem('theme') || 'light';
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
    themeToggle.textContent = 'â˜€ï¸'; // ğŸ”§ Unicode czarno-biaÅ‚e sÅ‚oÅ„ce dla dark mode
  } else {
    themeToggle.textContent = 'â˜½'; // ğŸ”§ Unicode czarno-biaÅ‚y ksiÄ™Å¼yc dla light mode
  }
  
  // ObsÅ‚uga klikniÄ™cia
  themeToggle.addEventListener('click', () => {
    const isDark = document.body.classList.toggle('dark-mode');
    
    if (isDark) {
      themeToggle.textContent = 'â˜€ï¸'; // ğŸ”§ Unicode czarno-biaÅ‚e sÅ‚oÅ„ce
      localStorage.setItem('theme', 'dark');
      console.log('ğŸŒ™ PrzeÅ‚Ä…czono na dark mode');
    } else {
      themeToggle.textContent = 'â˜½'; // ğŸ”§ Unicode czarno-biaÅ‚y ksiÄ™Å¼yc
      localStorage.setItem('theme', 'light');
      console.log('â˜€ï¸ PrzeÅ‚Ä…czono na light mode');
    }
  });
  
  console.log('âœ… Theme toggle zainicjalizowany');
}




      function updateSummary() {
        const overviewPanel = document.getElementById('config-overview');
        const overviewIconsDiv = document.getElementById("overview-icons");
        const overviewDetailsDiv = document.getElementById("overview-details");
        const overviewTotalPriceSpan = document.getElementById("overview-total-price");

        overviewIconsDiv.innerHTML = '';
        overviewDetailsDiv.innerHTML = '';
        overviewTotalPriceSpan.textContent = `0.00 PLN`;

        // JeÅ›li nie byÅ‚o interakcji, nie pokazuj szczegÃ³Å‚Ã³w
        if (!userInteracted) {
          overviewPanel.style.display = 'block';
          return;
        }

        // KolejnoÅ›Ä‡ elementÃ³w do podsumowania
        const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'legs_material', 'backseat'];
        const partLabels = ['Siedzisko', 'Oparcie wew.', 'Oparcie zew.', 'Nogi', 'Siedzisko/Oparcie'];

        // Ikonka modelu
        if (userInteracted && selectedChair && (selectedChair.Obrazek || selectedChair.Image)) {
          const icon = document.createElement('img');
          icon.src = selectedChair.Obrazek || selectedChair.Image;
          icon.title = selectedChair.Nazwa;
          icon.className = 'model-image'; // <-- dodaj tÄ™ klasÄ™!
          overviewIconsDiv.appendChild(icon);
        }
        

        // Ikonki materiaÅ‚Ã³w dla kaÅ¼dego elementu
        partOrder.forEach((partKey, idx) => {
          const mats = selectedMaterials[partKey];
if (Array.isArray(mats)) {
  mats.forEach(mat => {
    if (mat && (mat.Obrazek || mat.Image)) {
      const icon = document.createElement('img');
      icon.src = mat.Obrazek || mat.Image;
      icon.title = mat.Nazwa;
      overviewIconsDiv.appendChild(icon);
    }
  });
} else if (mats && (mats.Obrazek || mats.Image)) {
  // ObsÅ‚uga starego trybu (pojedynczy materiaÅ‚)
  const icon = document.createElement('img');
  icon.src = mats.Obrazek || mats.Image;
  icon.title = mats.Nazwa;
  overviewIconsDiv.appendChild(icon);
}

        });

        // Ikonka wybranego wariantu nÃ³g (jeÅ›li jest)
        if (selectedLeg && (selectedLeg.Obrazek || selectedLeg.Image)) {
          const icon = document.createElement('img');
          icon.src = selectedLeg.Obrazek || selectedLeg.Image;
          icon.title = selectedLeg.Nazwa;
          overviewIconsDiv.appendChild(icon);
        }

        // SzczegÃ³Å‚y i ceny
        let totalPrice = 0;
        if (selectedChair && selectedChair.Cena) {
          const price = parseFloat(selectedChair.Cena) || 0;
          totalPrice += price;
          const detailLine = document.createElement('div');
          detailLine.className = 'detail-item';
          const label = (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'krzesÅ‚o') ? 'KrzesÅ‚o' : 'Model';
          detailLine.innerHTML = `<span>${label}: ${selectedChair.Nazwa}</span><strong>: ${price.toFixed(2)} PLN</strong>`;
          overviewDetailsDiv.appendChild(detailLine);
        }
        partOrder.forEach((partKey, idx) => {
          const mat = selectedMaterials[partKey];
          if (mat) {
            const price = parseFloat(mat.Cena) || 0;
            totalPrice += price;
            const detailLine = document.createElement('div');
            detailLine.className = 'detail-item';
            detailLine.innerHTML = `<span>${partLabels[idx]}: ${mat.Nazwa}</span><strong>: ${price.toFixed(2)} PLN</strong>`;
            overviewDetailsDiv.appendChild(detailLine);
          }
        });
        // Dodano szczegÃ³Å‚y wariantu nÃ³g
        if (selectedLeg) {
          const price = parseFloat(selectedLeg.Cena) || 0;
          const detailLine = document.createElement('div');
          detailLine.className = 'detail-item';
          detailLine.innerHTML = `<span>Wariant nÃ³g: ${selectedLeg.Nazwa}</span><strong>: ${price.toFixed(2)} PLN</strong>`;
          overviewDetailsDiv.appendChild(detailLine);
        }
        if (selectedLeg) {
          const price = parseFloat(selectedLeg.Cena) || 0;
          totalPrice += price;
        }

        const hr = document.createElement('hr');
        overviewDetailsDiv.appendChild(hr);

        overviewTotalPriceSpan.textContent = `${totalPrice.toFixed(2)} PLN`;



        window.selectedChair = selectedChair;
        window.selectedLeg = selectedLeg;
        window.selectedMaterials = selectedMaterials;

      }
     


      function enforceZoomLimits() {
        if (viewer && viewer.controls) {
          viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
          viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
          viewer.controls.enableDamping = true;
          viewer.controls.dampingFactor = 0.1;
          viewer.controls.update();
        }
      }

      function clampCameraDistance() {
        if (!viewer || !viewer.scene || !viewer.scene.activeCamera || !viewer.controls) return;
        const camera = viewer.scene.activeCamera;
        const target = viewer.controls.target;
        const pos = camera.position;
        const dist = pos.distanceTo(target);

        if (dist < MIN_ZOOM_DISTANCE) {
          // PrzesuÅ„ kamerÄ™ na sferÄ™ o promieniu MIN_ZOOM_DISTANCE od targetu
          const dir = pos.clone().sub(target).normalize();
          camera.position.copy(target.clone().add(dir.multiplyScalar(MIN_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          viewer.controls.update();
        }
        if (dist > MAX_ZOOM_DISTANCE) {
          // PrzesuÅ„ kamerÄ™ na sferÄ™ o promieniu MAX_ZOOM_DISTANCE od targetu
          const dir = pos.clone().sub(target).normalize();
          camera.position.copy(target.clone().add(dir.multiplyScalar(MAX_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          viewer.controls.update();
        }
      }


      // Nowa funkcja do ograniczeÅ„ zoomu w obrÄ™bie baÅ„ki
      function forceBubbleZoomLimitsEachFrame() {
        if (!viewer || !viewer.scene || !viewer.scene.activeCamera) return;
        const camera = viewer.scene.activeCamera;
        // Åšrodek baÅ„ki â€“ moÅ¼esz zmieniÄ‡ na inny punkt jeÅ›li trzeba
        const bubbleCenter = new Vector3(0, 0, 0);
        const pos = camera.position;
        const dist = pos.distanceTo(bubbleCenter);

        if (dist < MIN_ZOOM_DISTANCE) {
          const dir = pos.clone().sub(bubbleCenter).normalize();
          camera.position.copy(bubbleCenter.clone().add(dir.multiplyScalar(MIN_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          if (viewer.controls) viewer.controls.update();
        }
        if (dist > MAX_ZOOM_DISTANCE) {
          const dir = pos.clone().sub(bubbleCenter).normalize();
          camera.position.copy(bubbleCenter.clone().add(dir.multiplyScalar(MAX_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          if (viewer.controls) viewer.controls.update();
        }
      }

      // Uruchom sprawdzanie w kaÅ¼dej klatce
      function animateBubbleZoomLimit() {
        forceBubbleZoomLimitsEachFrame();
        requestAnimationFrame(animateBubbleZoomLimit);
      }
      animateBubbleZoomLimit();









      const exportButton = document.getElementById("export-config");
      const exportPanel = document.getElementById("export-panel");

      exportButton.addEventListener("click", () => {
        exportPanel.classList.toggle("hidden");
      });

      // Opcjonalnie â€“ ukrywanie po klikniÄ™ciu poza panelem
      document.addEventListener("click", (e) => {
        if (!exportPanel.contains(e.target) && !exportButton.contains(e.target)) {
          exportPanel.classList.add("hidden");
        }
      });

      // ObsÅ‚uga klikniÄ™Ä‡ eksportu (przykÅ‚adowo)
      document.querySelectorAll(".export-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const format = btn.dataset.format;
          alert(`Eksport jako: ${format.toUpperCase()}`);
          exportPanel.classList.add("hidden");
        });
      });




      // â€” ObsÅ‚uga dolnego paska narzÄ™dziowego HDR

      function renderHDROptions(entries) {
        const container = document.getElementById('hdr-options');
        if (!container) {
          console.warn('âš ï¸ Element hdr-options nie istnieje - pomijam renderowanie HDR');
          return;
        }
        container.innerHTML = '';

        entries.forEach(entry => {
          const img = document.createElement('img');
          img.src = entry.HDRIcon;
          img.alt = entry.Nazwa || entry.HDR;
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };

          const thumb = document.createElement('div');
          thumb.className = 'thumbnail';


          thumb.title = entry.Nazwa || entry.HDR;
          thumb.appendChild(img);
          thumb.onclick = () => {
            viewer.setEnvironmentMap(entry.HDR, { isHDR: true });
            document.getElementById('hdr-panel')?.classList.add('hidden');
          };

          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = entry.Nazwa || entry.HDR;

          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          wrapper.appendChild(thumb);
          //wrapper.appendChild(caption);

          container.appendChild(wrapper);
        });
      }



      // Sterowanie widocznoÅ›ciÄ… panelu

      // Sterowanie widocznoÅ›ciÄ… panelu
      window.addEventListener('DOMContentLoaded', () => {
        const hdrToggle = document.getElementById('hdr-toggle');
        const hdrPanel = document.getElementById('hdr-panel');
        const hdrClose = document.getElementById('hdr-close');

        function toggleHDRPanel() {
          hdrPanel.classList.toggle('hidden');
          hdrPanel.style.display = hdrPanel.classList.contains('hidden') ? 'none' : 'block';
        }

        hdrToggle?.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleHDRPanel();
        });

        hdrPanel?.addEventListener('click', (e) => {
          e.stopPropagation();
        });

        document.addEventListener('click', () => {
          const hdrPanel = document.getElementById('hdr-panel');
          if (hdrPanel) {
            hdrPanel.classList.add('hidden');
            hdrPanel.style.display = 'none';
          }
        });

        hdrClose?.addEventListener('click', (e) => {
          e.stopPropagation();
          const hdrPanel = document.getElementById('hdr-panel');
          if (hdrPanel) {
            hdrPanel.classList.add('hidden');
            hdrPanel.style.display = 'none';
          }
        });
      });

      // Modyfikacja istniejÄ…cego kodu obsÅ‚ugi przycisku HDR
      document.getElementById('hdr-toggle')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const panel = document.getElementById('hdr-panel');
        panel.classList.toggle('hidden');
        panel.style.display = panel.classList.contains('hidden') ? 'none' : 'block';
      });

















      // Panel wymiarÃ³w
      document.getElementById('dimensions-show')?.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log("ğŸ“ KlikniÄ™to przycisk wymiarÃ³w");
        showDimensions();
      });













      // ğŸ”§ Ukrywanie panelu
      document.getElementById('dimensions-show')?.addEventListener('click', () => {
        const overlay = document.getElementById('dimension-overlay');
        const labels = overlay.querySelectorAll('.dimension-label');

        // ğŸ§¾ Pobierz z arkusza
        const item = allData.find(i => {
          const g = (i.Grupa || '').toLowerCase();
          return (g === 'krzesÅ‚o' || g === 'kubeÅ‚ek') && i.Wymiary;
        });

        const dims = item?.Wymiary?.match(/x\s*=\s*(\d+[\.,]?\d*)\s*cm.*?y\s*=\s*(\d+[\.,]?\d*)\s*cm.*?z\s*=\s*(\d+[\.,]?\d*)\s*cm/i);

        if (dims) {
          labels[0].textContent = `x = ${dims[1]} cm`;
          labels[1].textContent = `y = ${dims[2]} cm`;
          labels[2].textContent = `z = ${dims[3]} cm`;
        }

        overlay.style.display = 'block';

        // â± Opcjonalnie ukryj po 6 sek.
        setTimeout(() => overlay.style.display = 'none', 6000);
      });







      window.addEventListener('load', () => {
        const showQRBtn = document.getElementById('qr-button');
        
        if (!showQRBtn) return;

        // PodÅ‚Ä…cz event do wyÅ›wietlenia kodu QR
        showQRBtn.addEventListener('click', () => {
          const qrPopup = document.getElementById('qr-popup');
          const qrContainer = document.getElementById('qrcode');
          if (!qrPopup || !qrContainer) return;

          qrPopup.style.display = 'block';
          qrContainer.innerHTML = '';

          new QRCode(qrContainer, {
            text: window.location.href,
            width: 200,
            height: 200,
          });
        });
      });

      function showConfigOverview() {
        const overviewPanel = document.getElementById('config-overview');
        overviewPanel.classList.remove('hidden');
      }

      // WywoÅ‚aj tÄ™ funkcjÄ™ w odpowiednim momencie, np. po zaÅ‚adowaniu modelu


      document.addEventListener('click', () => {
        const hdrPanel = document.getElementById('hdr-panel');
        if (hdrPanel) {
          hdrPanel.classList.add('hidden');
        }
      });



      function showDimensions() {
        const dimensionOverlay = document.getElementById('dimension-overlay');
        dimensionOverlay.style.display = 'block';
        dimensionOverlay.innerHTML = ''; // WyczyÅ›Ä‡ poprzednie wymiary

        if (!selectedChair) return;

        // Parsowanie wymiarÃ³w z kolumny Wymiary
        const dimensionsString = selectedChair.Wymiary || '';
        const dimensionsParsed = {};
        dimensionsString.split(',').forEach(dim => {
          const [key, value] = dim.split('=').map(s => s.trim());
          if (key && value) {
            dimensionsParsed[key.toLowerCase()] = parseFloat(value);
          }
        });

        const dimensions = [
          { label: 'SzerokoÅ›Ä‡', value: dimensionsParsed.x },
          { label: 'GÅ‚Ä™bokoÅ›Ä‡', value: dimensionsParsed.y },
          { label: 'WysokoÅ›Ä‡', value: dimensionsParsed.z }
        ];

        const panel = document.createElement('div');
        panel.className = 'dimension-panel';
        panel.style.cssText = `
  position: fixed;
  top: 85%;
  transform: translate(-150%, -50%);
  left: 50%;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 10px;
  border-radius: 5px;
  font-size: 14px;
  font-weight: bold;
  z-index: 1001;
`;


        dimensions.forEach(dim => {
          if (dim.value !== undefined) {
            const dimElement = document.createElement('div');
            dimElement.textContent = `${dim.label}: ${dim.value} cm`;
            dimElement.style.marginBottom = '5px';
            panel.appendChild(dimElement);
          }
        });

        dimensionOverlay.appendChild(panel);
      }

      function hideDimensions() {
        const dimensionOverlay = document.getElementById('dimension-overlay');
        dimensionOverlay.style.display = 'none';
      }



      // ğŸ“¦ Åadowanie JSZip
      async function loadJSZip() {
        if (!window.JSZip) {
          await import('https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js');
        }
      }

      // ğŸ“ ZaÅ‚aduj listÄ™ plikÃ³w tekstur z files.json
      let texturesFilesByFolder = {};
      async function loadTexturesFilesList() {
        try {
          const res = await fetch('textures/files.json');
          texturesFilesByFolder = await res.json();
        } catch (e) {
          console.error('BÅ‚Ä…d Å‚adowania files.json:', e);
          texturesFilesByFolder = {};
        }
      }

      // ğŸ“ ObsÅ‚ugiwane formaty eksportu
      const modelFormats = ['fbx', 'obj', 'dae'];

      // ğŸ—œï¸ GÅ‚Ã³wna funkcja eksportu ZIP
      async function handleExport(format) {
        if (!window.JSZip) {
          alert('JSZip niezaÅ‚adowany!');
          return;
        }

        if (!modelFormats.includes(format)) {
          alert(`NieobsÅ‚ugiwany format eksportu: ${format}`);
          return;
        }

        const zip = new JSZip();

        // ğŸª‘ Eksport gÅ‚Ã³wnego modelu krzesÅ‚a
        const chairModel = window.selectedChair?.Nazwa || 'BrakModelu';
        const chairPath = `export/${chairModel}.${format}`;

        try {
          const res = await fetch(chairPath);
          if (!res.ok) throw new Error(`Nie znaleziono modelu krzesÅ‚a: ${chairPath}`);
          const blob = await res.blob();
          zip.file(`${chairModel}.${format}`, blob);
        } catch (e) {
          alert(e.message);
          return;
        }

        // ğŸ¦µ Eksport nÃ³g (jeÅ›li wybrano)
        const legModel = window.selectedLeg?.Nazwa;
        if (legModel) {
          const legPath = `export/${legModel}.${format}`;
          try {
            const res = await fetch(legPath);
            if (res.ok) {
              const blob = await res.blob();
              zip.file(`${legModel}.${format}`, blob);
            } else {
              console.warn(`Nie znaleziono modelu nÃ³g: ${legPath}`);
            }
          } catch (e) {
            console.warn(`BÅ‚Ä…d pobierania nÃ³g: ${e.message}`);
          }
        }

        // ğŸ¨ Eksport materiaÅ‚Ã³w / tekstur z kolekcjÄ… i bez
        const textureFolderInZip = zip.folder('textures');
        const materials = Object.values(window.selectedMaterials || {});
        const collection = window.selectedChair?.Kolekcja?.trim() || '';

        for (const mat of materials) {
          const folder = mat.Folder || mat.WartoÅ›Ä‡;
          const textureFiles = texturesFilesByFolder[folder] || [];

          for (const texFile of textureFiles) {
            const candidatePaths = [
              collection ? `textures/${collection}/${folder}/${texFile}` : null,
              `textures/${folder}/${texFile}`
            ].filter(Boolean);

            let found = false;

            for (const path of candidatePaths) {
              try {
                const res = await fetch(path);
                if (res.ok) {
                  const blob = await res.blob();
                  textureFolderInZip.file(`${folder}/${texFile}`, blob);
                  found = true;
                  break;
                }
              } catch (e) {
                console.warn(`âŒ BÅ‚Ä…d pobierania: ${path}`, e);
              }
            }

            if (!found) {
              console.warn(`âš ï¸ Nie znaleziono tekstury: ${folder}/${texFile}`);
            }
          }
        }

        // ğŸ“¦ Finalny zapis ZIP
        const blob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `export_${chairModel}_${format}.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      }

      // ğŸš€ Inicjalizacja tekstur na starcie
      await loadTexturesFilesList();

      // ğŸ–±ï¸ ObsÅ‚uga klikniÄ™cia eksportu
      document.querySelectorAll('.export-btn').forEach(button => {
        button.addEventListener('click', async () => {
          await loadJSZip();
          const format = button.getAttribute('data-format');
          await handleExport(format);
        });
      });



      function updateMaterialTiles() {
        const legsMaterialsContainer = document.getElementById('legs-thumbnails');
        if (!legsMaterialsContainer || !selectedChair || !selectedLeg) return;

        // ğŸ§¼ CzyÅ›Ä‡ tylko kafelki materiaÅ‚Ã³w nÃ³g
        legsMaterialsContainer.querySelectorAll('.material-tile')?.forEach(tile => tile.remove());

        const allEntries = allData;

        const chairType = selectedChair.Grupa?.trim().toLowerCase();       // 'krzesÅ‚o' lub 'kubeÅ‚ek'
        const legVariant = selectedLeg.Nazwa?.trim().toLowerCase();       // np. 'regularne'

        const filteredMaterials = allEntries.filter(mat => {
          // âœ… tylko materiaÅ‚y nÃ³g
          if (mat.Grupa?.trim().toLowerCase() !== 'materiaÅ‚y_nÃ³g') return false;

          // âœ… czy materiaÅ‚ pasuje do typu krzesÅ‚a (GrupaDocelowa)
          const grupaDocelowa = mat.GrupaDocelowa?.toLowerCase() || '';
          const grupy = grupaDocelowa.split(',').map(g => g.trim());
          if (!grupy.includes(chairType)) return false;

          // âœ… jeÅ›li krzesÅ‚o â†’ ignorujemy DlaModeluNÃ³g
          if (chairType === 'krzesÅ‚o') return true;

          // âœ… jeÅ›li kubeÅ‚ek â†’ DlaModeluNÃ³g musi zawieraÄ‡ aktualny wariant nÃ³g
          const dlaModelu = mat.DlaModeluNÃ³g?.toLowerCase().trim();
          if (!dlaModelu || dlaModelu.length === 0) return false;

          const allowedVariants = dlaModelu.split(',').map(v => v.trim());
          return allowedVariants.includes(legVariant);
        });

        filteredMaterials.forEach(mat => {
          const tile = document.createElement('div');
          tile.className = 'material-tile';
          tile.textContent = mat.Nazwa;
          tile.style.backgroundImage = `url(${mat.Obrazek || 'fallback.png'})`;
          tile.onclick = () => applyLegMaterial(mat);
          legsMaterialsContainer.appendChild(tile);
        });

        console.log(`âœ… Pokazano ${filteredMaterials.length} materiaÅ‚Ã³w nÃ³g dla '${chairType}', wariant nÃ³g '${selectedLeg.Nazwa}'`);
      }





      //UKRYWANIE PRZYCISKÃ“W ELEMENTÃ“W KRZESÅA

      // kolejnoÅ›Ä‡ czÄ™Å›ci i ich powiÄ…zane nazwy meshÃ³w/obiektÃ³w
      const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'backseat', 'legs_material'];

      // funkcja tworzÄ…ca i wyÅ›wietlajÄ…ca przyciski czÄ™Å›ci krzesÅ‚a na podstawie danych wybranego krzesÅ‚a
      function renderPartButtons() {
        const partTabs = document.getElementById('part-tabs');
        partTabs.innerHTML = ''; // czyÅ›cimy zawartoÅ›Ä‡

        if (!selectedChair) {
          console.warn('renderPartButtons: brak wybranego krzesÅ‚a');
          return;
        }

        const availableElementsRaw = selectedChair['DostÄ™pneElementy'] || '';
        if (!availableElementsRaw.trim()) {
          console.log('renderPartButtons: brak dostÄ™pnych elementÃ³w â€” nie pokazujÄ™ nic.');
          return;
        }

        const availableParts = availableElementsRaw
          .split(',')
          .map(el => el.trim().toLowerCase())
          .filter(Boolean);

        const partNames = {
          seat: 'Siedzisko',
          backseat_inside: 'Oparcie wew.',
          backseat_outside: 'Oparcie zew.',
          backseat: 'Siedzisko/Oparcie',

          legs: 'Nogi'
        };

        Object.keys(ELEMENT_ICONS).forEach(part => {
          if (availableParts.includes(part)) {

            const wrapper = document.createElement('div');
            wrapper.className = 'thumbnail-wrapper';

            const thumb = document.createElement('div');
            thumb.className = 'thumbnail';
            thumb.title = part;
            thumb.dataset.key = part; // âœ… TO jest potrzebne dla dalszego UI

            thumb.onclick = () => {
              document.querySelectorAll('#part-tabs .thumbnail').forEach(tab => tab.classList.remove('selected'));
              thumb.classList.add('selected');
              document.getElementById('materials-section').style.display = 'block';

              // Pokazuje odpowiednie materiaÅ‚y do klikniÄ™tej czÄ™Å›ci
              renderFilteredMaterialOptions(part);
            };

            const img = document.createElement('img');
            img.src = ELEMENT_ICONS[part];
            img.alt = part;

            thumb.appendChild(img);
            wrapper.appendChild(thumb);

            const caption = document.createElement('div');
            caption.className = 'thumbnail-caption';
            caption.textContent = partNames[part] || part;
            wrapper.appendChild(caption);

            partTabs.appendChild(wrapper);
          }
        });
      }




      




      const arButton = document.getElementById('ar-button');
      if (arButton) {
        arButton.addEventListener('click', () => {
          const popup = document.getElementById('ar-popup');
          if (popup) popup.style.display = 'block';
        });
      }


const activeCollectionsByMesh = {};
const materialsByMeshAndCollection = {};

function renderCollectionsAndMaterials(groupedByCollection, targetMesh) {
  // â±ï¸ Zapisz dane materiaÅ‚Ã³w dla danego elementu
  materialsByMeshAndCollection[targetMesh] = groupedByCollection;

  const iconPanel = document.getElementById('collection-icons');
  const materialPanel = document.getElementById('material-panel-viewer');
  if (!iconPanel || !materialPanel) return;

  iconPanel.innerHTML = '';
  materialPanel.innerHTML = '';

  Object.entries(groupedByCollection).forEach(([kolekcja, materiaÅ‚y]) => {
    const icon = document.createElement('img');

    // ğŸ¯ Ikony specjalne dla 'legs' i 'backseat'
    let iconFileName = kolekcja.trim().toLowerCase().replace(/\s+/g, '_');

const basePath = `icons/${iconFileName}.png`;

fetch(basePath, { method: 'HEAD' })
  .then(res => {
    icon.src = res.ok ? basePath : 'icons/default.png';
  })
  .catch(() => {
    icon.src = 'icons/default.png';
  });




    icon.alt = kolekcja;
    icon.className = 'collection-icon';

    icon.onclick = () => {
      const isActive = activeCollectionsByMesh[targetMesh] === kolekcja;
      iconPanel.querySelectorAll('.collection-icon').forEach(i => i.classList.remove('selected'));

      if (isActive) {
        activeCollectionsByMesh[targetMesh] = null;
        materialPanel.innerHTML = '';
        return;
      }

      activeCollectionsByMesh[targetMesh] = kolekcja;
      icon.classList.add('selected');
      materialPanel.innerHTML = '';
      renderMaterialsInPanel(materiaÅ‚y, targetMesh);
    };

    iconPanel.appendChild(icon);
  });

  // âœ… Automatyczne otwarcie zapamiÄ™tanej kolekcji
  const rememberedCollection = activeCollectionsByMesh[targetMesh];
  const rememberedGroup = materialsByMeshAndCollection[targetMesh] || {};
  const rememberedMaterials = rememberedGroup[rememberedCollection];

  if (rememberedCollection && rememberedMaterials?.length) {
    const rememberedIcon = [...iconPanel.querySelectorAll('.collection-icon')].find(
      i => i.alt === rememberedCollection
    );
    if (rememberedIcon) {
      rememberedIcon.classList.add('selected');
      renderMaterialsInPanel(rememberedMaterials, targetMesh);
    }
  }
}









function renderMaterialsInPanel(materiaÅ‚y, targetMesh) {
  const viewer = document.getElementById('material-panel-viewer');
  if (!viewer) return;
  viewer.innerHTML = '';

  materiaÅ‚y.forEach(mat => {
    const wrapper = document.createElement('div');
    wrapper.className = 'thumbnail-wrapper';

    const button = document.createElement('div');
    button.className = 'thumbnail';
    button.title = mat.Nazwa;

    const img = document.createElement('img');
    img.src = mat.Obrazek || 'icons/placeholder.svg';
    img.alt = mat.Nazwa;
    button.appendChild(img);

    const caption = document.createElement('div');
    caption.className = 'thumbnail-caption';
    caption.textContent = mat.Nazwa;

    wrapper.appendChild(button);
    wrapper.appendChild(caption);
    viewer.appendChild(wrapper);

    button.onclick = () => {
      applyMaterialToSpecificMesh(mat, targetMesh);
      viewer.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
      button.classList.add('selected');
    };
  });
}



 window.addEventListener('orientationchange', () => {
    const rotateMsg = document.getElementById('rotate-message');
    if (!rotateMsg) return;

    // âœ… JeÅ›li poziomo â€” chowaj komunikat
    if (window.innerWidth > window.innerHeight) {
      rotateMsg.style.display = 'none';
    } else {
      rotateMsg.style.display = 'flex';
    }
  });

  // âœ… Dodatkowy test przy starcie â€” gdy strona Å‚aduje siÄ™ w pionie
  window.addEventListener('load', () => {
    const rotateMsg = document.getElementById('rotate-message');
    if (!rotateMsg) return;

    if (window.innerWidth > window.innerHeight) {
      rotateMsg.style.display = 'none';
    } else {
      rotateMsg.style.display = 'flex';
    }
  });


function updateRotateMessage() {
  const rotateMsg = document.getElementById('rotate-message');
  if (!rotateMsg) return;

  const isLandscape = window.innerWidth > window.innerHeight;
  rotateMsg.style.display = isLandscape ? 'none' : 'flex';
}

window.addEventListener('orientationchange', updateRotateMessage);
window.addEventListener('resize', updateRotateMessage);
window.addEventListener('load', updateRotateMessage);


function checkOrientation() {
  const rotateMsg = document.getElementById('rotate-message');
  if (!rotateMsg) return;

  const isLandscape = window.innerWidth > window.innerHeight;
  rotateMsg.style.display = isLandscape ? 'none' : 'flex';
  
  // ğŸ“± UPDATE MOBILE SIDEBAR ON ORIENTATION CHANGE
  updateMobileSidebar();
}

// ğŸ“± FUNKCJA DO AKTUALIZACJI MOBILE SIDEBAR
function updateMobileSidebar() {
  const mobileChairsGrid = document.getElementById('mobile-chairs-grid');
  const mobileSidebar = document.getElementById('mobile-sidebar');
  const isMobile = window.innerWidth <= 820 && window.innerWidth > window.innerHeight;
  const isMobileDevice = window.innerWidth <= 820;
  const shouldShowMobile = isMobile || isMobileDevice; // Show if mobile landscape OR any mobile device
  
  console.log('ğŸ“± updateMobileSidebar called:', {
    width: window.innerWidth,
    height: window.innerHeight,
    isMobile,
    isMobileDevice,
    shouldShowMobile,
    mobileChairsGrid: !!mobileChairsGrid,
    mobileSidebar: !!mobileSidebar
  });
  
  if (shouldShowMobile && mobileChairsGrid && mobileSidebar) {
    console.log('ğŸ“± Showing mobile sidebar in updateMobileSidebar');
    mobileSidebar.style.display = 'block';
    
    // JeÅ›li jest pusty, sprÃ³buj ponownie zaÅ‚adowaÄ‡ dane
    if (mobileChairsGrid.children.length === 0 && window.mainModels && window.mainModels.length > 0) {
      console.log('ğŸ“± Re-populating mobile sidebar with', window.mainModels.length, 'chairs');
      window.mainModels.forEach((model, index) => {
        const chairItem = document.createElement('div');
        chairItem.className = 'mobile-chair-item';
        
        let imagePath = model.Obrazek || model.Image || './icons/chair_icon.png';
        if (!imagePath.startsWith('http') && !imagePath.startsWith('./')) {
          imagePath = './' + imagePath;
        }
        
        chairItem.innerHTML = `<img src="${imagePath}" alt="${model.Nazwa}" onerror="this.src='./icons/chair_icon.png';">`;
        
        chairItem.onclick = () => {
          document.querySelectorAll('.mobile-chair-item').forEach(item => item.classList.remove('selected'));
          chairItem.classList.add('selected');
          loadModel(model);
        };
        
        mobileChairsGrid.appendChild(chairItem);
      });
    }
  } else {
    console.log('ğŸ“± Hiding mobile sidebar in updateMobileSidebar');
    if (mobileSidebar) mobileSidebar.style.display = 'none';
  }
}

window.addEventListener('load', checkOrientation);
window.addEventListener('resize', checkOrientation);



window.addEventListener('DOMContentLoaded', () => {
  // przygotowanie canvas i kontenerÃ³w
  console.log('ğŸ“± DOMContentLoaded - calling updateMobileSidebar');
  updateMobileSidebar();
  
  // ğŸ“± SprawdÅº ponownie po zaÅ‚adowaniu danych (delayed check)
  setTimeout(() => {
    console.log('ğŸ“± Delayed mobile sidebar check');
    updateMobileSidebar();
  }, 2000);
});


function setDefaultMaterialsFromSheet() {
  if (!Array.isArray(allData) || !window.selectedChair || !window.selectedChair.Nazwa) return;

  const modelName = window.selectedChair.Nazwa.trim().toLowerCase();
  if (typeof window.selectedMaterials !== 'object') window.selectedMaterials = {};

  allData.forEach(row => {
    const modelMatch = row.Default?.trim()?.toLowerCase(); // <-- DODAJEMY ?.
    const targetRaw = row.TargetMeshOrObiect?.trim()?.toLowerCase(); // <-- DODAJEMY ?.
    const name = row.Nazwa?.trim(); // <-- DODAJEMY ?.
    const price = parseFloat(row.Cena) || 0;
    const image = row.Obrazek || row.Image || '';

    if (!modelMatch || modelMatch !== modelName || !name || !targetRaw) return;

    if (!selectedMaterials[targetRaw]) selectedMaterials[targetRaw] = [];

    selectedMaterials[targetRaw].push({
      Nazwa: name,
      Cena: price,
      Obrazek: image
    });
  });
}




const hdrToggle = document.getElementById('hdr-toggle');
const brightnessControl = document.getElementById('brightness-control');

if (hdrToggle && brightnessControl) {
  hdrToggle.addEventListener('click', (e) => {
    e.stopPropagation(); // zatrzymaj propagacjÄ™ klikniÄ™cia
    const isVisible = brightnessControl.style.display === 'flex';
    brightnessControl.style.display = isVisible ? 'none' : 'flex';
  });

  // Zapobiegaj zamykaniu paska po klikniÄ™ciu w niego
  brightnessControl.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // ObsÅ‚uga suwaka jasnoÅ›ci
  const brightnessSlider = document.getElementById('brightness-slider');
  if (brightnessSlider) {
    brightnessSlider.addEventListener('input', (e) => {
      const intensity = parseFloat(e.target.value);
      
      // PrÃ³buj rÃ³Å¼ne sposoby ustawienia jasnoÅ›ci Å›rodowiska
      if (viewer && viewer.scene) {
        // Metoda 1: Ustawienie intensywnoÅ›ci Å›rodowiska bezpoÅ›rednio
        if (viewer.scene.environment && viewer.scene.environment.intensity !== undefined) {
          viewer.scene.environment.intensity = intensity;
        }
        
        // Metoda 2: Ustawienie intensywnoÅ›ci poprzez scene
        if (viewer.scene.environmentIntensity !== undefined) {
          viewer.scene.environmentIntensity = intensity;
        }
        
        // Metoda 3: Ustawienie intensywnoÅ›ci wszystkich Å›wiateÅ‚ Å›rodowiska
        if (viewer.scene.children) {
          viewer.scene.children.forEach(child => {
            if (child.isLight && child.intensity !== undefined) {
              child.intensity = intensity;
            }
          });
        }
        
        // Metoda 4: WebGI specific - moÅ¼e mieÄ‡ wÅ‚asne API
        if (viewer.setEnvironmentIntensity) {
          viewer.setEnvironmentIntensity(intensity);
        }
        
        console.log('Ustawiono jasnoÅ›Ä‡ na:', intensity);
      }
    });
  }

  // Ukryj suwak, gdy klikniesz poza lampkÄ… i poza suwakiem
  document.addEventListener('click', (e) => {
    if (!hdrToggle.contains(e.target) && !brightnessControl.contains(e.target)) {
      brightnessControl.style.display = 'none';
    }
  });
}





      console.log('ğŸ iPhone debug - OCZEKIWANIE NA DOM...');
      console.log('ğŸ iPhone debug - DOM ready state:', document.readyState);
      
      // âœ… WÅAÅšCIWE WYWOÅANIE INIT() PO ZAÅADOWANIU DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          console.log('ğŸ iPhone debug - DOM LOADED - WYWOÅANIE INIT()');
          init();
          initEventListeners(); // âœ… WywoÅ‚aj po zaÅ‚adowaniu DOM
        });
      } else {
        console.log('ğŸ iPhone debug - DOM JUÅ» GOTOWY - WYWOÅANIE INIT()');
        init();
        initEventListeners(); // âœ… WywoÅ‚aj po zaÅ‚adowaniu DOM
      }

      // âœ… FUNKCJA INICJALIZUJÄ„CA EVENT LISTENERY
      function initEventListeners() {
        try {
          // Rejestracja Service Workera
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
              .then(() => console.log('Service Worker registered'))
              .catch(err => console.error('SW registration failed:', err));
          }

          // PokaÅ¼/ukryj popup
          const emailModal = document.getElementById('emailModal');
          const closeBtn = emailModal?.querySelector('.close-button');
          const buyButton = document.getElementById('buy-button');
          const emailForm = document.getElementById('emailForm');
          const successMessage = document.getElementById('success-message');

          if (buyButton) {
            buyButton.addEventListener('click', () => {
              if (emailModal) {
                emailModal.classList.remove('hidden');
                emailModal.classList.add('visible');
              }
              if (successMessage) {
                successMessage.classList.remove('visible');
                successMessage.classList.add('hidden');
              }
            });
          }

          if (closeBtn) {
            closeBtn.addEventListener('click', () => {
              if (emailModal) {
                emailModal.classList.remove('visible');
                emailModal.classList.add('hidden');
              }
            });
          }

          if (emailModal) {
            emailModal.addEventListener('click', (e) => {
              if (e.target === emailModal) {
                emailModal.classList.remove('visible');
                emailModal.classList.add('hidden');
              }
            });
          }

          if (emailForm) {
            emailForm.addEventListener('submit', (e) => {
              e.preventDefault();

              // Tutaj wysyÅ‚ka danych formularza (jeÅ›li masz backend)
              // MoÅ¼na dodaÄ‡ fetch lub EmailJS

              // Po wysÅ‚aniu:
              if (emailModal) {
                emailModal.classList.remove('visible');
                emailModal.classList.add('hidden');
              }

              if (successMessage) {
                successMessage.classList.remove('hidden');
                successMessage.classList.add('visible');

                setTimeout(() => {
                  successMessage.classList.remove('visible');
                  successMessage.classList.add('hidden');
                }, 3000);
              }

              emailForm.reset(); // wyczyÅ›Ä‡ formularz
            });
          }

          const btn = document.getElementById('dimensions-show');
          if (btn) {
            btn.onclick = (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log("ğŸ“ KlikniÄ™to przycisk wymiarÃ³w");
              toggleDimensions();
            };
          }

          // Po inicjalizacji (czyli gdy masz juÅ¼ modele i przyciski):
          document.querySelectorAll(".export-btn").forEach(button => {
            button.addEventListener("click", () => {
              const format = button.getAttribute("data-format");
              handleExport(format);
            });
          });

        } catch (error) {
          console.error('âŒ BÅ‚Ä…d inicjalizacji event listenerÃ³w:', error);
        }
      }

      // ğŸ“± MOBILE INITIALIZATION
      function initMobileExperience() {
        console.log('ğŸ“± Inicjalizacja mobile experience');
        
        // Na mobile od razu pokaÅ¼ app bez loading screen
        if (window.isSmallScreen || window.isMobile) {
          console.log('ğŸ“± Mobile: Pomijam loading screen');
          hideWelcomeScreenAndShowApp();
          
          // ğŸ“± MOBILE UI - WYÅÄ„CZONE (uÅ¼ywamy desktop layout)
          const mobileTopUI = document.getElementById('mobile-top-ui');
          if (false && mobileTopUI) { // ğŸ”§ WYÅÄ„CZONE
            console.log('ğŸ“± Mobile UI wyÅ‚Ä…czone - uÅ¼ywamy desktop layout');
          }
          
          // ğŸ“± MOBILE CHAIR PANEL - WYÅÄ„CZONY
          const mobileChairPanel = document.getElementById('mobile-chair-panel');
          if (false && mobileChairPanel) { // ğŸ”§ WYÅÄ„CZONE
            console.log('ğŸ“± Mobile chair panel wyÅ‚Ä…czony');
          }
          
          // ğŸ“± PodÅ‚Ä…cz eventy do mobile UI
          setupMobileTopUI();
        }
      }
      
      // ğŸ“± SETUP MOBILE TOP UI
      function setupMobileTopUI() {
        console.log('ğŸ“± Konfiguracja mobile top UI');
        
        // Dark mode toggle
        const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
        if (mobileThemeToggle) {
          mobileThemeToggle.onclick = () => {
            document.body.classList.toggle('dark-mode');
            console.log('ğŸ“± Dark mode toggled');
          };
        }
        
        // Brightness
        const mobileBrightness = document.getElementById('mobile-brightness');
        if (mobileBrightness) {
          mobileBrightness.onclick = () => {
            const hdrButton = document.getElementById('hdr-toggle');
            if (hdrButton) hdrButton.click();
          };
        }
        
        // AR
        const mobileAR = document.getElementById('mobile-ar');
        if (mobileAR) {
          mobileAR.onclick = () => {
            const arButton = document.getElementById('ar-button');
            if (arButton) arButton.click();
          };
        }
        
        // Dimensions
        const mobileDimensions = document.getElementById('mobile-dimensions');
        if (mobileDimensions) {
          mobileDimensions.onclick = () => {
            const dimButton = document.getElementById('dimensions-show');
            if (dimButton) dimButton.click();
          };
        }
      }
      
      // ğŸ“± HIDE WELCOME SCREEN FUNCTION
      function hideWelcomeScreenAndShowApp() {
        const welcomeScreen = document.getElementById('welcome-screen');
        const app = document.getElementById('app');
        const canvas = document.getElementById('canvas');
        
        if (welcomeScreen) {
          welcomeScreen.style.display = 'none';
        }
        
        if (app) {
          app.classList.add('visible');
        }
        
        if (canvas) {
          canvas.style.display = 'block';
        }
        
        console.log('ğŸ“± Welcome screen ukryty, app widoczny');
      }

      // WywoÅ‚aj init mobile po inicjalizacji
      initMobileExperience();

      // ğŸ“± DEBUG FUNCTION - sprawdÅº dostÄ™pne formaty
      window.checkFormats = function() {
        console.log('ğŸ” Sprawdzanie dostÄ™pnych formatÃ³w...');
        
        allData.filter(item => item.Grupa?.toLowerCase().includes('krzesÅ‚o')).forEach(async (chair) => {
          const glbPath = `chairs/${chair.Nazwa}.glb`;
          const usdzPath = `chairs/${chair.Nazwa}.usdz`;
          
          const glbExists = await checkFileExists(glbPath);
          const usdzExists = await checkFileExists(usdzPath);
          
          console.log(`ğŸ“ ${chair.Nazwa}: GLB=${glbExists ? 'âœ…' : 'âŒ'}, USDZ=${usdzExists ? 'âœ…' : 'âŒ'}`);
        });
      };
      
      console.log('ğŸ“± DostÄ™pne debug functions:');
      console.log('ğŸ” checkFormats() - sprawdÅº dostÄ™pne formaty modeli');
      console.log('ï¿½ debugAppState() - sprawdÅº stan aplikacji');
      console.log('ï¿½ğŸ“± iOS detection:', window.isIOS);
      console.log('ğŸ“± Mobile detection:', window.isMobile);
      
      // ğŸ” DEBUG APP STATE FUNCTION
      window.debugAppState = function() {
        console.log('=== ğŸ” DEBUG APP STATE ===');
        
        const loader = document.getElementById('custom-loader');
        const app = document.getElementById('app');
        const welcomeScreen = document.getElementById('welcome-screen');
        const sidebar = document.getElementById('sidebar');
        const canvas = document.getElementById('canvas');
        
        console.log('ğŸ” Loader:', {
          exists: !!loader,
          display: loader ? getComputedStyle(loader).display : 'null',
          visible: loader ? !loader.classList.contains('hidden') : 'null'
        });
        
        console.log('ğŸ” App:', {
          exists: !!app,
          visible: app ? app.classList.contains('visible') : 'null',
          display: app ? getComputedStyle(app).display : 'null'
        });
        
        console.log('ğŸ” Welcome Screen:', {
          exists: !!welcomeScreen,
          display: welcomeScreen ? getComputedStyle(welcomeScreen).display : 'null',
          hidden: welcomeScreen ? welcomeScreen.classList.contains('hidden') : 'null'
        });
        
        console.log('ğŸ” Canvas:', {
          exists: !!canvas,
          display: canvas ? getComputedStyle(canvas).display : 'null'
        });
        
        console.log('ğŸ” Sidebar:', {
          exists: !!sidebar,
          visible: sidebar ? sidebar.classList.contains('visible') : 'null'
        });
        
        console.log('ğŸ” Data:', {
          allData: !!window.allData,
          count: window.allData ? window.allData.length : 0,
          viewer: !!window.viewer
        });
        
        return {
          loader: !!loader && getComputedStyle(loader).display !== 'none',
          app: !!app && app.classList.contains('visible'),
          welcomeScreen: !!welcomeScreen && getComputedStyle(welcomeScreen).display !== 'none',
          canvas: !!canvas && getComputedStyle(canvas).display !== 'none',
          dataLoaded: !!window.allData && window.allData.length > 0
        };
      };



  </script>
</body>

</html>