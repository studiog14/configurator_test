<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <title>Konfigurator krzeseÅ‚ FK</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <script type="importmap">
{
  "imports": {
    "threepipe": "https://unpkg.com/threepipe@latest/dist/index.mjs",
    "@threepipe/webgi-plugins": "https://unpkg.com/@threepipe/webgi-plugins@latest/dist/index.mjs",
    "three": "https://unpkg.com/three@0.157.0/build/three.module.js"

    
  }
}
</script>

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
        }

        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        #canvas {
            flex: 1 1 0;
            width: 100%;
            height: 100%;
            display: block;
            background: #ededed15;
        }

        body {
            background: #ededed80;
            /* przezroczyste tÅ‚o, lepszy blur */
        }

        /* Panele UI: identyczna przezroczystoÅ›Ä‡ i blur obu paneli */
        #sidebar,
        #config-overview {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 32px rgba(0, 0, 0, 0.10);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        #sidebar {
            flex: 0 0 440px;
            min-width: 340px;
            max-width: 510px;
            padding: 32px 24px 24px 24px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            overflow-y: auto;
            /* NIE dodawaj background! */
        }

        #config-overview {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            padding: 24px 20px 20px 20px;
            z-index: 20;
            font-size: 15px;
            display: none;
            /* pokazywany przez JS */
            opacity: 1;
            transition: opacity 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }

        #config-overview:hover {
            opacity: 1;
        }

        #config-overview.collapsed {
            height: auto;
            padding-bottom: 15px;
        }

        hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 16px 0 12px;
        }

        .selection-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #555;
        }

        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .thumbnail-wrapper {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: contain;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 8px;
            transition: all 0.2s;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            box-sizing: border-box;
            opacity: 1;
            /* Ikonki w peÅ‚ni widoczne */
        }

        .thumbnail:hover {
            transform: scale(1.05);
            border-color: #444;
        }

        .thumbnail.selected {
            outline: 2px solid #007bff;
            border: 2px solid transparent;
            outline-offset: -2px;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
        }

        .thumbnail img {
            max-width: 90%;
            max-height: 90%;
            opacity: 1;
        }

        .thumbnail-caption {
            font-size: 15px;
            color: #555;
            margin-top: 6px;
            font-weight: 500;
            opacity: 1;
        }

        #overview-icons img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            border: 1px solid #ddd;
            object-fit: contain;
            opacity: 1;
        }

        #config-overview h4 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 18px;
        }

        #overview-details .detail-item {
            font-size: 16px;
            margin: 8px 0;
        }

        #overview-total-price {
            font-size: 22px;
        }

        #overview-icons {
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 20px;
        }

        #summary {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #ccc;
        }

        #back-to-models-container {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            justify-content: flex-start;
        }

        .back-to-model-btn {
            position: relative;
            width: 80px;
            height: 80px;
            border: 1.5px solid #bbb;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 10px;
            transition: box-shadow 0.2s;
        }

        .back-to-model-btn:hover {
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
        }

        .back-to-model-btn img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            display: block;
        }

        .back-to-model-btn .close-x {
            position: absolute;
            top: 4px;
            right: 6px;
            background: #fff;
            border: none;
            font-size: 20px;
            color: #333;
            cursor: pointer;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 20px;
            padding: 0;
            box-shadow: 0 1px 4px #0001;
            transition: background 0.2s;
        }

        .back-to-model-btn .close-x:hover {
            background: #eee;
        }

        #camera-debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #fff;
            border: 1px solid #ccc;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0002;
        }

        #camera-debug-panel label {
            display: block;
            margin: 8px 0 4px;
            font-size: 14px;
        }

        #camera-debug-panel input {
            width: 100%;
            margin-bottom: 8px;
        }

        #camera-debug-panel button {
            width: 100%;
            padding: 8px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #camera-debug-panel button:hover {
            background: #0056b3;
        }

        body {
            background: #ededed;
            /* lub TwÃ³j kolor tÅ‚a */
        }

        #buy-button {
            width: 100%;
            padding: 14px 0;
            background: #111;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            margin-top: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #buy-button:hover {
            background: #333;
        }

        #buy-button .cart-icon {
            width: 22px;
            height: 22px;
            display: inline-block;
        }

        #sidebar .model-image {
            width: 100%;
            max-width: 100%;
            height: 110px;
            object-fit: contain;
            display: block;
            margin: 0 auto 10px auto;
            background: #fff;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        #model-image-container img {
            width: 100%;
            max-width: 100%;
            height: 220px;
            /* wiÄ™ksza wysokoÅ›Ä‡, dopasuj do UI */
            object-fit: contain;
            display: block;
            margin: 0 auto 18px auto;
            background: #fff;
            border-radius: 16px;
            border: 1.5px solid #ddd;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            padding: 12px 0;
            transition: box-shadow 0.2s;
        }

        .modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal.hidden {
  display: none;
}

modal-content {
  background: #fff;
  padding: 24px 28px;
  border-radius: 16px;
  width: 320px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  position: relative;
  font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  color: #222;
}

.close-button {
  position: absolute;
  top: 12px; right: 16px;
  cursor: pointer;
  font-size: 26px;
  font-weight: 700;
  color: #888;
  transition: color 0.2s ease;
}

.close-button:hover {
  color: #444;
}

.modal-content h2 {
  margin-top: 0;
  margin-bottom: 16px;
  font-weight: 700;
  font-size: 20px;
  text-align: center;
}

.modal-content label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 14px;
}

.modal-content input {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 18px;
  border: 1.5px solid #ddd;
  border-radius: 12px;
  font-size: 15px;
  box-sizing: border-box;
  transition: border-color 0.2s ease;
}

.modal-content input:focus {
  border-color: #888;
  outline: none;
}

.modal-content button[type="submit"] {
  width: 100%;
  background: #000; /* czarny przycisk jak na podsumowaniu */
  color: #fff;
  font-weight: 700;
  font-size: 16px;
  padding: 12px 0;
  border: none;
  border-radius: 16px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.modal-content button[type="submit"]:hover {
  background: #333;
}

/* Komunikat sukcesu */
#success-message {
  background: #d4edda;
  border: 1.5px solid #c3e6cb;
  color: #155724;
  font-weight: 700;
  margin-top: 14px;
  padding: 14px 18px;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 8px 32px rgba(21, 87, 36, 0.15);
  font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  max-width: 320px;
  margin-left: auto;
  margin-right: auto;
}

/* Ukrywanie i pokazywanie */
.hidden {
  display: none;
}

.visible {
  display: block;
}




    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <div id="app">
        <canvas id="canvas"></canvas>
        <div id="config-overview">
            <button id="collapse-btn">âˆ’</button>
            <h4>Twoja Konfiguracja</h4>
            <div id="overview-icons"></div>
            <div id="overview-details"></div>
            <div id="overview-total">
                <p>Suma: <strong id="overview-total-price">0.00 PLN</strong></p>
                <button id="buy-button">KupujÄ™</button>
            </div>
        </div>
        <div id="sidebar">
            <div id="selected-chair-name">Wybrany model: Brak</div>
            <div id="model-image-container"></div> <!-- DODAJ TO TUTAJ -->
            <hr />
            <div id="model-section">
                <div class="selection-section">
                    <h3>Wybierz model:</h3>
                    <div id="model-thumbnails" class="options-grid"></div>
                </div>
            </div>
            <div id="config-section" style="display:none;">
                <div id="back-to-models-container" style="margin-bottom: 15px;"></div>
                <div id="legs-section" class="selection-section">
                    <h3>Nogi:</h3>
                    <div id="legs-thumbnails" class="options-grid"></div>
                </div>
                <div id="parts-section" class="selection-section">
                    <h3>Wybierz element:</h3>
                    <div id="part-tabs" class="options-grid"></div>
                </div>
                <div id="materials-section" class="selection-section">
                    <h3>Wybierz materiaÅ‚:</h3>
                    <div id="material-options" class="options-grid"></div>
                </div>
            </div>
            <div id="summary"></div>
        </div>
    </div>
<!-- FORMULARZ EMAIL - POPUP -->
<div id="emailModal" class="modal hidden">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>WyÅ›lij swojÄ… konfiguracjÄ™</h2>
    <form id="emailForm">
      <label for="name">ImiÄ™ i nazwisko:</label>
      <input type="text" id="name" name="name" required>

      <label for="email">Adres e-mail:</label>
      <input type="email" id="email" name="email" required>

      <label for="phone">Numer telefonu:</label>
      <input type="tel" id="phone" name="phone">

      <button type="submit">WyÅ›lij</button>
    </form>
  </div>
</div>

<!-- KOMUNIKAT SUKCESU -->
<div id="success-message" class="hidden">âœ… DziÄ™kujemy! Formularz zostaÅ‚ wysÅ‚any.</div>






    <script type="module">
        import * as THREE from 'three'; // â¬…ï¸ korzysta z importmap

import {
  ThreeViewer,
  LoadingScreenPlugin,
  GBufferPlugin,
  SSAAPlugin,
  Box3,
  Vector3,
  Color,
  TextureLoader
} from 'threepipe';


        import {
            SSReflectionPlugin,
            BloomPlugin
        } from '@threepipe/webgi-plugins';

       





        const CAMERA_FOV = 12;
        const CAMERA_NEAR = 0.1;
        const CAMERA_FAR = 100;
        const CAMERA_POSITION = { x: -4.5, y: 0.76, z: 3.9 };
        const CAMERA_TARGET = { x: 0.79, y: -1.09, z: -0.22 };

        const MIN_ZOOM_DISTANCE = 1; // minimalna odlegÅ‚oÅ›Ä‡ kamery od modelu (przybliÅ¼enie)
        const MAX_ZOOM_DISTANCE = 8; // maksymalna odlegÅ‚oÅ›Ä‡ kamery od modelu (oddalenie)
        const VERTICAL_OFFSET = 0;

        let viewer, currentModelContainer, currentLegModel;
        let allData = [];
        let selectedChair, selectedLeg, selectedMaterials = {};
        let globalCameraTargetPosition;
        let userInteracted = false;
        


        const ELEMENT_ICONS = {
            seat: 'icons/m_seat_icon.png',
            backseat_inside: 'icons/m_backseat_in_icon.png',
            backseat_outside: 'icons/m_backseat_out_icon.png',
            legs: 'icons/m_legs_icon.png'
        };

        function showScreen(screenName) {
            document.getElementById('model-section').style.display = screenName === 'models' ? 'block' : 'none';
            document.getElementById('config-section').style.display = screenName === 'config' ? 'block' : 'none';
        }

        async function loadCameraTarget() {
            try {
                const targetsContainer = await viewer.load('camera_target.glb');
                if (targetsContainer) {
                    // Szukaj obiektu o nazwie "camera_target" (lub zmieÅ„ na nazwÄ™ empty z Blender)
                    const targetObject = targetsContainer.getObjectByName('camera_target');
                    if (targetObject) {
                        globalCameraTargetPosition = targetObject.getWorldPosition(new Vector3());
                    } else {
                        // JeÅ›li nie znajdzie, uÅ¼yj Å›rodka sceny
                        globalCameraTargetPosition = new Vector3(0, 0, 0);
                    }
                    viewer.scene.remove(targetsContainer); // nie pokazuj empty w scenie
                }
            } catch (e) {
                console.warn("Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ 'camera_target.glb'. UÅ¼ywam domyÅ›lnych ustawieÅ„.");
                globalCameraTargetPosition = new Vector3(0, 0, 0);
            }
        }

        async function init() {
            const canvas = document.getElementById("canvas");
            
            viewer = new ThreeViewer({
                canvas: canvas,
                plugins: [LoadingScreenPlugin, GBufferPlugin, SSAAPlugin, SSReflectionPlugin, BloomPlugin],
                rendererSettings: { antialias: true }
            });
            if (viewer.controls) {
                viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
                viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
                viewer.controls.dampingFactor = 0.1;
                viewer.controls.enableDamping = true;
                // Dodaj nasÅ‚uchiwanie TUTAJ, po utworzeniu viewer i controls:
                viewer.controls.addEventListener('change', clampCameraDistance);
            }

            const collapseBtn = document.getElementById('collapse-btn');
            const overviewPanel = document.getElementById('config-overview');
            collapseBtn.onclick = () => {
                overviewPanel.classList.toggle('collapsed');
                collapseBtn.textContent = overviewPanel.classList.contains('collapsed') ? '+' : 'âˆ’';
            };

            document.getElementById('buy-button').innerHTML = '<span class="cart-icon">ðŸ›’</span>Zapytaj o produkt';

            document.getElementById('buy-button').onclick = () => {
    const summary = generateSummaryText();
    const subject = `Zapytanie o wycenÄ™: ${selectedChair.Nazwa}`;
    const body = `DzieÅ„ dobry,\n\nProszÄ™ o wycenÄ™ poniÅ¼szej konfiguracji:\n\n${summary.text}\n-------------------\nSuma: ${summary.totalPrice.toFixed(2)} PLN\n\nPozdrawiam,\n[ImiÄ™ i nazwisko]`;

    console.log("Symulowana wysyÅ‚ka wiadomoÅ›ci:");
    console.log("Temat:", subject);
    console.log("TreÅ›Ä‡:", body);

    // Zamknij modal (jeÅ›li byÅ‚ otwarty) i pokaÅ¼ komunikat
    const modal = document.getElementById('emailModal');
    if (modal) modal.classList.add('hidden');

    const successMessage = document.getElementById('success-message');
    if (successMessage) {
        successMessage.classList.remove('hidden');
        setTimeout(() => {
            successMessage.classList.add('hidden');
        }, 3000);
    }
};

            try {
                await viewer.setEnvironmentMap("hdr/blocky_photo_studio_1k.hdr", { isHDR: true });
            } catch (e) { console.error("BÅ‚Ä…d Å‚adowania HDR:", e); }

            await loadCameraTarget();
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();
            await loadDataFromSheet();
        }

        function setCameraView(targetPosition) {
            const camera = viewer.scene.activeCamera;
            camera.fov = CAMERA_FOV;
            camera.near = CAMERA_NEAR;
            camera.far = CAMERA_FAR;
            camera.position.set(CAMERA_POSITION.x, CAMERA_POSITION.y, CAMERA_POSITION.z);

            // Ustaw target na wybranÄ… pozycjÄ™ (np. globalCameraTargetPosition)
            let center = globalCameraTargetPosition || new Vector3(0, 0, 0);
            camera.lookAt(center);
            camera.updateProjectionMatrix();

            // CaÅ‚kowicie wyÅ‚Ä…cz kontrolki pozycjonowania
            if (viewer.controls) {
                viewer.controls.target.copy(center);
                viewer.controls.enableRotate = false;
                viewer.controls.enablePan = false;
                viewer.controls.screenSpacePanning = false;
                viewer.controls.enableZoom = false;
                viewer.controls.enabled = false; // to blokuje WSZYSTKIE interakcje
                viewer.controls.update();
            }
        }

        function resizeCanvas() {
            const sidebar = document.getElementById("sidebar");
            const sidebarWidth = sidebar ? sidebar.offsetWidth : 0;
            const canvas = document.getElementById("canvas");
            const width = window.innerWidth - sidebarWidth;
            const height = window.innerHeight;
            // Ustaw rozmiar CSS
            canvas.style.width = width + "px";
            canvas.style.height = height + "px";
            // Ustaw rozmiar atrybutÃ³w (dla WebGL)
            canvas.width = width;
            canvas.height = height;
            if (viewer && viewer.renderer && viewer.scene && viewer.scene.activeCamera) {
                viewer.renderer.setSize(width, height, false);
                viewer.scene.activeCamera.aspect = width / height;
                viewer.scene.activeCamera.updateProjectionMatrix();
            }
        }

        async function silentLoadModel(variant) {
            if (currentModelContainer) viewer.scene.remove(currentModelContainer);
            currentModelContainer = await viewer.load(`chairs/${variant.Nazwa}.glb`, { autoCenter: true });
            console.log("Meshe w modelu:", currentModelContainer.children.map(obj => obj.name)); // <-- DODAJ TO TUTAJ
            //selectedChair = variant; // <-- DODAJ TO!
            // WyÅ›rodkuj kamerÄ™ na modelu
            const box = new Box3().setFromObject(currentModelContainer);
            const center = box.getCenter(new Vector3());
            setCameraView(center);
            currentModelContainer.position.sub(center);
            updateSummary();
        }

       async function loadModel(variant) {
    if (currentModelContainer) {
        viewer.scene.remove(currentModelContainer);
        if (typeof currentModelContainer.dispose === 'function') currentModelContainer.dispose();
    }
    if (currentLegModel) {
        viewer.scene.remove(currentLegModel);
        if (typeof currentLegModel.dispose === 'function') currentLegModel.dispose();
    }
    currentModelContainer = null;
    currentLegModel = null;
    selectedLeg = null;
    selectedMaterials = {};

    try {
        const modelPath = `chairs/${variant.Nazwa}.glb`;
        currentModelContainer = await viewer.load(modelPath, { autoCenter: true });

        selectedChair = variant;
        userInteracted = true;

        if (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
            const chairBounds = new Box3().setFromObject(currentModelContainer);
            currentModelContainer.position.y -= chairBounds.min.y;

            // Automatyczne dodanie nÃ³g "Regularne" jeÅ›li istniejÄ…
            const legsVariants = allData.filter(d => d.Grupa.toLowerCase() === 'nogi');
            const defaultLeg = legsVariants.find(l => l.Nazwa.toLowerCase().includes('regularne')) || legsVariants[0];
            if (defaultLeg) {
                await setLegModel(defaultLeg);
            }

            document.getElementById('legs-section').style.display = 'block';
            
            // PokaÅ¼ materiaÅ‚y nÃ³g
            activateLegsTabAndShowMaterials();
        } else {
            document.getElementById('legs-section').style.display = 'none';
            if (currentLegModel) {
                viewer.scene.remove(currentLegModel);
                currentLegModel = null;
                selectedLeg = null;
            }
        }

        setCameraView(globalCameraTargetPosition);
        enforceZoomLimits();
        updateUI();
        showScreen('config');

        // **Sekcja materiaÅ‚Ã³w nÃ³g - zawsze widoczna dla kaÅ¼dego krzesÅ‚a!**
        document.getElementById('materials-section').style.display = 'block';
        
        // Renderujemy materiaÅ‚y nÃ³g â€” czyli kafelki materiaÅ‚Ã³w z grupy "nogi"
        const legsMaterials = allData.filter(d => d.Grupa.toLowerCase() === 'nogi');
        renderOptions('materials-thumbnails', legsMaterials, (item) => {
            // Tutaj funkcja ustawiajÄ…ca materiaÅ‚ nogi
            // (dopasuj do swojej funkcji obsÅ‚ugi klikniÄ™cia)
            setLegMaterial(item);
        });

        setCameraView(globalCameraTargetPosition);
        enforceZoomLimits();
        updateUI();
        showScreen('config');
    } catch (e) { 
        console.error(`BÅÄ„D Å‚adowania modelu: ${e.message}`, e); 
    }
}




function createLegMaterial(legData) {
  const metalness = isNaN(parseFloat(legData.metalness)) ? 1 : parseFloat(legData.metalness);
  const roughness = isNaN(parseFloat(legData.roughness)) ? 0.1 : parseFloat(legData.roughness);
  const color = legData.color || '#FFFFFF';

  return new THREE.MeshStandardMaterial({
    color: new THREE.Color(color),
    metalness: metalness,
    roughness: roughness,
  });
}

async function setLegModel(variant) {
    userInteracted = true;
    console.log("WywoÅ‚anie setLegModel dla wariantu:", variant);
    const oldLegs = currentLegModel;
    try {
        const modelPath = `legs/${variant.Nazwa}.glb`;
        console.log("ÅadujÄ™ model nÃ³g z Å›cieÅ¼ki:", modelPath);
        const newLegs = await viewer.load(modelPath, { autoCenter: false });
        
        const legBounds = new Box3().setFromObject(newLegs);
        const legHeight = legBounds.max.y - legBounds.min.y;

        if (currentModelContainer && selectedChair) {
            if (selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
                let height = parseFloat(variant.height) || legHeight;
                newLegs.position.y = -height;
                currentModelContainer.position.y = 0;
            } else {
                currentModelContainer.position.y = legHeight + VERTICAL_OFFSET;
                newLegs.position.y = 0;
            }
        }

        if (oldLegs) {
            viewer.scene.remove(oldLegs);
            if (typeof oldLegs.dispose === 'function') oldLegs.dispose();
        }
        viewer.scene.add(newLegs);
        currentLegModel = newLegs;
        selectedLeg = variant;

        // OdÅ›wieÅ¼ listÄ™ nÃ³g, Å¼eby podÅ›wietliÄ‡ wybrany wariant
        const legs = allData.filter(d => d.Grupa.toLowerCase() === 'nogi');
        renderOptions('legs-thumbnails', legs, item => {
            setLegModel(item);
        });

        updateSummary();
        
        // Wymuszenie odÅ›wieÅ¼enia sceny
        if (viewer.render) viewer.render();
    } catch (e) {
        console.error(`BÅÄ„D Å‚adowania nÃ³g: ${e.message}`, e);
    }
}



let forceRenderInterval;

function triggerSceneRefresh() {
  if (viewer?.camera) {
    viewer.camera.position.x += 0.00001;
    viewer.camera.zoom += 0.0001; // â¬…ï¸ mikroskopijny zoom
    viewer.camera.updateProjectionMatrix();
  }
  if (viewer?.renderer?.info) {
    viewer.renderer.info.reset();
  }
  if (viewer?.render) viewer.render();
}


function startForceRender(duration = 2000) {
  clearInterval(forceRenderInterval);
  forceRenderInterval = setInterval(() => {
    triggerSceneRefresh();
  }, 100);

  setTimeout(() => {
    clearInterval(forceRenderInterval);
    console.log("ðŸ›‘ ZakoÅ„czono wymuszone odÅ›wieÅ¼anie");
  }, duration);
}



const textureLoader = new TextureLoader();

if (
  selectedChair?.Grupa?.toLowerCase() === 'kubeÅ‚ek' &&
  variant.TargetMeshOrModel?.toLowerCase().includes('legs') &&
  variant.WariantModelu
) {
  // ðŸ‘‰ dla kubeÅ‚kÃ³w z podmianÄ… nÃ³g â€” zmieÅ„ model nÃ³g
  setLegModel(variant);
} else if (
  selectedChair && 
  (selectedChair.Grupa.toLowerCase() !== 'kubeÅ‚ek' || !variant.WariantModelu)
) {
  // ðŸ‘‰ dla pozostaÅ‚ych krzeseÅ‚ bez wariantÃ³w nÃ³g â€” wyÅ›wietl materiaÅ‚y nÃ³g do wyboru
  showLegMaterialsForSimpleChairs(selectedChair);
}

function applyMaterialToMesh(variant, forcedMeshName) {
  const clone = { ...variant };
  clone.TargetMeshOrModel = forcedMeshName;
  console.log(`ðŸŽ¯ Przypisano '${clone.Nazwa}' tylko do mesh '${forcedMeshName}'`);
  applyMaterial(clone);
}

// Funkcja, ktÃ³ra wyÅ›wietla kafelki materiaÅ‚Ã³w nÃ³g dla prostych krzeseÅ‚
function showLegMaterialsForSimpleChairs(chair) {
  const legsMaterialsContainer = document.getElementById('legs-thumbnails');
  legsMaterialsContainer.innerHTML = ''; // wyczyÅ›Ä‡ kontener

  // Pobierz materiaÅ‚y nÃ³g dla danego krzesÅ‚a (przykÅ‚ad, wymaga dostosowania)
  const materials = getMaterialsForLegs(chair.defaultLegsId || 'default');

  materials.forEach(mat => {
    const tile = document.createElement('div');
    tile.className = 'material-tile';
    tile.textContent = mat.Nazwa;
    tile.style.backgroundImage = `url(${mat.Obrazek || 'fallback.png'})`;
    tile.onclick = () => applyLegMaterial(mat);
    legsMaterialsContainer.appendChild(tile);
  });
}


// DOBRE ÅADOWANIE MATERIAÅÃ“W!!!

async function applyMaterial(variant) {
  console.log('applyMaterial wywoÅ‚ane z:', variant);
  
  if (!currentModelContainer) {
    console.warn('currentModelContainer jest null lub undefined');
    return;
  }
  
  if (!variant.TargetMeshOrModel) {
    console.warn('Brak TargetMeshOrModel w wariancie');
    return;
  }
    
  if (!currentModelContainer || !variant.TargetMeshOrModel) return;

  const targetNames = variant.TargetMeshOrModel.split(',').map(name => name.trim());
  const folderPath = variant.WartoÅ›Ä‡.startsWith('textures/') ? variant.WartoÅ›Ä‡ : `textures/${variant.WartoÅ›Ä‡}`;

  for (const targetName of targetNames) {
    let container;
    if (targetName.toLowerCase() === 'legs') {
      if (selectedChair?.Grupa?.toLowerCase() === 'krzesÅ‚o' || !currentLegModel) {
        container = currentModelContainer;
      } else {
        container = currentLegModel;
      }
    } else {
      container = currentModelContainer;
    }

    let targetObject = null;

    container?.traverse(obj => {
      if (
        obj.isMesh &&
        obj.name &&
        obj.name.toLowerCase().trim() === targetName.toLowerCase().trim()
      ) {
        targetObject = obj;
      }
    });

    if (!targetObject) {
      console.warn(`âŒ Mesh '${targetName}' nie znaleziony w modelu`);
      continue;
    }

    if (!targetObject.material) {
      console.warn(`âš ï¸ Mesh '${targetName}' nie ma materiaÅ‚u.`);
      continue;
    }

    const material = targetObject.material.clone();

    // Funkcja do bezpiecznego Å‚adowania tekstury (zwraca null, jeÅ›li nie uda siÄ™ zaÅ‚adowaÄ‡)
    async function loadTextureSafe(url) {
      try {
        const tex = await textureLoader.loadAsync(url);
        tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
        tex.encoding = THREE.sRGBEncoding;
        return tex;
      } catch {
        return null;
      }
    }

    if (folderPath && !/\.(jpg|jpeg|png|gif)$/i.test(folderPath)) {
      const baseColorTex = await loadTextureSafe(`${folderPath}/baseColor.jpg`);
      const normalTex = await loadTextureSafe(`${folderPath}/normal.jpg`);
      const roughnessTex = await loadTextureSafe(`${folderPath}/roughness.jpg`);
      const metallicTex = await loadTextureSafe(`${folderPath}/metallic.jpg`);

      material.map = baseColorTex || null;
      material.normalMap = normalTex || null;
      material.roughnessMap = roughnessTex || null;
      material.metalnessMap = metallicTex || null;

      material.color.set(0xffffff);

      if (baseColorTex) baseColorTex.needsUpdate = true;
      if (normalTex) normalTex.needsUpdate = true;
      if (roughnessTex) roughnessTex.needsUpdate = true;
      if (metallicTex) metallicTex.needsUpdate = true;

      material.needsUpdate = true;

      targetObject.material = material;

      triggerSceneRefresh();
      startForceRender();

      console.log(`âœ… ZaÅ‚adowano mapy na mesh '${targetName}':`, {
        baseColorMap: !!material.map,
        normalMap: !!material.normalMap,
        roughnessMap: !!material.roughnessMap,
        metallicMap: !!material.metalnessMap
      });

    } else if (variant.WartoÅ›Ä‡ && /\.(jpg|jpeg|png)$/i.test(variant.WartoÅ›Ä‡)) {
      // obsÅ‚uga gdy podano pojedynczy plik (np. baseColor)
      try {
        const texture = await textureLoader.loadAsync(variant.WartoÅ›Ä‡);
        texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
        texture.encoding = THREE.sRGBEncoding;

        material.map = texture;
        material.color.set(0xffffff);
        material.map.needsUpdate = true;
        material.needsUpdate = true;

        targetObject.material = material;

        triggerSceneRefresh();
        startForceRender();

        console.log(`âœ… Tekstura '${variant.WartoÅ›Ä‡}' zaÅ‚adowana na mesh '${targetName}'`);
      } catch (e) {
        console.warn(`âŒ Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ tekstury: ${variant.WartoÅ›Ä‡}`, e);
      }
    } else if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(variant.WartoÅ›Ä‡)) {
        
      if (!(targetObject.material instanceof THREE.MeshStandardMaterial)) {
        console.log(`ðŸ› ï¸ Zamiana materiaÅ‚u na MeshStandardMaterial dla '${targetName}'`);
        const newMat = new THREE.MeshStandardMaterial();
        targetObject.material.dispose();
        targetObject.material = newMat;
      }
      const material = targetObject.material;

      try {
        material.map = null;
        material.color = new THREE.Color(variant.WartoÅ›Ä‡);

        // Logowanie surowych wartoÅ›ci
        console.log(`Metalness raw: '${variant.Metalness}', Roughness raw: '${variant.Roughness}'`);

        // Obcinamy spacje i konwertujemy na float
        const metalRaw = (variant.Metalness || '').toString().trim();
        const roughRaw = (variant.Roughness || '').toString().trim();

        const metalVal = metalRaw !== '' ? parseFloat(metalRaw) : 0.35;
        const roughVal = roughRaw !== '' ? parseFloat(roughRaw) : 0.4;

        console.log(`Metalness parsed: ${metalVal}, Roughness parsed: ${roughVal}`);

        material.metalness = !isNaN(metalVal) ? metalVal : 0.35;
        material.roughness = !isNaN(roughVal) ? roughVal : 0.4;

        targetObject.material = material;
targetObject.geometry.computeVertexNormals(); // â¬…ï¸ to dodaj
material.needsUpdate = true;


        triggerSceneRefresh();
        startForceRender();

        console.log(`ðŸŽ¨ Kolor i wÅ‚aÅ›ciwoÅ›ci materiaÅ‚u ustawione na '${targetName}': kolor ${variant.WartoÅ›Ä‡}, metalness ${material.metalness}, roughness ${material.roughness}`);
      } catch (e) {
        console.warn(`âŒ Nie udaÅ‚o siÄ™ ustawiÄ‡ koloru lub wÅ‚aÅ›ciwoÅ›ci: ${variant.WartoÅ›Ä‡}`, e);
      }
    } else {
      console.warn(`âš ï¸ Niepoprawna wartoÅ›Ä‡ materiaÅ‚u: ${variant.WartoÅ›Ä‡}`);
    }
  }

  // ZapamiÄ™tanie wyboru i odÅ›wieÅ¼enie sceny - moÅ¼esz tu zostawiÄ‡ swÃ³j oryginalny kod
  targetNames.forEach(targetName => {
    selectedMaterials[targetName] = variant;
    if (targetName === 'legs' || targetName === 'legs_material') {
      selectedMaterials['legs_material'] = variant;
    }
  });

  viewer.scene.traverse(obj => {
    if (obj.isMesh && obj.material) {
      obj.material.needsUpdate = true;
    }
  });

  if (viewer?.camera) {
    viewer.camera.position.x += 0.00001;
    viewer.camera.updateProjectionMatrix();
  }

  if (viewer?.render) viewer.render();

  updateSummary();
}

function applyMaterialToSpecificMesh(variant, meshKey) {
  const clone = { ...variant };
  clone.TargetMeshOrModel = meshKey;
  console.log(`ðŸŽ¯ Przypisano '${variant.Nazwa}' tylko do mesh '${meshKey}'`);
  applyMaterial(clone);
}

// DOBRE ÅADOWANIE MATERIAÅÃ“W!!!





            function renderOptions(containerId, items, onSelect, isInteractive = true) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                items.forEach((item, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'thumbnail-wrapper';
                    const button = document.createElement('div');
                    button.className = 'thumbnail';
                    button.title = item.Nazwa;

                    // PODÅšWIETLENIE WYBRANEGO
                    let isSelected = false;
                    if (containerId === 'material-options') {
                        if (item.Grupa && item.Grupa.toLowerCase() === 'materiaÅ‚y_nÃ³g') {
                            isSelected = selectedMaterials['legs_material'] && selectedMaterials['legs_material'].Nazwa === item.Nazwa;
                        } else if (item.TargetMeshOrModel) {
                            const targets = item.TargetMeshOrModel.split(',').map(t => t.trim());
                            isSelected = targets.some(t => selectedMaterials[t] && selectedMaterials[t].Nazwa === item.Nazwa);
                        }
                    } else if (containerId === 'legs-thumbnails') {
                        isSelected = selectedLeg && selectedLeg.Nazwa === item.Nazwa;
                    }
                    if (isSelected) button.classList.add('selected');

                    if (isInteractive) {
                        button.addEventListener('click', () => {
                            onSelect(item);
                            container.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
                            button.classList.add('selected');
                        });
                    }
                    const img = document.createElement('img');
                    img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
                    img.alt = item.Nazwa;
                    button.appendChild(img);
                    const caption = document.createElement('div');
                    caption.className = 'thumbnail-caption';
                    caption.textContent = item.Nazwa;
                    wrapper.appendChild(button);
                    wrapper.appendChild(caption);
                    container.appendChild(wrapper);
                });
            }

            



function renderFilteredMaterialOptions(targetMesh) {
  let materialOptions = [];

  if (!selectedChair || !selectedChair.Grupa) return;
  const grupa = selectedChair.Grupa.toLowerCase();

  // ðŸ”§ FUNKCJA POMOCNICZA: sprawdza czy wpis pasuje do grupy docelowej
  const isAllowedForGroup = (entryGroupDocelowa) => {
    if (!entryGroupDocelowa) return false; // pusta = nie pokazuj
    const values = entryGroupDocelowa.toLowerCase().split(',').map(s => s.trim());
    return values.includes('wszystkie') || values.includes(grupa) || values.includes('kubeÅ‚ek, krzesÅ‚o');
  };

  // ðŸ¦µ MATERIAÅY NÃ“G
  if (targetMesh === 'legs' || targetMesh === 'legs_material') {
    materialOptions = allData.filter(d =>
      d.Grupa?.toLowerCase() === 'materiaÅ‚y_nÃ³g' &&
      isAllowedForGroup(d.GrupaDocelowa) &&
      d.Visible?.toLowerCase() !== 'false'
    );

    // Filtrowanie po typie nÃ³g, jeÅ›li istnieje
    if (selectedLeg && selectedLeg.Typ) {
      materialOptions = materialOptions.filter(mat =>
        !mat.Typ || mat.Typ.toLowerCase().trim() === selectedLeg.Typ.toLowerCase().trim()
      );
    }

    // Dodatkowo filtruj po DlaModeluNÃ³g
    if (selectedLeg && selectedLeg.Nazwa) {
      const currentLegName = selectedLeg.Nazwa.toLowerCase().trim();
      materialOptions = materialOptions.filter(mat => {
        const allowedLegs = mat.DlaModeluNÃ³g
          ? mat.DlaModeluNÃ³g.split(',').map(s => s.trim().toLowerCase())
          : [];
        return allowedLegs.length === 0 || allowedLegs.includes(currentLegName);
      });
    }

    renderOptions('material-options', materialOptions, item =>
      applyMaterialToSpecificMesh(item, 'legs')
    );
    return;
  }

  // âœ³ï¸ MATERIAÅY TKANINOWE (siedzisko, oparcia itd.)
  materialOptions = allData.filter(d =>
    d.Grupa?.toLowerCase() === 'tkanina' &&
    d.TargetMeshOrModel &&
    d.TargetMeshOrModel.split(',').map(s => s.trim()).includes(targetMesh) &&
    isAllowedForGroup(d.GrupaDocelowa) &&
    d.Visible?.toLowerCase() !== 'false'
  );

  renderOptions('material-options', materialOptions, item =>
    applyMaterialToSpecificMesh(item, targetMesh)
  );
}







            function activateLegsTabAndShowMaterials() {
                // PodÅ›wietl zakÅ‚adkÄ™ "Nogi" po data-key
                const partTabs = document.querySelectorAll('#part-tabs .thumbnail');
                partTabs.forEach(tab => tab.classList.remove('selected'));
                partTabs.forEach(tab => {
                    if (tab.dataset.key === 'legs') {
                        tab.classList.add('selected');
                    }
                });

                // PokaÅ¼ sekcjÄ™ materiaÅ‚Ã³w i wyÅ›wietl wszystkie materiaÅ‚y nÃ³g
                document.getElementById('materials-section').style.display = 'block';
                renderFilteredMaterialOptions('legs');
                
            }

            function renderPartTabs() {
                const container = document.getElementById('part-tabs');
                container.innerHTML = '';
                // Pobierz unikalne elementy do wyboru
                const allTargets = allData.filter(d => d.TargetMeshOrModel)
                    .flatMap(d => d.TargetMeshOrModel.split(',').map(t => t.trim()));
                const uniqueTargets = [...new Set(allTargets)];
                if (uniqueTargets.length === 0) {
                    document.getElementById('parts-section').style.display = 'none';
                    return;
                }
                document.getElementById('parts-section').style.display = 'block';

                // Mapowanie nazw technicznych na polskie
                const POLISH_LABELS = {
                    seat: 'Siedzisko',
                    backseat_inside: 'Oparcie wew.',
                    backseat_outside: 'Oparcie zew.',
                    legs: 'Nogi'
                };

                renderOptions('part-tabs', uniqueTargets.map(name => {
                    const key = name.trim().toLowerCase();
                    return {
                        Nazwa: POLISH_LABELS[key] || name.trim(),
                        Obrazek: ELEMENT_ICONS[key] || 'icons/placeholder.svg',
                        _technicalKey: key
                    };
                }), (item) => {
                    if (item._technicalKey === 'legs') {
                        activateLegsTabAndShowMaterials();
                    } else {
                        // PodÅ›wietl klikniÄ™tÄ… zakÅ‚adkÄ™
                        const partTabs = document.querySelectorAll('#part-tabs .thumbnail');
                        partTabs.forEach(tab => tab.classList.remove('selected'));
                        partTabs.forEach(tab => {
                            if (tab.title && tab.title.toLowerCase().includes(item.Nazwa.toLowerCase())) {
                                tab.classList.add('selected');
                            }
                        });
                        document.getElementById('materials-section').style.display = 'block';
                        renderFilteredMaterialOptions(item._technicalKey);
                    }
                });
            }

            function updateUI() {
    const backContainer = document.getElementById('back-to-models-container');
    backContainer.innerHTML = '';
    if (selectedChair && (selectedChair.Obrazek || selectedChair.Image)) {
        // StwÃ³rz ramkÄ™ z ikonkÄ… i X
        const btn = document.createElement('div');
        btn.className = 'back-to-model-btn';
        btn.title = 'WrÃ³Ä‡ do wyboru modelu';

        // Ikonka modelu
        const img = document.createElement('img');
        img.src = selectedChair.Obrazek || selectedChair.Image;
        img.alt = selectedChair.Nazwa;
        btn.appendChild(img);

        // Przycisk X w rogu
        const xBtn = document.createElement('button');
        xBtn.className = 'close-x';
        xBtn.innerHTML = '&times;';
        xBtn.title = 'WrÃ³Ä‡ do wyboru modelu';
        xBtn.onclick = (e) => {
            e.stopPropagation();
            showScreen('models');
        };
        btn.appendChild(xBtn);

        // KlikniÄ™cie w caÅ‚Ä… ramkÄ™ teÅ¼ wraca do wyboru modelu
        btn.onclick = () => showScreen('models');

        backContainer.appendChild(btn);
    }

    const legs = allData.filter(d => d.Grupa.toLowerCase() === 'nogi');
    renderPartTabs();

    // Sekcja nÃ³g i materiaÅ‚y nÃ³g â€“ nogi tylko dla kubeÅ‚kÃ³w, materiaÅ‚y dla kubeÅ‚kÃ³w i krzeseÅ‚
    if (selectedChair && selectedChair.Grupa) {
        const grupa = selectedChair.Grupa.toLowerCase();

        if (grupa === 'kubeÅ‚ek') {
            console.log("PokazujÄ™ nogi i materiaÅ‚y nÃ³g dla kubeÅ‚ka");
            document.getElementById('legs-section').style.display = 'block';
            renderOptions('legs-thumbnails', legs, item => {
                setLegModel(item);
            });

            // Ukryj sekcjÄ™ materiaÅ‚Ã³w, pokaÅ¼e siÄ™ po klikniÄ™ciu w zakÅ‚adkÄ™
            document.getElementById('materials-section').style.display = 'none';
        } else if (grupa === 'krzesÅ‚o') {
            console.log("Ukrywam sekcjÄ™ nÃ³g dla krzesÅ‚a");
            document.getElementById('legs-section').style.display = 'none';

            // Ukryj sekcjÄ™ materiaÅ‚Ã³w, pokaÅ¼e siÄ™ po klikniÄ™ciu w zakÅ‚adkÄ™
            document.getElementById('materials-section').style.display = 'none';
        } else {
            console.log("Ukrywam sekcje nÃ³g i materiaÅ‚Ã³w");
            document.getElementById('legs-section').style.display = 'none';
            document.getElementById('materials-section').style.display = 'none';
        }
    } else {
        console.log("Brak wybranego elementu lub grupy");
        document.getElementById('legs-section').style.display = 'none';
        document.getElementById('materials-section').style.display = 'none';
    }

    updateSummary();
}

const visibleData = allData.filter(d =>
  d.Visible?.toString().trim().length > 0
);


            async function loadDataFromSheet() {
                const sheetId = '1vCs6YeHgKqlYwg8rvJOqVzNRnXeATJCBuK-zh3NNj78';
                const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Dane&v=${new Date().getTime()}`;
                try {
                    const response = await fetch(sheetURL);
                    const csvText = await response.text();
                    const rows = csvText.trim().split('\n');
                    const headers = rows.shift().split(',').map(h => h.trim().replace(/"/g, ''));
                    allData = rows.map(row => {
    const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
    const obj = {};
    headers.forEach((header, index) => obj[header] = values[index]?.trim().replace(/"/g, '') || '');
    return obj;
  }).filter(item => item.Visible?.toLowerCase() !== 'false');

                    const mainModels = allData.filter(d => ['krzesÅ‚o', 'kubeÅ‚ek'].includes(d.Grupa.toLowerCase()));
                    renderOptions('model-thumbnails', mainModels, item => loadModel(item));
                    showScreen('models');

                    // ZAWSZE na starcie Å‚aduj Default.glb (nie ustawiaj selectedChair!)
                    if (currentModelContainer) {
                        viewer.scene.remove(currentModelContainer);
                        if (typeof currentModelContainer.dispose === 'function') currentModelContainer.dispose();
                    }
                    currentModelContainer = await viewer.load('chairs/Default.glb', { autoCenter: true });
                    setCameraView(new Vector3(0, 0, 0));
                    selectedChair = null;
                    selectedLeg = null;
                    selectedMaterials = {};
                    userInteracted = false;
                    updateSummary();
                } catch (e) { console.error("BÅ‚Ä…d Å‚adowania danych:", e); document.body.innerHTML = `BÅ‚Ä…d Å‚adowania danych: ${e.message}`; }
            }

            function generateSummaryText() {
                let text = ""; let totalPrice = 0;
                if (selectedChair) {
                    const price = parseFloat(selectedChair.Cena) || 0;
                    text += `Model: ${selectedChair.Nazwa} (${price.toFixed(2)} PLN)\n`;
                    totalPrice += price;
                }
                const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'legs_material'];
                const iconPlaceholders = [selectedChair];
                const detailPlaceholders = { 'Model': selectedChair };

                partOrder.forEach(partKey => {
                    if (selectedMaterials[partKey]) {
                        iconPlaceholders.push(selectedMaterials[partKey]);
                        detailPlaceholders[partKey.replace(/_/g, ' ')] = selectedMaterials[partKey];
                    } else {
                        iconPlaceholders.push(null);
                    }
                });

                return { text, totalPrice };
            }

            function updateSummary() {
                const overviewPanel = document.getElementById('config-overview');
                const overviewIconsDiv = document.getElementById("overview-icons");
                const overviewDetailsDiv = document.getElementById("overview-details");
                const overviewTotalPriceSpan = document.getElementById("overview-total-price");

                overviewIconsDiv.innerHTML = '';
                overviewDetailsDiv.innerHTML = '';
                overviewTotalPriceSpan.textContent = `0.00 PLN`;

                // JeÅ›li nie byÅ‚o interakcji, nie pokazuj szczegÃ³Å‚Ã³w
                if (!userInteracted) {
                    document.getElementById("selected-chair-name").textContent = `Wybrany model: Brak`;
                    overviewPanel.style.display = 'block';
                    return;
                }

                // KolejnoÅ›Ä‡ elementÃ³w do podsumowania
                const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'legs_material'];
                const partLabels = ['Siedzisko', 'Oparcie wew.', 'Oparcie zew.', 'Nogi'];

                // Ikonka modelu
                if (userInteracted && selectedChair && (selectedChair.Obrazek || selectedChair.Image)) {
                    const icon = document.createElement('img');
                    icon.src = selectedChair.Obrazek || selectedChair.Image;
                    icon.title = selectedChair.Nazwa;
                    icon.className = 'model-image'; // <-- dodaj tÄ™ klasÄ™!
                    overviewIconsDiv.appendChild(icon);
                }

                // Ikonki materiaÅ‚Ã³w dla kaÅ¼dego elementu
                partOrder.forEach((partKey, idx) => {
                    const mat = selectedMaterials[partKey];
                    if (mat && (mat.Obrazek || mat.Image)) {
                        const icon = document.createElement('img');
                        icon.src = mat.Obrazek || mat.Image;
                        icon.title = mat.Nazwa;
                        overviewIconsDiv.appendChild(icon);
                    }
                });

                // Ikonka wybranego wariantu nÃ³g (jeÅ›li jest)
                if (selectedLeg && (selectedLeg.Obrazek || selectedLeg.Image)) {
                    const icon = document.createElement('img');
                    icon.src = selectedLeg.Obrazek || selectedLeg.Image;
                    icon.title = selectedLeg.Nazwa;
                    overviewIconsDiv.appendChild(icon);
                }

                // SzczegÃ³Å‚y i ceny
                let totalPrice = 0;
                if (selectedChair && selectedChair.Cena) {
                    const price = parseFloat(selectedChair.Cena) || 0;
                    totalPrice += price;
                    const detailLine = document.createElement('div');
                    detailLine.className = 'detail-item';
                    const label = (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'krzesÅ‚o') ? 'KrzesÅ‚o' : 'Model';
                    detailLine.innerHTML = `<span>${label}: ${selectedChair.Nazwa}</span><strong>: ${price.toFixed(2)} PLN</strong>`;
                    overviewDetailsDiv.appendChild(detailLine);
                }
                partOrder.forEach((partKey, idx) => {
                    const mat = selectedMaterials[partKey];
                    if (mat) {
                        const price = parseFloat(mat.Cena) || 0;
                        totalPrice += price;
                        const detailLine = document.createElement('div');
                        detailLine.className = 'detail-item';
                        detailLine.innerHTML = `<span>${partLabels[idx]}: ${mat.Nazwa}</span><strong>: ${price.toFixed(2)} PLN</strong>`;
                        overviewDetailsDiv.appendChild(detailLine);
                    }
                });
                // Dodano szczegÃ³Å‚y wariantu nÃ³g
                if (selectedLeg) {
                    const price = parseFloat(selectedLeg.Cena) || 0;
                    const detailLine = document.createElement('div');
                    detailLine.className = 'detail-item';
                    detailLine.innerHTML = `<span>Wariant nÃ³g: ${selectedLeg.Nazwa}</span><strong>: ${price.toFixed(2)} PLN</strong>`;
                    overviewDetailsDiv.appendChild(detailLine);
                }
                const hr = document.createElement('hr');
                overviewDetailsDiv.appendChild(hr);

                overviewTotalPriceSpan.textContent = `${totalPrice.toFixed(2)} PLN`;
                document.getElementById("selected-chair-name").textContent = `Wybrany model: ${selectedChair ? selectedChair.Nazwa : "Brak"}`;
                overviewPanel.style.display = selectedChair ? 'block' : 'none';
            }

            function enforceZoomLimits() {
                if (viewer && viewer.controls) {
                    viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
                    viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
                    viewer.controls.enableDamping = true;
                    viewer.controls.dampingFactor = 0.1;
                    viewer.controls.update();
                }
            }

            function clampCameraDistance() {
                if (!viewer || !viewer.scene || !viewer.scene.activeCamera || !viewer.controls) return;
                const camera = viewer.scene.activeCamera;
                const target = viewer.controls.target;
                const pos = camera.position;
                const dist = pos.distanceTo(target);

                if (dist < MIN_ZOOM_DISTANCE) {
                    // PrzesuÅ„ kamerÄ™ na sferÄ™ o promieniu MIN_ZOOM_DISTANCE od targetu
                    const dir = pos.clone().sub(target).normalize();
                    camera.position.copy(target.clone().add(dir.multiplyScalar(MIN_ZOOM_DISTANCE)));
                    camera.updateProjectionMatrix();
                    viewer.controls.update();
                }
                if (dist > MAX_ZOOM_DISTANCE) {
                    // PrzesuÅ„ kamerÄ™ na sferÄ™ o promieniu MAX_ZOOM_DISTANCE od targetu
                    const dir = pos.clone().sub(target).normalize();
                    camera.position.copy(target.clone().add(dir.multiplyScalar(MAX_ZOOM_DISTANCE)));
                    camera.updateProjectionMatrix();
                    viewer.controls.update();
                }
            }


            // Nowa funkcja do ograniczeÅ„ zoomu w obrÄ™bie baÅ„ki
            function forceBubbleZoomLimitsEachFrame() {
                if (!viewer || !viewer.scene || !viewer.scene.activeCamera) return;
                const camera = viewer.scene.activeCamera;
                // Åšrodek baÅ„ki â€“ moÅ¼esz zmieniÄ‡ na inny punkt jeÅ›li trzeba
                const bubbleCenter = new Vector3(0, 0, 0);
                const pos = camera.position;
                const dist = pos.distanceTo(bubbleCenter);

                if (dist < MIN_ZOOM_DISTANCE) {
                    const dir = pos.clone().sub(bubbleCenter).normalize();
                    camera.position.copy(bubbleCenter.clone().add(dir.multiplyScalar(MIN_ZOOM_DISTANCE)));
                    camera.updateProjectionMatrix();
                    if (viewer.controls) viewer.controls.update();
                }
                if (dist > MAX_ZOOM_DISTANCE) {
                    const dir = pos.clone().sub(bubbleCenter).normalize();
                    camera.position.copy(bubbleCenter.clone().add(dir.multiplyScalar(MAX_ZOOM_DISTANCE)));
                    camera.updateProjectionMatrix();
                    if (viewer.controls) viewer.controls.update();
                }
            }

            // Uruchom sprawdzanie w kaÅ¼dej klatce
            function animateBubbleZoomLimit() {
                forceBubbleZoomLimitsEachFrame();
                requestAnimationFrame(animateBubbleZoomLimit);
            }
            animateBubbleZoomLimit();


            init();

            // PokaÅ¼/ukryj popup
const emailModal = document.getElementById('emailModal');
const closeBtn = emailModal.querySelector('.close-button');
const buyButton = document.getElementById('buy-button');
const emailForm = document.getElementById('emailForm');
const successMessage = document.getElementById('success-message');

buyButton.addEventListener('click', () => {
  emailModal.classList.remove('hidden');
  emailModal.classList.add('visible');
  successMessage.classList.remove('visible'); // ukryj komunikat na otwarciu
  successMessage.classList.add('hidden');
});

closeBtn.addEventListener('click', () => {
  emailModal.classList.remove('visible');
  emailModal.classList.add('hidden');
});

emailModal.addEventListener('click', (e) => {
  if (e.target === emailModal) {
    emailModal.classList.remove('visible');
    emailModal.classList.add('hidden');
  }
});

emailForm.addEventListener('submit', (e) => {
  e.preventDefault();

  // Tutaj wysyÅ‚ka danych formularza (jeÅ›li masz backend)
  // MoÅ¼na dodaÄ‡ fetch lub EmailJS

  // Po wysÅ‚aniu:
  emailModal.classList.remove('visible');
  emailModal.classList.add('hidden');

  successMessage.classList.remove('hidden');
  successMessage.classList.add('visible');

  setTimeout(() => {
    successMessage.classList.remove('visible');
    successMessage.classList.add('hidden');
  }, 3000);

  emailForm.reset(); // wyczyÅ›Ä‡ formularz
});






    </script>
</body>

</html>