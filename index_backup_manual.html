<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FK Configurator - Nowy</title>
    <link rel="icon" href="icons/favicon.png" type="image/jpeg" />
    
    <!-- 📱 DEVICE DETECTION -->
    <script>
        window.isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        window.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        window.isAndroid = /Android/i.test(navigator.userAgent);
        window.screenWidth = window.screen.width;
        window.isSmallScreen = window.screenWidth <= 768;
        
        console.log('🔍 Device detection:', {
            isMobile: window.isMobile,
            isIOS: window.isIOS,
            screenWidth: window.screenWidth
        });
        
        // 📱 ORIENTATION CHECK
        function checkOrientation() {
            if (window.isMobile || window.isSmallScreen) {
                const orientationWarning = document.getElementById('orientation-warning');
                const app = document.getElementById('app');
                const loader = document.getElementById('custom-loader');
                
                // Sprawdź orientację
                const isPortrait = window.innerHeight > window.innerWidth;
                
                if (isPortrait) {
                    // Urządzenie w pionie - pokaż ostrzeżenie
                    if (orientationWarning) {
                        orientationWarning.style.display = 'flex';
                    }
                    if (app) {
                        app.style.display = 'none';
                    }
                    if (loader) {
                        loader.style.display = 'none';
                    }
                } else {
                    // Urządzenie w poziomie - ukryj ostrzeżenie
                    if (orientationWarning) {
                        orientationWarning.style.display = 'none';
                    }
                    if (app) {
                        app.style.display = 'flex';
                    }
                    // Loader będzie zarządzany przez główną logikę
                }
            }
        }
        
        // Sprawdź orientację przy ładowaniu i przy obrocie
        document.addEventListener('DOMContentLoaded', checkOrientation);
        window.addEventListener('orientationchange', () => {
            setTimeout(checkOrientation, 100); // Małe opóźnienie na zmianę orientacji
        });
        window.addEventListener('resize', checkOrientation);
    </script>
    
    <!-- 🎬 THREE.JS IMPORTS -->
    <script type="importmap">
    {
      "imports": {
        "threepipe": "https://unpkg.com/threepipe@latest/dist/index.mjs",
        "@threepipe/webgi-plugins": "https://unpkg.com/@threepipe/webgi-plugins@latest/dist/index.mjs",
        "three": "https://unpkg.com/three@0.157.0/build/three.module.js"
      }
    }
    </script>
    
    <!-- 🎨 PODSTAWOWE STYLE -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            overflow: hidden;
        }
        
        /* 🔄 LOADER STYLES */
        #custom-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        /* 📱 ORIENTATION WARNING */
        #orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2c3e50;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
            text-align: center;
        }
        
        #orientation-warning .rotate-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: phoneRotate 2s ease-in-out infinite;
        }
        
        @keyframes phoneRotate {
            0% { 
                transform: rotate(0deg);
            }
            50% { 
                transform: rotate(90deg);
            }
            100% { 
                transform: rotate(0deg);
            }
        }
        
        #orientation-warning h2 {
            font-size: 24px;
            color: #ffffff;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        #orientation-warning p {
            font-size: 16px;
            color: #ecf0f1;
            line-height: 1.5;
            max-width: 300px;
        }
        
        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
            visibility: hidden;
            opacity: 0;
        }

        #app.visible {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        /* 🖥️ CANVAS */
        #canvas {
            flex: 1;
            width: calc(100vw - 350px);
            height: 100%;
            background: #f0f0f0;
            position: relative;
            display: block;
            outline: none;
            cursor: grab;
        }
        
        #canvas:active {
            cursor: grabbing;
        }
        
        #viewer-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* 🎯 WELCOME SCREEN */
        #welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 350px;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.5s ease;
        }
        
        #welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        
        #welcome-screen h1 {
            font-size: 2em;
            color: #000;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 300;
        }
        
        #welcome-screen p {
            font-size: 1.2em;
            color: #666;
            text-align: center;
            margin-bottom: 40px;
            max-width: 400px;
            line-height: 1.6;
        }
        
        #welcome-logo {
            width: 200px;
            height: auto;
            margin-bottom: 30px;
            opacity: 0.9;
            border-radius: 10px;
            animation: logoPulse 3s ease-in-out infinite;
        }
        
        /* 📱 SIDEBAR */
        #sidebar {
            width: 350px;
            background: #fff;
            color: #333;
            border-left: 1px solid #e0e0e0;
            box-shadow: 0 4px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        /* 🔍 SEARCH */
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            color: #333;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .search-input::placeholder {
            color: #999;
        }
        
        /* 🏷️ CATEGORIES */
        .categories {
            margin-bottom: 20px;
        }
        
        .category-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: space-between;
        }
        
        .category-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #fff;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 0;
            position: relative;
        }
        
        .category-btn:hover {
            border-color: #666;
            background: #f5f5f5;
            color: #333;
            transform: translateY(-1px);
        }
        
        .category-btn.active {
            border-color: #FFD700;
            background: #fff;
            color: #333;
        }
        
        .category-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 6px;
        }
        
        .category-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0); /* czarne ikony */
        }
        
        .category-btn:hover .category-icon img,
        .category-btn.active .category-icon img {
            filter: brightness(0); /* czarne ikony pozostają czarne */
        }
        
        .category-label {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }
        
        /* 🪑 CHAIRS GRID */
        .chairs-section {
            margin-bottom: 20px;
        }
        
        .chairs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .chair-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
        }
        
        .chair-item:hover {
            border-color: #666;
            background: #f5f5f5;
            color: #333;
        }
        
        .chair-item.selected {
            border-color: #FFD700;
            background: #fff;
            color: #333;
        }
        
        .chair-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 5px;
            filter: brightness(0); /* czarne ikony */
        }
        
        .chair-item:hover img,
        .chair-item.selected img {
            filter: brightness(0); /* czarne ikony pozostają czarne */
        }
        
        .chair-name {
            font-size: 11px;
            font-weight: 600;
        }
        
        /* 🔧 THUMBNAIL STYLES (for renderOptions) */
        .thumbnail-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .thumbnail {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 80px;
        }
        
        .thumbnail:hover {
            border-color: #666;
            background: #f5f5f5;
            transform: scale(1.05);
        }
        
        .thumbnail.selected {
            border-color: #FFD700;
            background: #fff;
        }
        
        .thumbnail img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            filter: brightness(0); /* czarne ikony */
        }
        
        .thumbnail:hover img,
        .thumbnail.selected img {
            filter: brightness(0); /* czarne ikony pozostają czarne */
        }
        
        .thumbnail-caption {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            margin-top: 5px;
            color: #333;
        }
        
        .thumbnail:hover .thumbnail-caption,
        .thumbnail.selected .thumbnail-caption {
            color: #333;
        }
        
        /* 📱 MOBILE RESPONSIVE - tylko landscape (poziomo) */
        @media (max-width: 820px) and (orientation: landscape) {
            #app {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: 40vh;
                order: 2;
                border-left: none;
                border-top: 1px solid #e0e0e0;
            }
            
            #canvas {
                order: 1;
                height: 60vh;
                width: 100%;
            }
            
            #welcome-screen {
                right: 0;
                z-index: 60;
            }
            
            #welcome-screen h1 {
                font-size: 1.4em;
                margin-bottom: 8px;
            }
            
            #welcome-screen p {
                font-size: 0.8em;
                margin-bottom: 15px;
                padding: 0 8px;
            }
            
            #welcome-logo {
                width: 100px;
                margin-bottom: 15px;
            }
            
            .category-grid {
                flex-direction: column;
                gap: 6px;
            }
            
            .category-btn {
                flex-direction: row;
                padding: 8px 12px;
                justify-content: flex-start;
            }
            
            .category-icon {
                width: 24px;
                height: 24px;
                margin-bottom: 0;
                margin-right: 8px;
            }
            
            .category-label {
                font-size: 10px;
                text-align: left;
            }
            
            .chairs-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .chair-item {
                padding: 8px;
            }
            
            .chair-item img {
                width: 40px;
                height: 40px;
            }
            
            .chair-name {
                font-size: 9px;
            }
            
            /* 📱 MOBILE THUMBNAIL STYLES */
            .thumbnail {
                min-height: 60px;
                padding: 6px;
            }
            
            .thumbnail img {
                width: 40px;
                height: 40px;
            }
            
            .thumbnail-caption {
                font-size: 9px;
                margin-top: 3px;
            }
        }
        
        /* 📱 MOBILE PORTRAIT - ukryj app, pokaż orientation warning */
        @media (max-width: 820px) and (orientation: portrait) {
            #app {
                display: none !important;
            }
            
            #custom-loader {
                display: none !important;
            }
            
            #orientation-warning {
                display: flex !important;
            }
        }
    </style>
</head>
<body>
    <!-- 📱 ORIENTATION WARNING - dla mobile w pionie -->
    <div id="orientation-warning">
        <div class="rotate-icon">📱</div>
        <h2>Obróć urządzenie</h2>
        <p>Konfigurator działa najlepiej w orientacji poziomej. Obróć swoje urządzenie, aby kontynuować.</p>
    </div>

    <!-- �🔄 ANIMATED LOADER - na początku body, poza #app -->
    <div id="custom-loader">
        <!-- Logo Container -->
        <div class="logo-container" style="
            position: relative;
            margin-bottom: 40px;
            animation: logoPulse 3s ease-in-out infinite;
        ">
            <!-- Main Logo -->
            <img src="icons/FK_logo.png" alt="Fajne Krzesła" style="
                max-width: 200px; 
                height: auto;
                border-radius: 10px;
                opacity: 0.9;
            " />
        </div>
        
        <!-- Spinner -->
        <div class="spinner" style="
            width: 40px;
            height: 40px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        "></div>
        
        <!-- Progress Bar -->
        <div class="progress-container" style="
            width: 280px;
            height: 3px;
            background: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 25px;
        ">
            <div class="progress-bar" style="
                width: 100%;
                height: 100%;
                background: #FFD700;
                animation: progressSlide 2s ease-in-out infinite;
            "></div>
        </div>
        
        <!-- Loading Text -->
        <div class="loading-text" style="
            font-size: 16px; 
            color: #333;
            font-weight: 500;
            text-align: center;
            letter-spacing: 0.5px;
        ">Ładowanie interfejsu</div>
    </div>

    <div id="app">
        
        <style>
            /* 🎬 LOADER ANIMATIONS - minimalistyczne */
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @keyframes progressSlide {
                0% { transform: translateX(-100%); }
                50% { transform: translateX(0%); }
                100% { transform: translateX(100%); }
            }
            
            @keyframes logoPulse {
                0%, 100% { 
                    opacity: 0.8;
                    transform: scale(1);
                }
                50% { 
                    opacity: 1;
                    transform: scale(1.05);
                }
            }
            
            @keyframes rotateIcon {
                0%, 100% { 
                    transform: rotate(0deg);
                }
                25% { 
                    transform: rotate(90deg);
                }
                75% { 
                    transform: rotate(90deg);
                }
            }
        </style>
        </style>
        
        <!-- 🖥️ CANVAS -->
        <div id="canvas">
            <canvas id="viewer-canvas"></canvas>
        </div>
        
        <!-- 🎯 WELCOME SCREEN -->
        <div id="welcome-screen">
            <img id="welcome-logo" src="icons/FK_logo.png" alt="Fajne Krzesła">
            <h1>Konfigurator Krzeseł</h1>
            <p>Wybierz model krzesła z dostępnych kategorii w bocznym panelu, aby rozpocząć konfigurację w 3D</p>
        </div>
        
        <!-- 📱 SIDEBAR -->
        <div id="sidebar">
            <!-- 🔍 SEARCH -->
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Szukaj krzesła...">
            </div>
            
            <!-- 🏷️ CATEGORIES -->
            <div class="categories">
                <div class="category-grid">
                    <div class="category-btn" data-category="krzesla">
                        <div class="category-icon">
                            <img src="icons/chair_icon.png" alt="Krzesła" onerror="this.src='icons/placeholder.svg'">
                        </div>
                        <div class="category-label">Krzesła</div>
                    </div>
                    <div class="category-btn" data-category="hooker">
                        <div class="category-icon">
                            <img src="icons/legs_icon.png" alt="Hooker" onerror="this.src='icons/placeholder.svg'">
                        </div>
                        <div class="category-label">Hooker</div>
                    </div>
                    <div class="category-btn" data-category="biurowe">
                        <div class="category-icon">
                            <img src="icons/export_icon.png" alt="Biurowe" onerror="this.src='icons/placeholder.svg'">
                        </div>
                        <div class="category-label">Biurowe</div>
                    </div>
                    <div class="category-btn" data-category="ogrodowe">
                        <div class="category-icon">
                            <img src="icons/bulb_icon.png" alt="Ogrodowe" onerror="this.src='icons/placeholder.svg'">
                        </div>
                        <div class="category-label">Ogrodowe</div>
                    </div>
                </div>
            </div>
            
            <!-- 🪑 CHAIRS -->
            <div class="chairs-section">
                <div id="chairs-grid" class="chairs-grid">
                    <!-- Chairs will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 🎬 THREE.JS IMPORTS - wszystkie potrzebne z backup
        import {
            Group,
            Box3,
            Vector3,
            ArrowHelper,
            Sprite,
            SpriteMaterial,
            CanvasTexture,
            Color,
            TextureLoader
        } from 'three';

        // ThreePipe core – viewer i pluginy
        import {
            ThreeViewer,
            LoadingScreenPlugin,
            GBufferPlugin,
            SSAAPlugin,
        } from 'threepipe';

        // Pluginy z WebGI (ThreePipe)
        import {
            SSReflectionPlugin,
            BloomPlugin
        } from '@threepipe/webgi-plugins';

        // 🌍 GLOBALNE ZMIENNE
        let allData = [];
        let mainModels = [];
        let selectedChair = null;
        let currentCategory = 'krzesla';
        let viewer, currentModelContainer, currentLegModel;
        let selectedLeg, selectedMaterials = {};
        
        // 🎯 CAMERA SETTINGS
        const CAMERA_FOV = 12;
        const CAMERA_POSITION = { x: -4.50, y: 0.28, z: 4.53 };
        const CAMERA_TARGET = { x: 1, y: -0.5, z: 2 };
        const MIN_ZOOM_DISTANCE = 1;
        const MAX_ZOOM_DISTANCE = 8;
        
        // 🚀 INICJALIZACJA 3D VIEWERA
        async function init3DViewer() {
            console.log('🚀 Inicjalizacja 3D Viewer...');
            
            const canvas = document.getElementById("viewer-canvas");
            if (!canvas) {
                console.error('❌ Canvas nie znaleziony!');
                return false;
            }
            
            // 📱 Sprawdź specjalne przypadki dla iOS Safari
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            
            if (isIOS) {
                console.log('📱 Wykryto urządzenie iOS - zastosowanie optymalizacji...');
                
                // Dostosuj canvas dla iOS
                canvas.style.touchAction = 'none'; // Zapobiegaj scroll na touch
                canvas.style.webkitTouchCallout = 'none'; // Wyłącz menu kontekstowe
                canvas.style.webkitUserSelect = 'none'; // Wyłącz selekcję tekstu
            }
            
            try {
                console.log('🚀 Inicjalizacja ThreeViewer...');
                viewer = new ThreeViewer({
                    canvas: canvas,
                    plugins: [GBufferPlugin, SSAAPlugin, SSReflectionPlugin, BloomPlugin],
                    rendererSettings: { 
                        antialias: true,
                        alpha: true,
                        premultipliedAlpha: false,
                        preserveDrawingBuffer: false,
                        powerPreference: "high-performance"
                    }
                });
                
                console.log('✅ ThreeViewer zainicjalizowany');
                
                // Ustaw kamerę
                if (viewer.scene?.activeCamera) {
                    const camera = viewer.scene.activeCamera;
                    camera.position.set(CAMERA_POSITION.x, CAMERA_POSITION.y, CAMERA_POSITION.z);
                    camera.fov = CAMERA_FOV;
                    camera.updateProjectionMatrix();
                }
                
                // Ustaw kontrolki
                if (viewer.controls) {
                    viewer.controls.target.set(CAMERA_TARGET.x, CAMERA_TARGET.y, CAMERA_TARGET.z);
                    viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
                    viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
                    viewer.controls.dampingFactor = 0.1;
                    viewer.controls.enableDamping = true;
                    viewer.controls.update();
                }
                
                // 🌅 ŁADOWANIE HDR dla oświetlenia - z backup'a
                try {
                    console.log('🌅 Ładowanie HDR...');
                    const hdrPromise = viewer.setEnvironmentMap("hdr/hamburg_hbf_1k.hdr", { isHDR: true });
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('HDR loading timeout')), 10000)
                    );
                    
                    await Promise.race([hdrPromise, timeoutPromise]);
                    console.log('✅ HDR załadowane pomyślnie');
                } catch (e) { 
                    console.warn("⚠️ Błąd ładowania HDR (kontynuujemy bez HDR):", e);
                    // Nie przerywamy ładowania - kontynuujemy bez HDR
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Błąd inicjalizacji ThreeViewer:', error);
                
                const loader = document.getElementById('custom-loader');
                if (loader) {
                    loader.innerHTML = `
                        <img src="icons/FK_Logo.jpg" alt="Fajne Krzesła" style="
                            max-width: 200px; 
                            margin-bottom: 20px;
                            border-radius: 10px;
                        " />
                        <p style="
                            color: #FFD700; 
                            text-align: center;
                            font-size: 18px;
                            background: rgba(0,0,0,0.8);
                            padding: 20px;
                            border-radius: 10px;
                            border: 2px solid #FFD700;
                        ">
                            ❌ Błąd inicjalizacji 3D: ${error.message}<br><br>
                            🔄 Spróbuj odświeżyć stronę
                        </p>
                    `;
                }
                return false;
            }
        }
        
        // 🎯 FUNKCJA POKAZUJĄCA UI PO PIERWSZYM WYBORZE KRZESŁA - z backup'a
        function showAfterFirstSelection() {
            console.log('🎯 Pokazuję interfejs po wyborze krzesła...');
            
            // Ukryj welcome screen
            const welcomeScreen = document.getElementById('welcome-screen');
            if (welcomeScreen && !welcomeScreen.classList.contains('hidden')) {
                welcomeScreen.classList.add('hidden');
                console.log('✅ Welcome screen ukryty');
            }
            
            console.log('✅ Canvas 3D już widoczny');
            console.log('✅ Sidebar już widoczny');
        }
        
        // 🪑 ŁADOWANIE MODELU 3D - rozszerzone
        async function loadChairModel(chairData) {
            if (!viewer) {
                console.error('❌ Viewer nie zainicjalizowany!');
                return;
            }
            
            console.log('🪑 Ładowanie modelu:', chairData.Nazwa);
            
            // Pokaż UI po pierwszym wyborze krzesła
            showAfterFirstSelection();
            
            try {
                // Usuń poprzedni model
                if (currentModelContainer) {
                    viewer.scene.remove(currentModelContainer);
                    currentModelContainer = null;
                }
                
                // Ścieżka do modelu
                const modelPath = `chairs/${chairData.Nazwa}.glb`;
                
                // Załaduj nowy model
                const result = await viewer.load(modelPath);
                currentModelContainer = result;
                
                console.log('✅ Model załadowany:', chairData.Nazwa);
                
                // Wyśrodkuj model i ustaw kamerę - z backup'a
                if (currentModelContainer) {
                    const box = new Box3().setFromObject(currentModelContainer);
                    const center = box.getCenter(new Vector3());
                    currentModelContainer.position.sub(center);
                    
                    // Dostosuj kamerę do modelu
                    if (viewer.controls) {
                        viewer.controls.target.set(CAMERA_TARGET.x, CAMERA_TARGET.y, CAMERA_TARGET.z);
                        viewer.controls.update();
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Błąd ładowania modelu:', error);
                return false;
            }
        }
        
        // 🔧 RENDER OPTIONS (do wyświetlania miniatur)
        function renderOptions(containerId, items, onSelect, isInteractive = true) {
            console.log(`🔄 renderOptions dla ${containerId} z ${items.length} elementami`);
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`❌ Kontener ${containerId} nie istnieje!`);
                return;
            }
            
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'thumbnail-wrapper';
                
                const button = document.createElement('div');
                button.className = 'thumbnail';
                button.title = item.Nazwa;

                if (isInteractive) {
                    button.addEventListener('click', () => {
                        onSelect(item);
                        container.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
                        button.classList.add('selected');
                    });
                }
                
                const img = document.createElement('img');
                let imageSrc = item.Obrazek || item.Image || 'icons/chair_icon.png';
                
                // Normalizuj ścieżki
                if (imageSrc.startsWith('./')) {
                    imageSrc = imageSrc.substring(2);
                }
                if (!imageSrc.startsWith('http') && !imageSrc.startsWith('/')) {
                    imageSrc = './' + imageSrc;
                }
                
                img.src = imageSrc;
                img.alt = item.Nazwa || 'Bez nazwy';
                img.onerror = () => { img.src = './icons/chair_icon.png'; };
                
                button.appendChild(img);
                
                const caption = document.createElement('div');
                caption.className = 'thumbnail-caption';
                caption.textContent = item.Nazwa;
                
                wrapper.appendChild(button);
                wrapper.appendChild(caption);
                container.appendChild(wrapper);
            });
        }
        
        // 🌍 GLOBALNE ZMIENNE - USUNIĘTA DUPLIKACJA
        // let allData = []; - już zadeklarowana wyżej
        // let mainModels = []; - już zadeklarowana wyżej  
        // let selectedChair = null; - już zadeklarowana wyżej
        // let currentCategory = 'krzesla'; - już zadeklarowana wyżej
        
        // 📊 ŁADOWANIE DANYCH Z GOOGLE SHEETS - poprawiony z backup'a
        async function loadDataFromSheet() {
            console.log('📊 Loading data from Google Sheets...');
            
            const sheetId = '1vCs6YeHgKqlYwg8rvJOqVzNRnXeATJCBuK-zh3NNj78';
            const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Dane&v=${new Date().getTime()}`;
            
            try {
                console.log('🔄 Ładowanie danych z arkusza...');
                console.log('📡 URL:', sheetURL);
                
                let attemptCount = 0;
                const maxAttempts = 3;
                let lastError;
                
                while (attemptCount < maxAttempts) {
                    attemptCount++;
                    console.log(`🔄 Próba ${attemptCount}/${maxAttempts}...`);
                    
                    try {
                        const fetchPromise = fetch(sheetURL + '?nocache=' + Date.now(), { 
                            cache: 'no-store',
                            mode: 'cors',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache',
                                'Accept': 'text/csv,*/*'
                            }
                        });
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Fetch timeout - sprawdź połączenie')), 15000 + (attemptCount * 5000))
                        );
                        
                        const response = await Promise.race([fetchPromise, timeoutPromise]);
                        console.log('📡 Response status:', response.status, response.statusText);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const csvText = await response.text();
                        console.log('📄 CSV length:', csvText.length);
                        
                        if (csvText.length < 100) {
                            throw new Error('CSV data too short - możliwe problemy z połączeniem');
                        }
                        
                        // Sukces - dane załadowane
                        const rows = csvText.trim().split('\n');
                        const headers = rows.shift().split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        allData = rows.map(row => {
                            const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                            const obj = {};
                            headers.forEach((header, index) => obj[header] = values[index]?.trim().replace(/"/g, '') || '');
                            return obj;
                        }).filter(item => item.Visible?.toLowerCase() !== 'false');

                        console.log('✅ Dane załadowane:', allData.length, 'elementów');
                        console.log('📊 Przykładowe dane:', allData.slice(0, 2));
                        console.log('📊 Wszystkie kolumny w pierwszym elemencie:', Object.keys(allData[0] || {}));
                        break; // Wyjdź z pętli - sukces!
                        
                    } catch (attemptError) {
                        lastError = attemptError;
                        console.error(`❌ Próba ${attemptCount} nieudana:`, attemptError.message);
                        
                        if (attemptCount >= maxAttempts) {
                            throw lastError; // Rzuć ostatni błąd
                        }
                        
                        // Czekaj przed kolejną próbą
                        const waitTime = attemptCount * 2000; // 2s, 4s, 6s
                        console.log(`⏱️ Czekam ${waitTime/1000}s przed kolejną próbą...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                }

                // Filter main models (chairs) - z backup'a
                const mainModelsFromData = allData.filter(d => {
                    const grupa = (d.Grupa || d.Group || d.grupa || '').toLowerCase();
                    const typ = (d.Typ || d.Type || d.typ || '').toLowerCase();
                    const kategoria = (d.Kategoria || d.Category || d.kategoria || '').toLowerCase();
                    
                    return ['krzesło', 'kubełek', 'chair', 'bucket'].some(term => 
                        grupa.includes(term) || typ.includes(term) || kategoria.includes(term)
                    );
                });
                
                // 🔧 ZAPISZ GLOBALNIE
                mainModels = mainModelsFromData;
                window.mainModels = mainModels;
                
                console.log('🪑 Modele główne:', mainModels.length);
                console.log('🪑 Przykładowe modele:', mainModels.slice(0, 3));
                
                // Jeśli nie ma głównych modeli, pokaż wszystkie dane dla debugowania
                if (mainModels.length === 0) {
                    console.warn('⚠️ Nie znaleziono głównych modeli, używam wszystkich danych');
                    mainModels = allData.slice(0, 10); // pierwsze 10 dla testu
                }
                
                // Initialize UI
                initializeApp();
                
            } catch (error) {
                console.error('❌ Error loading data:', error);
                // Fallback data for testing
                mainModels = [
                    { Nazwa: 'Amy-2', Kategoria: 'krzesla', Obrazek: 'icons/chair_icon.png' },
                    { Nazwa: 'Ava', Kategoria: 'hooker', Obrazek: 'icons/chair_icon.png' },
                    { Nazwa: 'Carine', Kategoria: 'biurowe', Obrazek: 'icons/chair_icon.png' }
                ];
                initializeApp();
            }
        }
        
        // 🎯 INICJALIZACJA APLIKACJI
        function initializeApp() {
            console.log('🎯 Initializing app...');
            
            setupCategoryButtons();
            setupSearch();
            setDefaultCategory();
            renderChairs();
        }
        
        // 🏷️ SETUP CATEGORY BUTTONS
        function setupCategoryButtons() {
            console.log('🏷️ Setting up category buttons...');
            
            const categoryBtns = document.querySelectorAll('.category-btn');
            
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const category = btn.getAttribute('data-category');
                    console.log('🏷️ Category clicked:', category);
                    
                    // Update active state
                    categoryBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Update current category
                    currentCategory = category;
                    
                    // Filter chairs
                    filterChairsByCategory(category);
                });
            });
        }
        
        // 🔍 SETUP SEARCH
        function setupSearch() {
            console.log('🔍 Setting up search...');
            
            const searchInput = document.getElementById('search-input');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    console.log('🔍 Search term:', searchTerm);
                    
                    // Clear category selection when searching
                    if (searchTerm) {
                        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                        currentCategory = null;
                    }
                    
                    // Filter chairs
                    filterChairsBySearch(searchTerm);
                });
            }
        }
        
        // 🎯 SET DEFAULT CATEGORY
        function setDefaultCategory() {
            console.log('🎯 Setting default category...');
            
            const defaultBtn = document.querySelector('.category-btn[data-category="krzesla"]');
            if (defaultBtn) {
                defaultBtn.classList.add('active');
                currentCategory = 'krzesla';
            }
        }
        
        // 🏷️ FILTER CHAIRS BY CATEGORY
        function filterChairsByCategory(category) {
            console.log('🏷️ Filtering by category:', category);
            
            const filteredChairs = mainModels.filter(chair => {
                const chairCategory = (chair.Kategoria || '').toLowerCase().trim();
                return chairCategory === category.toLowerCase();
            });
            
            console.log('🏷️ Found chairs:', filteredChairs.length);
            renderChairs(filteredChairs);
        }
        
        // 🔍 FILTER CHAIRS BY SEARCH
        function filterChairsBySearch(searchTerm) {
            console.log('🔍 Filtering by search:', searchTerm);
            
            if (!searchTerm) {
                // If search is empty, show category or all
                if (currentCategory) {
                    filterChairsByCategory(currentCategory);
                } else {
                    renderChairs(mainModels);
                }
                return;
            }
            
            const filteredChairs = mainModels.filter(chair => {
                const chairName = (chair.Nazwa || '').toLowerCase();
                return chairName.includes(searchTerm);
            });
            
            console.log('🔍 Found chairs:', filteredChairs.length);
            renderChairs(filteredChairs);
        }
        
        // 🪑 RENDER CHAIRS
        function renderChairs(chairs = mainModels) {
            console.log('🪑 Rendering chairs:', chairs.length);
            
            // Użyj renderOptions dla spójności
            renderOptions('chairs-grid', chairs, (chair) => {
                console.log('🎯 Chair selected via renderOptions:', chair.Nazwa);
                
                // Update selection
                selectedChair = chair;
                
                // 🪑 Załaduj model 3D
                loadChairModel(chair);
                
                console.log('✅ Selected chair:', selectedChair);
            });
        }
        
        // 🎯 SELECT CHAIR
        function selectChair(chair, chairElement) {
            console.log('🎯 Chair selected:', chair.Nazwa);
            
            // Update selection
            document.querySelectorAll('.chair-item').forEach(item => item.classList.remove('selected'));
            chairElement.classList.add('selected');
            
            selectedChair = chair;
            
            // 🪑 Załaduj model 3D
            loadChairModel(chair);
            
            console.log('✅ Selected chair:', selectedChair);
        }
        
        // 🚀 START THE APP - loader widoczny od początku
        // Loader jest już widoczny dzięki CSS
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 DOM Content Loaded - Starting app...');
            
            const loader = document.getElementById('custom-loader');
            const app = document.getElementById('app');
            
            try {
                // 🎬 Aktualizuj loader - inicjalizacja 3D
                if (loader) {
                    const loadingText = loader.querySelector('.loading-text');
                    if (loadingText) loadingText.textContent = 'Inicjalizacja silnika 3D...';
                }
                
                // 🎬 Najpierw inicjalizuj 3D viewer
                const viewer3DReady = await init3DViewer();
                
                if (viewer3DReady) {
                    // 🎬 Aktualizuj loader - ładowanie danych
                    if (loader) {
                        const loadingText = loader.querySelector('.loading-text');
                        if (loadingText) loadingText.textContent = 'Ładowanie danych krzeseł...';
                    }
                    
                    // 📊 Następnie załaduj dane
                    await loadDataFromSheet();
                    
                    // 🎬 Aktualizuj loader - finalizacja
                    if (loader) {
                        const loadingText = loader.querySelector('.loading-text');
                        if (loadingText) loadingText.textContent = 'Przygotowywanie interfejsu...';
                    }
                    
                    // ✅ Ukryj loader i pokaż app po dłuższym czasie
                    setTimeout(() => {
                        console.log('🎯 Ukrywam loader i pokazuję app...');
                        
                        if (loader) {
                            loader.style.opacity = '0';
                            setTimeout(() => {
                                loader.style.display = 'none';
                                console.log('✅ Loader ukryty');
                            }, 500);
                        }
                        
                        if (app) {
                            app.style.visibility = 'visible';
                            app.style.opacity = '1';
                            app.classList.add('visible');
                            console.log('✅ App pokazany');
                        }
                        
                        console.log('✅ Aplikacja gotowa - można wybierać krzesła');
                        
                    }, 1500); // Skrócony czas na 1.5 sekundy
                    
                } else {
                    console.error('❌ Nie można uruchomić aplikacji bez 3D viewera');
                }
                
            } catch (error) {
                console.error('❌ Błąd uruchamiania aplikacji:', error);
                
                const loader = document.getElementById('custom-loader');
                if (loader) {
                    loader.innerHTML = `
                        <img src="icons/FK_Logo.jpg" alt="Fajne Krzesła" style="
                            max-width: 200px; 
                            margin-bottom: 20px;
                            border-radius: 10px;
                        " />
                        <p style="
                            color: #FFD700; 
                            text-align: center;
                            font-size: 18px;
                            background: rgba(0,0,0,0.8);
                            padding: 20px;
                            border-radius: 10px;
                            border: 2px solid #FFD700;
                        ">
                            ❌ Błąd uruchamiania: ${error.message}<br><br>
                            🔄 Spróbuj odświeżyć stronę
                        </p>
                    `;
                }
            }
        });
        
        // 📱 DEBUG FUNCTIONS
        window.debugApp = function() {
            console.log('=== 🔍 DEBUG APP STATE ===');
            console.log('Data loaded:', allData.length, 'items');
            console.log('Main models:', mainModels.length, 'chairs');
            console.log('Selected chair:', selectedChair);
            console.log('Current category:', currentCategory);
        };
        
        // 🔄 FUNKCJE LOADERA - do użycia w przyszłości
        window.showLoader = function(text = 'Ładowanie...') {
            const loader = document.getElementById('custom-loader');
            if (loader) {
                // Aktualizuj tekst jeśli podano
                const loadingText = loader.querySelector('.loading-text');
                if (loadingText && text !== 'Ładowanie...') {
                    loadingText.textContent = text;
                }
                
                loader.style.display = 'flex';
                console.log('🔄 Loader pokazany:', text);
            }
        };
        
        window.hideLoader = function() {
            const loader = document.getElementById('custom-loader');
            if (loader) {
                loader.style.display = 'none';
                console.log('✅ Loader ukryty');
            }
        };
        
        // Przykład użycia dla przyszłych funkcji:
        // window.showLoader('Przygotowywanie pokoju 3D...');
        // await loadRoomViewer();
        // window.hideLoader();
    </script>
</body>
</html>
