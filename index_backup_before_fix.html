<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FK Configurator - Nowy</title>
    <link rel="icon" href="icons/favicon.png" type="image/jpeg" />
    
    <!-- üì± Preload dla iOS - tylko logo (HDR ≈Çadowany p√≥≈∫niej) -->
    <link rel="preload" href="icons/FK_logo.png" as="image" type="image/png">
    
    <!-- üì± DEVICE DETECTION -->
    <script>
        window.isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        window.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        window.isAndroid = /Android/i.test(navigator.userAgent);
        window.screenWidth = window.screen.width;
        window.isSmallScreen = window.screenWidth <= 768;
        
        console.log('üîç Device detection:', {
            isMobile: window.isMobile,
            isIOS: window.isIOS,
            screenWidth: window.screenWidth
        });
        
        // üì± ORIENTATION CHECK - poprawiona logika
        function checkOrientation() {
            const orientationWarning = document.getElementById('orientation-warning');
            const app = document.getElementById('app');
            const loader = document.getElementById('custom-loader');
            
            // Sprawd≈∫ czy to mobile/tablet
            if (window.isMobile || window.isSmallScreen) {
                // Sprawd≈∫ orientacjƒô
                const isPortrait = window.innerHeight > window.innerWidth;
                
                if (isPortrait) {
                    // UrzƒÖdzenie w pionie - poka≈º ostrze≈ºenie
                    if (orientationWarning) {
                        orientationWarning.style.display = 'flex';
                    }
                    if (app) {
                        app.style.display = 'none';
                    }
                    if (loader) {
                        loader.style.display = 'none';
                    }
                } else {
                    // UrzƒÖdzenie w poziomie - ukryj ostrze≈ºenie
                    if (orientationWarning) {
                        orientationWarning.style.display = 'none';
                    }
                    if (app) {
                        app.style.display = 'flex';
                    }
                    // Loader bƒôdzie zarzƒÖdzany przez g≈Ç√≥wnƒÖ logikƒô
                }
            } else {
                // Desktop - zawsze ukryj orientation warning
                if (orientationWarning) {
                    orientationWarning.style.display = 'none';
                }
                if (app) {
                    app.style.display = 'flex';
                }
            }
        }
        
        // Sprawd≈∫ orientacjƒô przy ≈Çadowaniu i przy obrocie
        document.addEventListener('DOMContentLoaded', checkOrientation);
        window.addEventListener('orientationchange', () => {
            setTimeout(checkOrientation, 100); // Ma≈Çe op√≥≈∫nienie na zmianƒô orientacji
        });
        window.addEventListener('resize', checkOrientation);
    </script>
    
    <!-- üé¨ THREE.JS IMPORTS - tylko Three.js bez ThreePipe -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.155.0/examples/jsm/"
      }
    }
    </script>
    
    <!-- üé® PODSTAWOWE STYLE -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            overflow: hidden;
        }
        
        /* üîÑ LOADER STYLES */
        #custom-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        /* üì± ORIENTATION WARNING */
        #orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2c3e50;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
            text-align: center;
        }
        
        #orientation-warning .rotate-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: phoneRotate 2s ease-in-out infinite;
        }
        
        #orientation-warning h2 {
            font-size: 24px;
            color: #ffffff;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        #orientation-warning p {
            font-size: 16px;
            color: #ecf0f1;
            line-height: 1.5;
            max-width: 300px;
        }
        
        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
            visibility: hidden;
            opacity: 0;
        }

        #app.visible {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        /* üñ•Ô∏è CANVAS */
        #canvas {
            flex: 1;
            width: calc(100vw - 350px);
            height: 100%;
            background: #f0f0f0;
            position: relative;
            display: block;
            outline: none;
            cursor: grab;
        }
        
        #canvas:active {
            cursor: grabbing;
        }
        
        #viewer-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* üéØ WELCOME SCREEN */
        #welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 350px;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.5s ease;
        }
        
        #welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        
        #welcome-screen h1 {
            font-size: 2em;
            color: #000;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 300;
        }
        
        #welcome-screen p {
            font-size: 1.2em;
            color: #666;
            text-align: center;
            margin-bottom: 40px;
            max-width: 400px;
            line-height: 1.6;
        }
        
        #welcome-logo {
            width: 200px;
            height: auto;
            margin-bottom: 30px;
            opacity: 0.9;
            border-radius: 10px;
            animation: logoPulse 3s ease-in-out infinite;
        }
        
        /* üì± SIDEBAR */
        #sidebar {
            width: 350px;
            background: #fff;
            color: #333;
            border-left: 1px solid #e0e0e0;
            box-shadow: 0 4px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        /* üîç SEARCH */
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            color: #333;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .search-input::placeholder {
            color: #999;
        }
        
        /* üè∑Ô∏è CATEGORIES */
        .categories {
            margin-bottom: 20px;
        }
        
        .category-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: space-between;
        }
        
        .category-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #fff;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 0;
            position: relative;
        }
        
        .category-btn:hover {
            border-color: #666;
            background: #f5f5f5;
            color: #333;
            transform: translateY(-1px);
        }
        
        .category-btn.active {
            border-color: #FFD700;
            background: #fff;
            color: #333;
        }
        
        .category-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 6px;
        }
        
        .category-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0); /* czarne ikony */
        }
        
        .category-btn:hover .category-icon img,
        .category-btn.active .category-icon img {
            filter: brightness(0); /* czarne ikony pozostajƒÖ czarne */
        }
        
        .category-label {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }
        
        /* ü™ë CHAIRS GRID */
        .chairs-section {
            margin-bottom: 20px;
        }
        
        .chairs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .chair-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
        }
        
        .chair-item:hover {
            border-color: #666;
            background: #f5f5f5;
            color: #333;
        }
        
        .chair-item.selected {
            border-color: #FFD700;
            background: #fff;
            color: #333;
        }
        
        .chair-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 5px;
            filter: brightness(0); /* czarne ikony */
        }
        
        .chair-item:hover img,
        .chair-item.selected img {
            filter: brightness(0); /* czarne ikony pozostajƒÖ czarne */
        }
        
        .chair-name {
            font-size: 11px;
            font-weight: 600;
        }
        
        /* üîß THUMBNAIL STYLES (for renderOptions) */
        .thumbnail-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .thumbnail {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 80px;
        }
        
        .thumbnail:hover {
            border-color: #666;
            background: #f5f5f5;
            transform: scale(1.05);
        }
        
        .thumbnail.selected {
            border-color: #FFD700;
            background: #fff;
        }
        
        .thumbnail img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            filter: brightness(0); /* czarne ikony */
        }
        
        .thumbnail:hover img,
        .thumbnail.selected img {
            filter: brightness(0); /* czarne ikony pozostajƒÖ czarne */
        }
        
        .thumbnail-caption {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            margin-top: 5px;
            color: #333;
        }
        
        .thumbnail:hover .thumbnail-caption,
        .thumbnail.selected .thumbnail-caption {
            color: #333;
        }
        
        /* üì± MOBILE RESPONSIVE - tylko landscape (poziomo) */
        @media (max-width: 820px) and (orientation: landscape) {
            #app {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: 40vh;
                order: 2;
                border-left: none;
                border-top: 1px solid #e0e0e0;
            }
            
            #canvas {
                order: 1;
                height: 60vh;
                width: 100%;
            }
            
            #welcome-screen {
                right: 0;
                z-index: 60;
            }
            
            #welcome-screen h1 {
                font-size: 1.4em;
                margin-bottom: 8px;
            }
            
            #welcome-screen p {
                font-size: 0.8em;
                margin-bottom: 15px;
                padding: 0 8px;
            }
            
            #welcome-logo {
                width: 100px;
                margin-bottom: 15px;
            }
            
            .category-grid {
                flex-direction: column;
                gap: 6px;
            }
            
            .category-btn {
                flex-direction: row;
                padding: 8px 12px;
                justify-content: flex-start;
            }
            
            .category-icon {
                width: 24px;
                height: 24px;
                margin-bottom: 0;
                margin-right: 8px;
            }
            
            .category-label {
                font-size: 10px;
                text-align: left;
            }
            
            .chairs-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .chair-item {
                padding: 8px;
            }
            
            .chair-item img {
                width: 40px;
                height: 40px;
            }
            
            .chair-name {
                font-size: 9px;
            }
            
            /* üì± MOBILE THUMBNAIL STYLES */
            .thumbnail {
                min-height: 60px;
                padding: 6px;
            }
            
            .thumbnail img {
                width: 40px;
                height: 40px;
            }
            
            .thumbnail-caption {
                font-size: 9px;
                margin-top: 3px;
            }
        }
        
        /* üì± MOBILE PORTRAIT - ukryj app, poka≈º orientation warning */
        @media (max-width: 820px) and (orientation: portrait) {
            #app {
                display: none !important;
            }
            
            #custom-loader {
                display: none !important;
            }
            
            #orientation-warning {
                display: flex !important;
            }
        }
    </style>
</head>
<body>
    <!-- ÔøΩ ORIENTATION WARNING - dla mobile w pionie -->
    <div id="orientation-warning">
        <div class="rotate-icon">üì≤</div>üì±ÔøΩ</div>
        <h2>Obr√≥ƒá urzƒÖdzenie</h2>
        <p>Konfigurator dzia≈Ça najlepiej w orientacji poziomej. Obr√≥ƒá swoje urzƒÖdzenie, aby kontynuowaƒá.</p>
    </div>

    <!-- ÔøΩüîÑ ANIMATED LOADER - na poczƒÖtku body, poza #app -->
    <div id="custom-loader">
        <!-- Logo Container -->
        <div class="logo-container" style="
            position: relative;
            margin-bottom: 40px;
            animation: logoPulse 3s ease-in-out infinite;
        ">
            <!-- Main Logo -->
            <img src="icons/FK_logo.png" alt="Fajne Krzes≈Ça" style="
                max-width: 200px; 
                height: auto;
                border-radius: 10px;
                opacity: 0.9;
            " />
        </div>
        
        <!-- Spinner -->
        <div class="spinner" style="
            width: 40px;
            height: 40px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        "></div>
        
        <!-- Progress Bar -->
        <div class="progress-container" style="
            width: 280px;
            height: 3px;
            background: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 25px;
        ">
            <div class="progress-bar" style="
                width: 100%;
                height: 100%;
                background: #FFD700;
                animation: progressSlide 2s ease-in-out infinite;
            "></div>
        </div>
        
        <!-- Loading Text -->
        <div class="loading-text" style="
            font-size: 16px; 
            color: #333;
            font-weight: 500;
            text-align: center;
            letter-spacing: 0.5px;
        ">≈Åadowanie interfejsu</div>
    </div>

    <div id="app">
        
        <style>
            /* üé¨ LOADER ANIMATIONS - minimalistyczne */
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @keyframes progressSlide {
                0% { transform: translateX(-100%); }
                50% { transform: translateX(0%); }
                100% { transform: translateX(100%); }
            }
            
            @keyframes logoPulse {
                0%, 100% { 
                    opacity: 0.8;
                    transform: scale(1);
                }
                50% { 
                    opacity: 1;
                    transform: scale(1.05);
                }
            }
            
            @keyframes phoneRotate {
                0% { 
                    transform: rotate(0deg);
                }
                25% { 
                    transform: rotate(90deg);
                }
                50% { 
                    transform: rotate(90deg);
                }
                75% { 
                    transform: rotate(180deg);
                }
                100% { 
                    transform: rotate(0deg);
                }
            }
        </style>
        </style>
        
        <!-- üñ•Ô∏è CANVAS -->
        <div id="canvas">
            <canvas id="viewer-canvas"></canvas>
        </div>
        
        <!-- üéØ WELCOME SCREEN -->
        <div id="welcome-screen">
            <img id="welcome-logo" src="icons/FK_logo.png" alt="Fajne Krzes≈Ça">
            <h1>Konfigurator Krzese≈Ç</h1>
            <p>Wybierz model krzes≈Ça z dostƒôpnych kategorii w bocznym panelu, aby rozpoczƒÖƒá konfiguracjƒô w 3D</p>
        </div>
        
        <!-- üì± SIDEBAR -->
        <div id="sidebar">
            <!-- üîç SEARCH -->
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Szukaj krzes≈Ça...">
            </div>
            
            <!-- üè∑Ô∏è CATEGORIES -->
            <div class="categories">
                <div class="category-grid">
                    <div class="category-btn" data-category="krzesla">
                        <div class="category-icon">
                            <img src="icons/chair_icon.png" alt="Krzes≈Ça" onerror="this.src='icons/placeholder.svg'">
                        </div>
                        <div class="category-label">Krzes≈Ça</div>
                    </div>
                    <div class="category-btn" data-category="hooker">
                        <div class="category-icon">
                            <img src="icons/legs_icon.png" alt="Hooker" onerror="this.src='icons/placeholder.svg'">
                        </div>
                        <div class="category-label">Hooker</div>
                    </div>
                    <div class="category-btn" data-category="biurowe">
                        <div class="category-icon">
                            <img src="icons/export_icon.png" alt="Biurowe" onerror="this.src='icons/placeholder.svg'">
                        </div>
                        <div class="category-label">Biurowe</div>
                    </div>
                    <div class="category-btn" data-category="ogrodowe">
                        <div class="category-icon">
                            <img src="icons/bulb_icon.png" alt="Ogrodowe" onerror="this.src='icons/placeholder.svg'">
                        </div>
                        <div class="category-label">Ogrodowe</div>
                    </div>
                </div>
            </div>
            
            <!-- ü™ë CHAIRS -->
            <div class="chairs-section">
                <div id="chairs-grid" class="chairs-grid">
                    <!-- Chairs will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // üé¨ THREE.JS IMPORTS - czyste Three.js
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        // Alias dla kompatybilno≈õci
        const {
            Group,
            Box3,
            Vector3,
            ArrowHelper,
            Sprite,
            SpriteMaterial,
            CanvasTexture,
            Color,
            TextureLoader,
            Scene,
            PerspectiveCamera,
            WebGLRenderer,
            DirectionalLight,
            AmbientLight
        } = THREE;

        // üåç GLOBALNE ZMIENNE - z Three.js zamiast ThreePipe
        let allData = [];
        let mainModels = [];
        let selectedChair = null;
        let currentCategory = 'krzesla';
        let scene, camera, renderer, controls, currentModelContainer;
        let selectedLeg, selectedMaterials = {};
        
        // üéØ CAMERA SETTINGS
        const CAMERA_FOV = 12;
        const CAMERA_POSITION = { x: -4.50, y: 0.28, z: 4.53 };
        const CAMERA_TARGET = { x: 1, y: -0.5, z: 2 };
        const MIN_ZOOM_DISTANCE = 1;
        const MAX_ZOOM_DISTANCE = 8;
        
        // üöÄ INICJALIZACJA 3D VIEWERA - czyste Three.js
        async function init3DViewer() {
            console.log('üöÄ Inicjalizacja 3D Viewer (Three.js)...');
            
            const canvas = document.getElementById("viewer-canvas");
            if (!canvas) {
                console.error('‚ùå Canvas nie znaleziony!');
                return false;
            }
            
            try {
                console.log('üöÄ Inicjalizacja Three.js Scene...');
                
                // Scena
                scene = new Scene();
                scene.background = new Color(0xf0f0f0);
                
                // Kamera
                camera = new PerspectiveCamera(
                    CAMERA_FOV, 
                    canvas.clientWidth / canvas.clientHeight, 
                    0.1, 
                    1000
                );
                camera.position.set(CAMERA_POSITION.x, CAMERA_POSITION.y, CAMERA_POSITION.z);
                
                // Renderer
                renderer = new WebGLRenderer({ 
                    canvas: canvas,
                    antialias: true,
                    alpha: true 
                });
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Kontrolki
                controls = new OrbitControls(camera, canvas);
                controls.target.set(CAMERA_TARGET.x, CAMERA_TARGET.y, CAMERA_TARGET.z);
                controls.minDistance = MIN_ZOOM_DISTANCE;
                controls.maxDistance = MAX_ZOOM_DISTANCE;
                controls.dampingFactor = 0.1;
                controls.enableDamping = true;
                controls.update();
                
                // O≈õwietlenie
                const ambientLight = new AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new DirectionalLight(0xffffff, 1);
                directionalLight.position.set(5, 5, 5);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                scene.add(directionalLight);
                
                // Animate loop
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
                
                // Resize handler
                window.addEventListener('resize', () => {
                    camera.aspect = canvas.clientWidth / canvas.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                });
                
                console.log('‚úÖ Three.js Scene zainicjalizowany');
                return true;
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd inicjalizacji Three.js:', error);
                
                const loader = document.getElementById('custom-loader');
                if (loader) {
                    loader.innerHTML = `
                        <img src="icons/FK_logo.png" alt="Fajne Krzes≈Ça" style="
                            max-width: 200px; 
                            margin-bottom: 20px;
                            border-radius: 10px;
                        " />
                        <p style="
                            color: #333; 
                            text-align: center;
                            font-size: 16px;
                            padding: 20px;
                            max-width: 300px;
                            line-height: 1.5;
                        ">
                            ‚ùå B≈ÇƒÖd inicjalizacji 3D: ${error.message}<br><br>üîÑ Spr√≥buj od≈õwie≈ºyƒá stronƒô
                        </p>
                    `;
                }
                return false;
            }
        }
        
        // üéØ FUNKCJA POKAZUJƒÑCA UI PO PIERWSZYM WYBORZE KRZES≈ÅA - z backup'a
        function showAfterFirstSelection() {
            console.log('üéØ Pokazujƒô interfejs po wyborze krzes≈Ça...');
            
            // Ukryj welcome screen
            const welcomeScreen = document.getElementById('welcome-screen');
            if (welcomeScreen && !welcomeScreen.classList.contains('hidden')) {
                welcomeScreen.classList.add('hidden');
                console.log('‚úÖ Welcome screen ukryty');
            }
            
            console.log('‚úÖ Canvas 3D ju≈º widoczny');
            console.log('‚úÖ Sidebar ju≈º widoczny');
        }
        
        // ü™ë ≈ÅADOWANIE MODELU 3D - Three.js GLTF Loader
        async function loadChairModel(chairData) {
            if (!scene || !renderer) {
                console.error('‚ùå Scene nie zainicjalizowany!');
                return;
            }
            
            console.log('ü™ë ≈Åadowanie modelu:', chairData.Nazwa);
            
            // Poka≈º UI po pierwszym wyborze krzes≈Ça
            showAfterFirstSelection();
            
            try {
                // Usu≈Ñ poprzedni model
                if (currentModelContainer) {
                    scene.remove(currentModelContainer);
                    // Dispose geometrii i materia≈Ç√≥w
                    currentModelContainer.traverse((child) => {
                        if (child.geometry) child.geometry.dispose();
                        if (child.material) {
                            if (Array.isArray(child.material)) {
                                child.material.forEach(mat => mat.dispose());
                            } else {
                                child.material.dispose();
                            }
                        }
                    });
                    currentModelContainer = null;
                }
                
                // ≈öcie≈ºka do modelu
                const modelPath = `chairs/${chairData.Nazwa}.glb`;
                console.log('üì¶ ≈Åadowanie modelu z:', modelPath);
                
                // Utw√≥rz loader
                const loader = new GLTFLoader();
                
                // Za≈Çaduj model z Promise
                const gltf = await new Promise((resolve, reject) => {
                    loader.load(
                        modelPath,
                        (gltf) => resolve(gltf),
                        (progress) => console.log('üì¶ Progress:', (progress.loaded / progress.total * 100) + '%'),
                        (error) => reject(error)
                    );
                });
                
                currentModelContainer = gltf.scene;
                scene.add(currentModelContainer);
                
                console.log('‚úÖ Model za≈Çadowany:', chairData.Nazwa);
                
                // Wy≈õrodkuj model
                if (currentModelContainer) {
                    const box = new Box3().setFromObject(currentModelContainer);
                    const center = box.getCenter(new Vector3());
                    currentModelContainer.position.sub(center);
                    
                    // W≈ÇƒÖcz cienie dla modelu
                    currentModelContainer.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    // Dostosuj kamerƒô do modelu
                    if (controls) {
                        controls.target.set(CAMERA_TARGET.x, CAMERA_TARGET.y, CAMERA_TARGET.z);
                        controls.update();
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd ≈Çadowania modelu:', error);
                return false;
            }
        }
        
        // üîß RENDER OPTIONS (do wy≈õwietlania miniatur)
        function renderOptions(containerId, items, onSelect, isInteractive = true) {
            console.log(`üîÑ renderOptions dla ${containerId} z ${items.length} elementami`);
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`‚ùå Kontener ${containerId} nie istnieje!`);
                return;
            }
            
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'thumbnail-wrapper';
                
                const button = document.createElement('div');
                button.className = 'thumbnail';
                button.title = item.Nazwa;

                if (isInteractive) {
                    button.addEventListener('click', () => {
                        onSelect(item);
                        container.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
                        button.classList.add('selected');
                    });
                }
                
                const img = document.createElement('img');
                let imageSrc = item.Obrazek || item.Image || 'icons/chair_icon.png';
                
                // Normalizuj ≈õcie≈ºki
                if (imageSrc.startsWith('./')) {
                    imageSrc = imageSrc.substring(2);
                }
                if (!imageSrc.startsWith('http') && !imageSrc.startsWith('/')) {
                    imageSrc = './' + imageSrc;
                }
                
                img.src = imageSrc;
                img.alt = item.Nazwa || 'Bez nazwy';
                img.onerror = () => { img.src = './icons/chair_icon.png'; };
                
                button.appendChild(img);
                
                const caption = document.createElement('div');
                caption.className = 'thumbnail-caption';
                caption.textContent = item.Nazwa;
                
                wrapper.appendChild(button);
                wrapper.appendChild(caption);
                container.appendChild(wrapper);
            });
        }
        
        // üåç GLOBALNE ZMIENNE - USUNIƒòTA DUPLIKACJA
        // let allData = []; - ju≈º zadeklarowana wy≈ºej
        // let mainModels = []; - ju≈º zadeklarowana wy≈ºej  
        // let selectedChair = null; - ju≈º zadeklarowana wy≈ºej
        // let currentCategory = 'krzesla'; - ju≈º zadeklarowana wy≈ºej
        
        // üìä ≈ÅADOWANIE DANYCH Z GOOGLE SHEETS - poprawiony z backup'a
        async function loadDataFromSheet() {
            console.log('üìä Loading data from Google Sheets...');
            
            const sheetId = '1vCs6YeHgKqlYwg8rvJOqVzNRnXeATJCBuK-zh3NNj78';
            const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Dane&v=${new Date().getTime()}`;
            
            try {
                console.log('üîÑ ≈Åadowanie danych z arkusza...');
                console.log('üì° URL:', sheetURL);
                
                let attemptCount = 0;
                const maxAttempts = 3;
                let lastError;
                
                while (attemptCount < maxAttempts) {
                    attemptCount++;
                    console.log(`üîÑ Pr√≥ba ${attemptCount}/${maxAttempts}...`);
                    
                    try {
                        const fetchPromise = fetch(sheetURL + '?nocache=' + Date.now(), { 
                            cache: 'no-store',
                            mode: 'cors',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache',
                                'Accept': 'text/csv,*/*'
                            }
                        });
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Fetch timeout - sprawd≈∫ po≈ÇƒÖczenie')), 15000 + (attemptCount * 5000))
                        );
                        
                        const response = await Promise.race([fetchPromise, timeoutPromise]);
                        console.log('üì° Response status:', response.status, response.statusText);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const csvText = await response.text();
                        console.log('üìÑ CSV length:', csvText.length);
                        
                        if (csvText.length < 100) {
                            throw new Error('CSV data too short - mo≈ºliwe problemy z po≈ÇƒÖczeniem');
                        }
                        
                        // Sukces - dane za≈Çadowane
                        const rows = csvText.trim().split('\n');
                        const headers = rows.shift().split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        allData = rows.map(row => {
                            const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                            const obj = {};
                            headers.forEach((header, index) => obj[header] = values[index]?.trim().replace(/"/g, '') || '');
                            return obj;
                        }).filter(item => item.Visible?.toLowerCase() !== 'false');

                        console.log('‚úÖ Dane za≈Çadowane:', allData.length, 'element√≥w');
                        console.log('üìä Przyk≈Çadowe dane:', allData.slice(0, 2));
                        console.log('üìä Wszystkie kolumny w pierwszym elemencie:', Object.keys(allData[0] || {}));
                        break; // Wyjd≈∫ z pƒôtli - sukces!
                        
                    } catch (attemptError) {
                        lastError = attemptError;
                        console.error(`‚ùå Pr√≥ba ${attemptCount} nieudana:`, attemptError.message);
                        
                        if (attemptCount >= maxAttempts) {
                            throw lastError; // Rzuƒá ostatni b≈ÇƒÖd
                        }
                        
                        // Czekaj przed kolejnƒÖ pr√≥bƒÖ
                        const waitTime = attemptCount * 2000; // 2s, 4s, 6s
                        console.log(`‚è±Ô∏è Czekam ${waitTime/1000}s przed kolejnƒÖ pr√≥bƒÖ...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                }

                // Filter main models (chairs) - z backup'a
                const mainModelsFromData = allData.filter(d => {
                    const grupa = (d.Grupa || d.Group || d.grupa || '').toLowerCase();
                    const typ = (d.Typ || d.Type || d.typ || '').toLowerCase();
                    const kategoria = (d.Kategoria || d.Category || d.kategoria || '').toLowerCase();
                    
                    return ['krzes≈Ço', 'kube≈Çek', 'chair', 'bucket'].some(term => 
                        grupa.includes(term) || typ.includes(term) || kategoria.includes(term)
                    );
                });
                
                // üîß ZAPISZ GLOBALNIE
                mainModels = mainModelsFromData;
                window.mainModels = mainModels;
                
                console.log('ü™ë Modele g≈Ç√≥wne:', mainModels.length);
                console.log('ü™ë Przyk≈Çadowe modele:', mainModels.slice(0, 3));
                
                // Je≈õli nie ma g≈Ç√≥wnych modeli, poka≈º wszystkie dane dla debugowania
                if (mainModels.length === 0) {
                    console.warn('‚ö†Ô∏è Nie znaleziono g≈Ç√≥wnych modeli, u≈ºywam wszystkich danych');
                    mainModels = allData.slice(0, 10); // pierwsze 10 dla testu
                }
                
                // Initialize UI
                initializeApp();
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                // Fallback data for testing
                mainModels = [
                    { Nazwa: 'Amy-2', Kategoria: 'krzesla', Obrazek: 'icons/chair_icon.png' },
                    { Nazwa: 'Ava', Kategoria: 'hooker', Obrazek: 'icons/chair_icon.png' },
                    { Nazwa: 'Carine', Kategoria: 'biurowe', Obrazek: 'icons/chair_icon.png' }
                ];
                initializeApp();
            }
        }
        
        // ÔøΩÔ∏è CREATE CATEGORIES - funkcja z backup'a
        function createCategories() {
            console.log('üè∑Ô∏è Tworzenie kategorii...');
            
            // Funkcja ju≈º istnieje w HTML jako statyczne przyciski
            // Tutaj tylko uruchamiamy setupCategoryButtons
            setupCategoryButtons();
            setupSearch();
            setDefaultCategory();
            
            console.log('‚úÖ Kategorie skonfigurowane');
        }
        
        // ÔøΩüéØ INICJALIZACJA APLIKACJI
        function initializeApp() {
            console.log('üéØ Initializing app...');
            
            setupCategoryButtons();
            setupSearch();
            setDefaultCategory();
            renderChairs();
        }
        
        // üè∑Ô∏è SETUP CATEGORY BUTTONS
        function setupCategoryButtons() {
            console.log('üè∑Ô∏è Setting up category buttons...');
            
            const categoryBtns = document.querySelectorAll('.category-btn');
            
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const category = btn.getAttribute('data-category');
                    console.log('üè∑Ô∏è Category clicked:', category);
                    
                    // Update active state
                    categoryBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Update current category
                    currentCategory = category;
                    
                    // Filter chairs
                    filterChairsByCategory(category);
                });
            });
        }
        
        // üîç SETUP SEARCH
        function setupSearch() {
            console.log('üîç Setting up search...');
            
            const searchInput = document.getElementById('search-input');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    console.log('üîç Search term:', searchTerm);
                    
                    // Clear category selection when searching
                    if (searchTerm) {
                        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                        currentCategory = null;
                    }
                    
                    // Filter chairs
                    filterChairsBySearch(searchTerm);
                });
            }
        }
        
        // üéØ SET DEFAULT CATEGORY
        function setDefaultCategory() {
            console.log('üéØ Setting default category...');
            
            const defaultBtn = document.querySelector('.category-btn[data-category="krzesla"]');
            if (defaultBtn) {
                defaultBtn.classList.add('active');
                currentCategory = 'krzesla';
            }
        }
        
        // üè∑Ô∏è FILTER CHAIRS BY CATEGORY
        function filterChairsByCategory(category) {
            console.log('üè∑Ô∏è Filtering by category:', category);
            
            const filteredChairs = mainModels.filter(chair => {
                const chairCategory = (chair.Kategoria || '').toLowerCase().trim();
                return chairCategory === category.toLowerCase();
            });
            
            console.log('üè∑Ô∏è Found chairs:', filteredChairs.length);
            renderChairs(filteredChairs);
        }
        
        // üîç FILTER CHAIRS BY SEARCH
        function filterChairsBySearch(searchTerm) {
            console.log('üîç Filtering by search:', searchTerm);
            
            if (!searchTerm) {
                // If search is empty, show category or all
                if (currentCategory) {
                    filterChairsByCategory(currentCategory);
                } else {
                    renderChairs(mainModels);
                }
                return;
            }
            
            const filteredChairs = mainModels.filter(chair => {
                const chairName = (chair.Nazwa || '').toLowerCase();
                return chairName.includes(searchTerm);
            });
            
            console.log('üîç Found chairs:', filteredChairs.length);
            renderChairs(filteredChairs);
        }
        
        // ü™ë RENDER CHAIRS
        function renderChairs(chairs = mainModels) {
            console.log('ü™ë Rendering chairs:', chairs.length);
            
            // U≈ºyj renderOptions dla sp√≥jno≈õci
            renderOptions('chairs-grid', chairs, (chair) => {
                console.log('üéØ Chair selected via renderOptions:', chair.Nazwa);
                
                // Update selection
                selectedChair = chair;
                
                // ü™ë Za≈Çaduj model 3D
                loadChairModel(chair);
                
                console.log('‚úÖ Selected chair:', selectedChair);
            });
        }
        
        // üéØ SELECT CHAIR
        function selectChair(chair, chairElement) {
            console.log('üéØ Chair selected:', chair.Nazwa);
            
            // Update selection
            document.querySelectorAll('.chair-item').forEach(item => item.classList.remove('selected'));
            chairElement.classList.add('selected');
            
            selectedChair = chair;
            
            // ü™ë Za≈Çaduj model 3D
            loadChairModel(chair);
            
            console.log('‚úÖ Selected chair:', selectedChair);
        }
        
        // üöÄ START THE APP - usuniƒôty zduplikowany kod
        // Kod przeniesiony do initialize3DApp powy≈ºej
        
        // üì± DEBUG FUNCTIONS
        window.debugApp = function() {
            console.log('=== üîç DEBUG APP STATE ===');
            console.log('Data loaded:', allData.length, 'items');
            console.log('Main models:', mainModels.length, 'chairs');
            console.log('Selected chair:', selectedChair);
            console.log('Current category:', currentCategory);
        };
        
        // üîÑ FUNKCJE LOADERA - do u≈ºycia w przysz≈Ço≈õci
        window.showLoader = function(text = '≈Åadowanie...') {
            const loader = document.getElementById('custom-loader');
            if (loader) {
                // Aktualizuj tekst je≈õli podano
                const loadingText = loader.querySelector('.loading-text');
                if (loadingText && text !== '≈Åadowanie...') {
                    loadingText.textContent = text;
                }
                
                loader.style.display = 'flex';
                console.log('üîÑ Loader pokazany:', text);
            }
        };
        
        window.hideLoader = function() {
            const loader = document.getElementById('custom-loader');
            if (loader) {
                loader.style.display = 'none';
                console.log('‚úÖ Loader ukryty');
            }
        };
        
        // Przyk≈Çad u≈ºycia dla przysz≈Çych funkcji:
        // window.showLoader('Przygotowywanie pokoju 3D...');
        // await loadRoomViewer();
        // window.hideLoader();
        
        // üéØ G≈Å√ìWNA FUNKCJA STARTOWA - uproszczona
        async function initialize3DApp() {
            console.log('üöÄ Inicjalizacja aplikacji 3D...');
            
            try {
                // ‚è±Ô∏è KROK 1: Inicjalizacja 3D
                console.log('‚è±Ô∏è Krok 1: Inicjalizacja 3D Viewer...');
                window.showLoader('üöÄ Inicjalizacja 3D...');
                
                const initSuccess = await init3DViewer();
                if (!initSuccess) {
                    throw new Error('Inicjalizacja 3D nie powiod≈Ça siƒô');
                }
                
                // ‚è±Ô∏è KROK 2: ≈Åadowanie danych
                console.log('‚è±Ô∏è Krok 2: ≈Åadowanie danych...');
                window.showLoader('üìã ≈Åadowanie danych krzese≈Ç...');
                await loadDataFromSheet();
                
                // ‚è±Ô∏è KROK 3: Finalizacja UI
                console.log('‚è±Ô∏è Krok 3: Przygotowanie interfejsu...');
                window.showLoader('üé® Przygotowanie interfejsu...');
                createCategories();
                
                // Kr√≥tkie op√≥≈∫nienie przed ukryciem loadera
                setTimeout(() => {
                    window.hideLoader();
                    
                    // Poka≈º g≈Ç√≥wnƒÖ aplikacjƒô
                    const app = document.getElementById('app');
                    if (app) {
                        app.style.visibility = 'visible';
                        app.style.opacity = '1';
                        app.classList.add('visible');
                    }
                    
                    console.log('‚úÖ Aplikacja 3D gotowa!');
                }, 800);
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd inicjalizacji:', error);
                
                // Poka≈º komunikat b≈Çƒôdu
                const loader = document.getElementById('custom-loader');
                if (loader) {
                    loader.innerHTML = `
                        <img src="icons/FK_logo.png" alt="Fajne Krzes≈Ça" style="
                            max-width: 200px; 
                            margin-bottom: 20px;
                        " />
                        <div style="
                            color: #333; 
                            text-align: center;
                            font-size: 16px;
                            padding: 20px;
                            max-width: 350px;
                            line-height: 1.6;
                        ">
                            ‚ùå <strong>B≈ÇƒÖd ≈Çadowania aplikacji</strong><br><br>
                            ${error.message}<br><br>
                            üîÑ Spr√≥buj od≈õwie≈ºyƒá stronƒô
                        </div>
                    `;
                }
            }
        }
        
        // üöÄ START APLIKACJI - uproszczony
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM za≈Çadowany - uruchamiam aplikacjƒô...');
            
            // Kr√≥tkie op√≥≈∫nienie, potem start
            setTimeout(() => {
                initialize3DApp();
            }, 100);
        });
    </script>
</body>
</html>
